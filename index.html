<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Digital Student Dashboard</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" sizes="32x32">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Load config.js FIRST -->
    <script src="./config.js"></script>
    
    <link rel="stylesheet" href="indexstyle.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4C1D95">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
    
    <!-- Windows PWA Support -->
    <meta name="msapplication-TileColor" content="#4C1D95">
    <meta name="msapplication-TileImage" content="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
    
    <!-- Mobile PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator" style="display: none;">
        <i class="fas fa-wifi-slash"></i> You are offline. Some features may be unavailable.
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="menu-toggle" id="menuToggle">‚ò∞</button>
        <div class="header-title-container">
            <span>NCHSM Digital Student Portal</span>
            <img 
                id="header-passport-preview" 
                src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" 
                alt="Profile Photo" 
                class="header-profile-photo"
            />
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" alt="NCHSM Logo">
                <h2>STUDENT PORTAL</h2>
            </div>
            <ul class="nav">
                <li><a href="#" data-tab="dashboard" class="active">üè† Dashboard</a></li>
                <li><a href="#" data-tab="profile">üë§ Profile</a></li>
                <li><a href="#" data-tab="calendar">üìÖ Academic Calendar</a></li> 
                <li><a href="#" data-tab="courses">üìö My Courses</a></li>
                <li><a href="#" data-tab="attendance">‚úÖ Attendance</a></li>
                <li><a href="#" data-tab="cats">üìù CATS/Exams</a></li>
                <li><a href="#" data-tab="resources">üìÅ Resources</a></li>
                <li><a href="#" data-tab="messages">üí¨ Messages</a></li>
                <li><a href="#" data-tab="nurseiq" class="nurseiq-nav">
                    <div class="nav-icon-wrapper">
                        <i class="fas fa-brain"></i>
                        <span class="nav-pulse"></span>
                    </div>
                    <span class="nav-text">NurseIQ</span>
                    <span class="nav-subtitle">Assessment Center</span>
                    <span class="nav-badge" id="nurseiqBadge">0</span>
                </a></li>
                <li><a href="#" data-tab="coming-soon-quizlets">üìù Coming Soon: Quizlets</a></li>
            </ul>
            <div class="logout"><a href="#" id="logoutBtn">Logout</a></div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard Tab -->
            <section id="dashboard" class="tab-content active">
                <div id="welcome-section" class="welcome-card">
                    <h2 id="welcome-header">Welcome back, Student!</h2>
                    <p id="student-welcome-message">Access your courses, schedule, and check your attendance status.</p>
                </div>

                <div id="announcement-banner">
                    <span class="info-icon">üì£</span>
                    <div>
                        <strong>Official Announcement:</strong>
                        <p id="student-announcement">Loading latest announcement...</p>
                    </div>
                </div>

                <h2 style="margin-top: 20px; color: var(--color-primary); font-weight: 700;">Quick Snapshot</h2>
                <div class="cards">
                    <div class="card alert-card" data-tab="attendance">
                        <h3>Attendance Rate</h3>
                        <p class="data" id="dashboard-attendance-rate">--%</p>
                        <small>Verified Check-ins: <strong id="dashboard-verified-count">0</strong> / <strong id="dashboard-total-count">0</strong></small>
                        <small style="display:block; margin-top: 5px; color:var(--color-alert);">Pending Review: <strong id="dashboard-pending-count">0</strong></small>
                    </div>

                    <div class="card" data-tab="cats">
                        <h3>Upcoming Exam</h3>
                        <p style="font-size: 1.2rem; font-weight: 700; color: #F97316;" id="dashboard-upcoming-exam">Loading...</p>
                        <small>Next CAT/Exam date</small>
                    </div>

                    <div class="card" data-tab="courses">
                        <h3>Active Courses</h3>
                        <p class="data" id="dashboard-active-courses">0</p>
                        <small>Currently enrolled</small>
                    </div>

                    <div class="card" data-tab="resources">
                        <h3>New Resources</h3>
                        <p class="data" id="dashboard-new-resources">0</p>
                        <small>Last 7 days</small>
                    </div>

                    <!-- NurseIQ Card on Dashboard -->
                    <div class="card nurseiq-card" data-tab="nurseiq" style="border-left: 4px solid #8B5CF6;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="fas fa-brain" style="color: #8B5CF6; font-size: 1.2rem;"></i>
                            <h3 style="margin: 0;">NurseIQ Progress</h3>
                        </div>
                        <p class="data" id="dashboard-nurseiq-progress">--%</p>
                        <small>Accuracy: <strong id="dashboard-nurseiq-accuracy">--%</strong></small>
                        <small style="display:block; margin-top: 5px; color: var(--color-primary);">Questions: <strong id="dashboard-nurseiq-questions">0</strong> completed</small>
                    </div>
                </div>

                <h2 id="actions-title" style="margin-top: 30px; color: var(--color-primary); font-weight: 700;">Action Required</h2>
                <div id="dashboard-actions">
                    <div id="action-passport" class="card" style="border-left-color: var(--color-alert); cursor: default; display: none;">
                        <h3>Missing Passport Photo</h3>
                        <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                        <button class="profile-button" data-tab="profile">Go to Profile</button>
                    </div>
                    
                    <div class="card" style="border-left-color: var(--color-warning); cursor: default;">
                        <h3>Review New Course Material</h3>
                        <p>New study materials have been posted for this block.</p>
                        <button class="profile-button" data-tab="resources" style="background-color: var(--color-warning);">View Resources</button>
                    </div>
                    
                    <div id="latest-announcement-card" class="card" style="border-left-color: var(--color-success); display: none; cursor: pointer;">
                        <h4><span id="announcement-title" style="color: var(--color-primary);">Loading...</span></h4>
                        <p id="announcement-body" style="margin-bottom: 10px;">Loading message body...</p>
                        <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.9;">
                            <span id="announcement-date"></span> | 
                            <span id="announcement-status" style="font-weight: bold;"></span>
                        </div>
                        <button data-tab="messages" class="profile-button" style="background-color: var(--color-primary); margin-top: 15px;">Go to Messages Tab</button>
                    </div>

                    <!-- NurseIQ Action Card -->
                    <div id="nurseiq-action-card" class="card" style="border-left-color: #8B5CF6; cursor: pointer; display: none;">
                        <h3><i class="fas fa-brain" style="margin-right: 8px;"></i> NurseIQ Practice Needed</h3>
                        <p id="nurseiq-action-message">Complete your NurseIQ assessments to improve your scores.</p>
                        <button data-tab="nurseiq" class="profile-button" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); margin-top: 10px;">
                            <i class="fas fa-play-circle"></i> Start Practicing
                        </button>
                    </div>
                </div>
            </section>

            <!-- Profile Tab -->
            <section id="profile" class="tab-content">
                <h2 style="color: var(--color-primary);">My Profile & Account</h2>
                <form id="profile-form">
                    <div class="profile-media">
                        <img id="passport-preview" src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" alt="Passport Photo">
                        <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                        <label for="passport-file-input" class="file-upload-label" id="upload-label" style="display: none; cursor: pointer; padding: 10px; background-color: #5B21B6; color: white; border-radius: 6px; margin-top: 15px; display: block; text-align: center;">Change Photo</label>
                        <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                    </div>

                    <div class="profile-details">
                        <div class="form-field full-width">
                            <label for="profile-name">Full Name</label>
                            <input type="text" id="profile-name" readonly required>
                        </div>
                        <div class="form-field">
                            <label for="profile-student-id">Student ID / Reg. No.</label>
                            <input type="text" id="profile-student-id" readonly> 
                        </div>
                        <div class="form-field">
                            <label for="profile-email">Email (Login ID)</label>
                            <input type="email" id="profile-email" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-program">Program</label>
                            <input type="text" id="profile-program" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-block">Block</label>
                            <input type="text" id="profile-block" readonly>
                        </div>
                        <div class="form-field">
                            <label for="profile-intake-year">Intake Year</label>
                            <input type="text" id="profile-intake-year" readonly>
                        </div>
                        <div class="form-field full-width">
                            <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>
                            <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>
                        </div>
                        <p id="profile-status" class="full-width"></p>
                    </div>
                </form>
            </section>

            <!-- Calendar Tab -->
            <section id="calendar" class="tab-content">
                <h2 style="color: var(--color-primary);">Academic Calendar</h2>
                <p class="subtitle">A unified view of your scheduled sessions, clinical rotations, and exams.</p>

                <div class="calendar-controls" style="margin-bottom: 20px;">
                    <label for="calendar-filter">Filter by Type:</label>
                    <select id="calendar-filter">
                        <option value="all">Show All</option>
                        <option value="Clinical">Clinical Rotations</option>
                        <option value="Class">Scheduled Sessions</option>
                        <option value="Exam">Exams/CATS</option>
                    </select>
                </div>

                <div style="overflow-x: auto;"> 
                    <table>
                        <thead>
                            <tr>
                                <th class="date-col">Date & Time</th>
                                <th>Event / Details</th>
                                <th class="session-type-col">Type</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-table">
                            <tr><td colspan="3">Loading academic schedule...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Courses Tab -->
            <section id="courses" class="tab-content">
                <h2 style="color: var(--color-primary);">My Courses</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Course Name</th>
                                <th>Unit Code</th>
                                <th>Description</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="courses-table">
                            <tr><td colspan="4">Loading courses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Attendance Tab -->
            <section id="attendance" class="tab-content">
                <h2 style="color: var(--color-primary);">Daily Attendance Check-in</h2>

                <div class="check-in-controls">
                    <div class="control-group">
                        <label for="session-type">Session Type:</label>
                        <select id="session-type">
                            <option value="Clinical">Clinical Session</option>
                            <option value="Class">On Class Session</option>
                        </select>
                    </div>

                    <div class="control-group" id="target-control-group">
                        <label for="attendance-target" id="target-label">Department/Course:</label>
                        <select id="attendance-target">
                            <option value="">Select Session Type first...</option>
                        </select>
                    </div>

                    <button id="check-in-button">Check In Now</button>

                    <p id="geo-message">Select a <strong>Session Type</strong> and then a specific <strong>Department or Course</strong> to check in at your current GPS location and time.</p>
                </div>

                <h3 style="color: var(--color-primary);">Past Attendance History (Check-in Logs)</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Session Type</th>
                                <th>Target</th>
                                <th>Verified</th>
                            </tr>
                        </thead>
                        <tbody id="geo-attendance-history">
                            <tr><td colspan="4">Loading geo check-in history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Exams Tab -->
            <section id="cats" class="tab-content">
                <h2 style="color: var(--color-primary); font-size: 1.6rem; margin-bottom: 5px;">CATS / Exams & Grades</h2>
                <p style="color: #6B7280; margin-bottom: 20px;">Provisional results</p>

                <div class="exam-controls" style="margin-bottom: 20px; display:flex; align-items:center; gap:10px;">
                    <label for="exam-type-filter" style="font-weight:600; color:#374151;">Filter by Type:</label>
                    <select id="exam-type-filter" style="padding:6px 10px; border:1px solid #D1D5DB; border-radius:6px; background:white; color:#111827;">
                        <option value="all">Show All (CATS & Exams)</option>
                        <option value="CAT">Show Only CATS</option>
                        <option value="Final">Show Only Final Exams</option>
                    </select>
                </div>

                <div style="overflow-x: auto; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border-radius:8px;">
                    <table id="exams-grades-table" style="width:100%; border-collapse:collapse; min-width:700px;">
                        <thead style="background-color:#F3F4F6; color:#111827; font-weight:600;">
                            <tr>
                                <th style="padding:10px 12px;">Exam Name</th>
                                <th style="padding:10px 12px;">Block</th>
                                <th style="padding:10px 12px;">Date</th>
                                <th style="padding:10px 12px;">Status</th>
                                <th style="padding:10px 12px;">CAT 1</th>
                                <th style="padding:10px 12px;">CAT 2</th>
                                <th style="padding:10px 12px;">Final Exam</th>
                                <th style="padding:10px 12px;">Total (%)</th>
                                <th style="padding:10px 12px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="exams-table" style="background:white;">
                            <tr>
                                <td colspan="9" style="padding:12px; text-align:center; color:#6B7280;">Loading your exams and grades...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Enhanced Resources Tab - VIEW ONLY -->
            <section id="resources" class="tab-content">
                <div class="resources-header">
                    <h2 style="color: var(--color-primary); margin-bottom: 8px;">Learning Resources</h2>
                    <p class="subtitle" style="margin-bottom: 20px;">View your course materials and study resources</p>
                    
                    <!-- Mobile-Optimized Controls -->
                    <div class="resources-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="resource-search" placeholder="Search resources...">
                        </div>
                        
                        <div class="filter-group">
                            <select id="resource-filter">
                                <option value="all">All Resources</option>
                                <option value="pdf">PDF Notes</option>
                                <option value="video">Video Lectures</option>
                                <option value="slides">Presentation Slides</option>
                            </select>
                            
                            <select id="course-filter">
                                <option value="all">All Courses</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile-First Resources Grid -->
                <div class="resources-grid" id="resources-grid">
                    <!-- Resources will be loaded here dynamically -->
                    <div class="loading-state">Loading resources...</div>
                </div>

                <!-- Mobile Reader View -->
                <div id="mobile-reader" class="mobile-reader" style="display: none;">
                    <div class="reader-header">
                        <button class="reader-back" id="readerBackBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h3 id="reader-title">Resource Title</h3>
                        <div class="view-only-badge">
                            <i class="fas fa-eye"></i> View Only
                        </div>
                    </div>
                    <div class="reader-content" id="reader-content">
                        <!-- Resource content will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Messages Tab -->
            <section id="messages" class="tab-content">
                <h2 style="color: var(--color-primary);">Message Admin / Instructor</h2>
                <form id="message-form">
                    <textarea id="student-message-body" placeholder="Write your message to the administration..." required></textarea>
                    <button type="submit">Send Message</button>
                    <p id="message-status"></p>
                </form>

                <div id="messages-list"></div>
            </section>
            
            <!-- NurseIQ Tab -->
            <section id="nurseiq" class="tab-content">
                <h1>NurseIQ Question Bank</h1>
                <p class="subtitle">KRCHN Curriculum practice questions for Kenya Registered Community Health Nursing program</p>
                
                <!-- Only Question Bank Mode -->
                <div id="questionBankModeContent">
                    <!-- Student Question Bank -->
                    <div class="question-bank-section" style="background: white; border-radius: 12px; padding: 25px; margin: 25px 0; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h2 style="margin: 0; color: #4f46e5; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-database"></i>
                                    Question Bank
                                </h2>
                                <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">
                                    Browse KRCHN questions organized by courses - Click any course to start a test
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="background: #4f46e5; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                                    <i class="fas fa-play-circle"></i> Interactive Tests
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search Box -->
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1; position: relative;">
                                    <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
                                    <input type="text" id="studentQuestionBankSearch" placeholder="Search courses..." 
                                           style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </div>
                                <button id="nurseiqSearchBtn" style="background: #4f46e5; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-search"></i> Search
                                </button>
                                <button id="clearSearchBtn" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-redo"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="studentQuestionBankLoading" style="display: none; text-align: center; padding: 40px;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 15px; color: #6b7280;">Loading courses...</p>
                        </div>
                        
                        <!-- Main Content Area -->
                        <div id="studentQuestionBankContent">
                            <!-- Initial welcome message -->
                            <div style="text-align: center; padding: 40px 20px;">
                                <div style="display: inline-block; width: 80px; height: 80px; background: linear-gradient(135deg, #4f46e5, #7c3aed); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                                    <i class="fas fa-book-medical" style="font-size: 32px; color: white;"></i>
                                </div>
                                <h3 style="color: #4f46e5; margin-bottom: 10px;">NurseIQ Question Bank</h3>
                                <p style="color: #6b7280; max-width: 500px; margin: 0 auto 30px;">
                                    Access practice questions organized by KRCHN courses. Click any course card to start a practice test.
                                </p>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 24px; font-weight: bold; color: #4f46e5;">62</div>
                                        <div style="font-size: 13px; color: #6b7280;">Total Questions</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">2</div>
                                        <div style="font-size: 13px; color: #6b7280;">Total Courses</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">62</div>
                                        <div style="font-size: 13px; color: #6b7280;">Active Questions</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">100%</div>
                                        <div style="font-size: 13px; color: #6b7280;">Active Rate</div>
                                    </div>
                                </div>
                                
                                <button id="loadCourseCatalogBtn" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; display: inline-flex; align-items: center; gap: 10px; transition: transform 0.2s;">
                                    <i class="fas fa-play-circle"></i>
                                    Load Course Catalog
                                </button>
                                
                                <p style="margin-top: 20px; color: #6b7280; font-size: 13px;">
                                    <i class="fas fa-info-circle"></i> Courses will load with detailed statistics
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Coming Soon Quizlets Tab -->
            <section id="coming-soon-quizlets" class="tab-content">
                <div style="text-align: center; padding: 60px 20px;">
                    <i class="fas fa-tools" style="font-size: 4rem; color: #9CA3AF; margin-bottom: 20px;"></i>
                    <h2 style="color: #4C1D95;">Coming Soon: Quizlets</h2>
                    <p style="color: #6B7280; max-width: 500px; margin: 0 auto 30px;">
                        We're working on interactive quizlets to help you study better. 
                        This feature will be available soon!
                    </p>
                    <div class="progress-bar" style="width: 300px; height: 10px; background: #E5E7EB; border-radius: 5px; margin: 30px auto;">
                        <div class="progress-fill" style="width: 65%; height: 100%; background: linear-gradient(135deg, #4C1D95, #7C3AED); border-radius: 5px;"></div>
                    </div>
                    <p style="color: #9CA3AF; font-size: 0.9rem;">Development in progress - 65% complete</p>
                </div>
            </section>

            <!-- Toast Notification -->
            <div class="toast" id="toast" style="display: none;"></div>

            <!-- FOOTER -->
            <footer class="app-footer">
                <div class="footer-content">
                    <div class="footer-section">
                        <h3>Nakuru College of Health Sciences and Management (NCHSM)</h3>
                        <p>Providing quality health sciences and management education with practical skills and digital innovation.</p>
                        <div class="contact-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Kiamunyi Off Nakuru - Kabarak Rd, Along Canon Ndungu Street, Nakuru</span>
                        </div>
                    </div>
                    
                    <div class="footer-section">
                        <h3>Contact Information</h3>
                        <div class="footer-contact">
                            <div class="contact-item">
                                <i class="fas fa-envelope"></i>
                                <span>portal.nchsm@gmail.com</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-phone"></i>
                                <span>0790969743</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-map-pin"></i>
                                <span>P. O. Box 12906 - 20100, Nakuru</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-clock"></i>
                                <span>Mon - Fri: 8:00 AM - 5:00 PM</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer-section">
                        <h3>Quick Links</h3>
                        <ul class="footer-links">
                            <li><a href="#" data-tab="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                            <li><a href="#" data-tab="courses"><i class="fas fa-book"></i> My Courses</a></li>
                            <li><a href="#" data-tab="calendar"><i class="fas fa-calendar"></i> Academic Calendar</a></li>
                            <li><a href="#" data-tab="resources"><i class="fas fa-file-pdf"></i> Resources</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h3>Support</h3>
                        <ul class="footer-links">
                            <li><a href="#" data-tab="messages"><i class="fas fa-question-circle"></i> Contact Admin</a></li>
                            <li><a href="#" id="clearCacheBtn"><i class="fas fa-broom"></i> Clear Cache</a></li>
                            <li><a href="#" id="exportDataBtn"><i class="fas fa-download"></i> Export Data</a></li>
                            <li><a href="#" id="systemInfoBtn"><i class="fas fa-info-circle"></i> System Info</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <div class="copyright">
                        ¬© 2025 Nakuru College of Health Sciences and Management. All rights reserved.
                        <span id="appVersion" style="margin-left: 10px; opacity: 0.7;">v2.1</span>
                    </div>
                    <div class="footer-social">
                        <a href="https://facebook.com" class="social-icon" target="_blank" aria-label="Facebook">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="https://twitter.com" class="social-icon" target="_blank" aria-label="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://instagram.com" class="social-icon" target="_blank" aria-label="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="mailto:portal.nchsm@gmail.com" class="social-icon" aria-label="Email">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Transcript Modal - No Print -->
    <div id="transcript-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:white; padding:16px; border-radius:8px; max-width:350px; width:90%; position:relative; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
            <button id="closeTranscriptBtn" style="position:absolute; top:8px; right:8px; background:none; border:none; font-size:1.2em; cursor:pointer; color:#6B7280; padding:4px; width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:50%;">√ó</button>
            
            <!-- Header -->
            <div style="text-align:center; margin-bottom:15px; padding-bottom:8px; border-bottom:1px solid var(--color-primary, #4F46E5);">
                <h4 style="margin:0; color: var(--color-primary, #4F46E5); font-size:1.1em; font-weight:600;">
                    <i class="fas fa-file-alt" style="margin-right:6px;"></i> Exam Transcript
                </h4>
                <p id="transcript-exam-name" style="margin:5px 0 0; font-size:0.85em; color:#6B7280;"></p>
            </div>
            
            <!-- Scores Table -->
            <table style="width:100%; border-collapse:collapse; font-size:0.9em; margin-bottom:10px;">
                <tr>
                    <td style="font-weight:600; padding:6px 0; width:50%;">CAT 1 (30):</td>
                    <td id="transcript-cat1" style="padding:6px 0; text-align:right;"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">CAT 2 (30):</td>
                    <td id="transcript-cat2" style="padding:6px 0; text-align:right;"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">Final (40):</td>
                    <td id="transcript-final" style="padding:6px 0; text-align:right;"></td>
                </tr>
                <tr style="border-top:1px solid #e5e7eb;">
                    <td style="font-weight:700; padding:8px 0;">Total Score:</td>
                    <td id="transcript-total" style="padding:8px 0; font-weight:700; text-align:right;"></td>
                </tr>
                <tr>
                    <td style="font-weight:700; padding:6px 0;">Status:</td>
                    <td id="transcript-status" style="padding:6px 0; font-weight:700; text-align:right;"></td>
                </tr>
            </table>
            
            <!-- Note -->
            <div style="margin-top:10px; padding:8px; background:#f0f9ff; border-radius:4px; font-size:0.8em; color:#0369a1; border-left:3px solid #0ea5e9;">
                <i class="fas fa-info-circle" style="margin-right:5px;"></i>
                Provisional - subject to moderation
            </div>
            
            <!-- Close Button Only -->
            <div style="margin-top:15px; text-align:center;">
                <button id="closeTranscriptModalBtn" style="padding:8px 20px; background:var(--color-primary, #4F46E5); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.9em; font-weight:500; width:100%;">
                    Close Transcript
                </button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Modules - Load in CORRECT order -->
    <!-- Core Database Module MUST be loaded after config.js -->
    <script src="./js/database.js"></script>
    
    <!-- UI Module -->
    <script src="./js/ui.js"></script>
    
    <!-- Utility Modules -->
    <script src="./js/utils.js"></script>
    <script src="./js/services/toast.js"></script>
    <script src="./js/services/cache-manager.js"></script>
    <script src="./js/services/offline-manager.js"></script>
    
    <!-- Feature Modules -->
    <script src="./js/dashboard.js"></script>
    <script src="./js/profile.js"></script>
    <script src="./js/attendance.js"></script>
    <script src="./js/courses.js"></script>
    <script src="./js/exams.js"></script>
    <script src="./js/resources.js"></script>
    <script src="./js/calendar.js"></script>
    <script src="./js/messages.js"></script>
    <script src="./js/nurseiq.js"></script>
    
    <!-- Main App Initialization -->
    <script>
    // Global app object to store module functions
    window.app = {
        ui: {},
        auth: {},
        profile: {},
        attendance: {},
        calendar: {},
        courses: {},
        exams: {},
        resources: {},
        messages: {},
        nurseiq: {},
        utils: {}
    };

    // Basic UI functions
    function toggleMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }

    function closeMenu() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
    }

    function showTab(tabId) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab
        const selectedTab = document.getElementById(tabId);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
        
        // Update active nav link
        document.querySelectorAll('.nav a').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-tab') === tabId) {
                link.classList.add('active');
            }
        });
        
        // Close mobile menu
        closeMenu();
        
        // Load tab-specific data
        loadTabData(tabId);
    }

    async function loadTabData(tabId) {
        try {
            switch(tabId) {
                case 'dashboard':
                    if (typeof loadDashboard === 'function') await loadDashboard();
                    break;
                case 'profile':
                    if (typeof loadProfile === 'function') await loadProfile();
                    break;
                case 'calendar':
                    if (typeof loadAcademicCalendar === 'function') await loadAcademicCalendar();
                    break;
                case 'courses':
                    if (typeof loadCourses === 'function') await loadCourses();
                    break;
                case 'attendance':
                    if (typeof loadAttendance === 'function') await loadAttendance();
                    break;
                case 'cats':
                    if (typeof loadExams === 'function') await loadExams();
                    break;
                case 'resources':
                    if (typeof loadResources === 'function') await loadResources();
                    break;
                case 'messages':
                    if (typeof loadMessages === 'function') await loadMessages();
                    break;
                case 'nurseiq':
                    if (typeof loadNurseIQ === 'function') await loadNurseIQ();
                    break;
            }
        } catch (error) {
            console.error(`Error loading tab ${tabId}:`, error);
        }
    }

    async function logout() {
        try {
            if (typeof db !== 'undefined' && db.logout) {
                await db.logout();
            }
            window.location.href = 'login.html';
        } catch (error) {
            console.error('Logout error:', error);
            if (typeof showToast === 'function') {
                showToast('Logout failed. Please try again.', 'error');
            }
        }
    }

    // Set up event listeners
    function setupEventListeners() {
        try {
            // Menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const overlay = document.getElementById('overlay');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', toggleMenu);
            }
            
            if (overlay) {
                overlay.addEventListener('click', closeMenu);
            }
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            // Tab navigation
            document.querySelectorAll('.nav a[data-tab]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
            
            // Dashboard card clicks
            document.querySelectorAll('.card[data-tab]').forEach(card => {
                card.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
            
            // Footer links
            document.querySelectorAll('.footer-links a[data-tab]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });
            
            console.log('Event listeners set up successfully');
        } catch (error) {
            console.error('Error setting up event listeners:', error);
        }
    }

    // Initialize the application
    async function initializeApp() {
        try {
            console.log('Starting app initialization...');
            
            // Check if config is loaded
            if (typeof supabaseConfig === 'undefined') {
                throw new Error('Configuration not loaded. config.js must be loaded first.');
            }
            
            // Check if database module exists
            if (typeof db === 'undefined') {
                throw new Error('Database module not loaded. Check script loading order.');
            }
            
            // Initialize the database
            console.log('Initializing database...');
            await db.initialize();
            
            // Set up event listeners
            console.log('Setting up event listeners...');
            setupEventListeners();
            
            // Load initial dashboard data
            console.log('Loading initial dashboard...');
            await loadTabData('dashboard');
            
            // Show success message
            if (typeof showToast === 'function') {
                showToast('Dashboard loaded successfully!', 'success');
            }
            
            console.log('App initialized successfully!');
            
        } catch (error) {
            console.error('Failed to initialize app:', error);
            
            // Show user-friendly error message
            const errorContainer = document.getElementById('welcome-section');
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <h2 style="color: var(--color-alert);">Initialization Error</h2>
                    <p>Failed to load the dashboard. Please try:</p>
                    <ol>
                        <li>Refreshing the page</li>
                        <li>Checking your internet connection</li>
                        <li>Contacting support if the issue persists</li>
                    </ol>
                    <button onclick="window.location.reload()" style="padding: 10px 20px; background: var(--color-primary); color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                        Refresh Page
                    </button>
                `;
            }
            
            if (typeof showToast === 'function') {
                showToast('Failed to initialize app. Please refresh the page.', 'error');
            }
        }
    }

    // Export functions to global scope
    window.toggleMenu = toggleMenu;
    window.closeMenu = closeMenu;
    window.showTab = showTab;
    window.logout = logout;
    window.loadTabData = loadTabData;
    
    // Store in app object for compatibility
    app.ui.toggleMenu = toggleMenu;
    app.ui.closeMenu = closeMenu;
    app.ui.showTab = showTab;
    app.auth.logout = logout;

    // Initialize app when DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, initializing app...');
        setTimeout(initializeApp, 100); // Small delay to ensure all scripts are loaded
    });

    // Add animation style
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
    </script>
</body>
</html>
