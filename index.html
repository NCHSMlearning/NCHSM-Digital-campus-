<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSM Digital Student Dashboard</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add these lines to your HTML <head> section -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    
    <!-- CONFIG WILL BE INJECTED BY GITHUB ACTIONS -->
    <script src="./config.js"></script>
    
    <!-- CSS Files -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/main.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4C1D95">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NCHSM Portal">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
    
    <!-- Windows PWA Support -->
    <meta name="msapplication-TileColor" content="#4C1D95">
    <meta name="msapplication-TileImage" content="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png">
</head>
<body>
    <!-- Loading Screen -->
<div id="loading-screen">
    <div class="loading-container">
        <!-- Animated Logo -->
        <div class="logo-animation">
            <div class="logo-circle">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="logo-ring"></div>
            <div class="logo-pulse"></div>
        </div>
        
        <!-- Welcome Message -->
        <div class="welcome-text">
            <h1>Welcome to NCHSM Student Portal</h1>
            <p class="subtitle">Your gateway to academic excellence</p>
        </div>
        
        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">Preparing your portal...</div>
        </div>
        
        <!-- Status Steps -->
        <div class="status-steps" id="status-steps">
            <!-- Steps will be added dynamically -->
        </div>
        
        <!-- Fun Fact / Tip -->
        <div class="fun-fact" id="fun-fact">
            <i class="fas fa-lightbulb"></i>
            <span>Did you know? You can access your course materials offline!</span>
        </div>
        
        <!-- Loading Animation -->
        <div class="loading-animation">
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
</div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator" style="display: none;">
        <i class="fas fa-wifi-slash"></i> You are offline. Some features may be unavailable.
    </div>

    <!-- Main App Content (Initially hidden) -->
    <div id="app-content" style="display: none;">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <div class="header-title-container">
                <span>NCHSM Digital Student Portal</span>
                <img 
                    id="header-passport-preview" 
                    src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" 
                    alt="Profile Photo" 
                    class="header-profile-photo"
                />
            </div>
        </div>

        <!-- Mobile Overlay -->
        <div class="overlay" id="overlay"></div>

        <!-- Main Container -->
        <div class="container">
            <!-- Sidebar Navigation -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <img src="https://raw.githubusercontent.com/NCHSMlearning/e-learning/main/images/Logo_NCHSM.png" alt="NCHSM Logo">
                    <h2>STUDENT PORTAL</h2>
                </div>
                <ul class="nav">
                    <li><a href="#" data-tab="dashboard" class="active">üè† Dashboard</a></li>
                    <li><a href="#" data-tab="profile">üë§ Profile</a></li>
                    <li><a href="#" data-tab="calendar">üìÖ Academic Calendar</a></li> 
                    <li><a href="#" data-tab="courses">üìö My Courses</a></li>
                    <li><a href="#" data-tab="attendance">‚úÖ Attendance</a></li>
                    <li><a href="#" data-tab="cats">üìù CATS/Exams</a></li>
                    <li><a href="#" data-tab="resources">üìÅ Resources</a></li>
                    <li><a href="#" data-tab="messages">üí¨ Messages</a></li>
                    <li><a href="#" data-tab="nurseiq" class="nurseiq-nav">
                        <div class="nav-icon-wrapper">
                            <i class="fas fa-brain"></i>
                            <span class="nav-pulse"></span>
                        </div>
                        <span class="nav-text">NurseIQ</span>
                        <span class="nav-subtitle">Assessment Center</span>
                        <span class="nav-badge" id="nurseiqBadge">0</span>
                    </a></li>
                    <li><a href="#" data-tab="coming-soon-quizlets">üìù Coming Soon: Quizlets</a></li>
                </ul>
                <div class="logout"><a href="#" id="logoutBtn">Logout</a></div>
            </aside>

            <!-- Main Content -->
            <main class="main">
                <!-- Dashboard Tab -->
                <section id="dashboard" class="tab-content active">
                    <div id="welcome-section" class="welcome-card">
                        <h2 id="welcome-header">Welcome back, Student!</h2>
                        <p id="student-welcome-message">Access your courses, schedule, and check your attendance status.</p>
                    </div>

                    <div id="announcement-banner">
                        <span class="info-icon">üì£</span>
                        <div>
                            <strong>Official Announcement:</strong>
                            <p id="student-announcement">Loading latest announcement...</p>
                        </div>
                    </div>

                    <h2 style="margin-top: 20px; color: var(--color-primary); font-weight: 700;">Quick Snapshot</h2>
                    <div class="cards">
                        <div class="card alert-card" data-tab="attendance">
                            <h3>Attendance Rate</h3>
                            <p class="data" id="dashboard-attendance-rate">--%</p>
                            <small>Verified Check-ins: <strong id="dashboard-verified-count">0</strong> / <strong id="dashboard-total-count">0</strong></small>
                            <small style="display:block; margin-top: 5px; color:var(--color-alert);">Pending Review: <strong id="dashboard-pending-count">0</strong></small>
                        </div>

                        <div class="card" data-tab="cats">
                            <h3>Upcoming Exam</h3>
                            <p style="font-size: 1.2rem; font-weight: 700; color: #F97316;" id="dashboard-upcoming-exam">Loading...</p>
                            <small>Next CAT/Exam date</small>
                        </div>

                        <div class="card" data-tab="courses">
                            <h3>Active Courses</h3>
                            <p class="data" id="dashboard-active-courses">0</p>
                            <small>Currently enrolled</small>
                        </div>

                        <div class="card" data-tab="resources">
                            <h3>New Resources</h3>
                            <p class="data" id="dashboard-new-resources">0</p>
                            <small>Last 7 days</small>
                        </div>

                        <!-- NurseIQ Card on Dashboard -->
                        <div class="card nurseiq-card" data-tab="nurseiq" style="border-left: 4px solid #8B5CF6;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i class="fas fa-brain" style="color: #8B5CF6; font-size: 1.2rem;"></i>
                                <h3 style="margin: 0;">NurseIQ Progress</h3>
                            </div>
                            <p class="data" id="dashboard-nurseiq-progress">--%</p>
                            <small>Accuracy: <strong id="dashboard-nurseiq-accuracy">--%</strong></small>
                            <small style="display:block; margin-top: 5px; color: var(--color-primary);">Questions: <strong id="dashboard-nurseiq-questions">0</strong> completed</small>
                        </div>
                    </div>

                    <h2 id="actions-title" style="margin-top: 30px; color: var(--color-primary); font-weight: 700;">Action Required</h2>
                    <div id="dashboard-actions">
                        <div id="action-passport" class="card" style="border-left-color: var(--color-alert); cursor: default; display: none;">
                            <h3>Missing Passport Photo</h3>
                            <p>Your profile is incomplete. Please upload your passport photo immediately.</p>
                            <button class="profile-button" data-tab="profile">Go to Profile</button>
                        </div>
                        
                        <div class="card" style="border-left-color: var(--color-warning); cursor: default;">
                            <h3>Review New Course Material</h3>
                            <p>New study materials have been posted for this block.</p>
                            <button class="profile-button" data-tab="resources" style="background-color: var(--color-warning);">View Resources</button>
                        </div>
                        
                        <div id="latest-announcement-card" class="card" style="border-left-color: var(--color-success); display: none; cursor: pointer;">
                            <h4><span id="announcement-title" style="color: var(--color-primary);">Loading...</span></h4>
                            <p id="announcement-body" style="margin-bottom: 10px;">Loading message body...</p>
                            <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.9;">
                                <span id="announcement-date"></span> | 
                                <span id="announcement-status" style="font-weight: bold;"></span>
                            </div>
                            <button data-tab="messages" class="profile-button" style="background-color: var(--color-primary); margin-top: 15px;">Go to Messages Tab</button>
                        </div>

                        <!-- NurseIQ Action Card -->
                        <div id="nurseiq-action-card" class="card" style="border-left-color: #8B5CF6; cursor: pointer; display: none;">
                            <h3><i class="fas fa-brain" style="margin-right: 8px;"></i> NurseIQ Practice Needed</h3>
                            <p id="nurseiq-action-message">Complete your NurseIQ assessments to improve your scores.</p>
                            <button data-tab="nurseiq" class="profile-button" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); margin-top: 10px;">
                                <i class="fas fa-play-circle"></i> Start Practicing
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Profile Tab -->
                <section id="profile" class="tab-content">
                    <h2 style="color: var(--color-primary);">My Profile & Account</h2>
                    <form id="profile-form">
                        <div class="profile-media">
                            <img id="passport-preview" src="https://dummyimage.com/150x150/cccccc/000000.png&text=NO+PHOTO" alt="Passport Photo">
                            <input type="file" id="passport-file-input" accept="image/jpeg,image/png" style="display: none;">
                            <label for="passport-file-input" class="file-upload-label" id="upload-label" style="display: none; cursor: pointer; padding: 10px; background-color: #5B21B6; color: white; border-radius: 6px; margin-top: 15px; display: block; text-align: center;">Change Photo</label>
                            <button type="button" id="upload-button" class="profile-button" style="margin-top: 15px; display: none;">Save Photo</button>
                        </div>

                        <div class="profile-details">
                            <div class="form-field full-width">
                                <label for="profile-name">Full Name</label>
                                <input type="text" id="profile-name" readonly required>
                            </div>
                            <div class="form-field">
                                <label for="profile-student-id">Student ID / Reg. No.</label>
                                <input type="text" id="profile-student-id" readonly> 
                            </div>
                            <div class="form-field">
                                <label for="profile-email">Email (Login ID)</label>
                                <input type="email" id="profile-email" readonly>
                            </div>
                            <div class="form-field">
                                <label for="profile-phone">Phone Number</label>
                                <input type="tel" id="profile-phone" readonly>
                            </div>
                            <div class="form-field">
                                <label for="profile-program">Program</label>
                                <input type="text" id="profile-program" readonly>
                            </div>
                            <div class="form-field">
                                <label for="profile-block">Block</label>
                                <input type="text" id="profile-block" readonly>
                            </div>
                            <div class="form-field">
                                <label for="profile-intake-year">Intake Year</label>
                                <input type="text" id="profile-intake-year" readonly>
                            </div>
                            <div class="form-field full-width">
                                <button type="button" id="edit-profile-button" class="profile-button">Edit Profile Details</button>
                                <button type="submit" id="save-profile-button" class="profile-button" style="display: none;">Save Changes</button>
                            </div>
                            <p id="profile-status" class="full-width"></p>
                        </div>
                    </form>
                </section>

                <!-- Calendar Tab -->
                <section id="calendar" class="tab-content">
                    <h2 style="color: var(--color-primary);">Academic Calendar</h2>
                    <p class="subtitle">A unified view of your scheduled sessions, clinical rotations, and exams.</p>

                    <div class="calendar-controls" style="margin-bottom: 20px;">
                        <label for="calendar-filter">Filter by Type:</label>
                        <select id="calendar-filter">
                            <option value="all">Show All</option>
                            <option value="Clinical">Clinical Rotations</option>
                            <option value="Class">Scheduled Sessions</option>
                            <option value="Exam">Exams/CATS</option>
                        </select>
                    </div>

                    <div style="overflow-x: auto;"> 
                        <table>
                            <thead>
                                <tr>
                                    <th class="date-col">Date & Time</th>
                                    <th>Event / Details</th>
                                    <th class="session-type-col">Type</th>
                                </tr>
                            </thead>
                            <tbody id="calendar-table">
                                <tr><td colspan="3">Loading academic schedule...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

              <!-- Courses Tab -->
<section id="courses" class="tab-content">
    <!-- Header Section -->
    <div class="courses-header">
        <div class="header-content">
            <h2><i class="fas fa-book-open"></i> My Courses</h2>
            <p class="subtitle">View your current and completed courses</p>
        </div>
        <div class="header-stats">
            <div class="stat-card">
                <i class="fas fa-spinner stat-icon active"></i>
                <div class="stat-info">
                    <span class="stat-value" id="active-courses-count">0</span>
                    <span class="stat-label">Active Courses</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle stat-icon completed"></i>
                <div class="stat-info">
                    <span class="stat-value" id="completed-courses-count">0</span>
                    <span class="stat-label">Completed</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-star stat-icon credits"></i>
                <div class="stat-info">
                    <span class="stat-value" id="total-credits">0</span>
                    <span class="stat-label">Credits Earned</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button id="view-all-courses" class="action-btn active">
            <i class="fas fa-list"></i> View All Courses
        </button>
        <button id="view-active-only" class="action-btn">
            <i class="fas fa-spinner"></i> Active Only
        </button>
        <button id="view-completed-only" class="action-btn">
            <i class="fas fa-check-circle"></i> Completed Only
        </button>
        <button id="refresh-courses-btn" class="action-btn refresh">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <!-- Active Courses Section (Will be hidden when viewing completed only) -->
    <div id="active-courses-section" class="courses-section">
        <div class="section-header">
            <h3><i class="fas fa-spinner"></i> Active Courses</h3>
            <div class="section-info">
                <span class="course-count" id="active-count">0 courses</span>
                <span class="term-info" id="current-term">Current Term</span>
            </div>
        </div>
        
        <div class="courses-grid" id="active-courses-grid">
            <!-- Loading state -->
            <div class="course-card loading">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <p>Loading active courses...</p>
                </div>
            </div>
        </div>

        <!-- Empty state -->
        <div id="active-empty" class="empty-state" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-calendar-plus"></i>
            </div>
            <h3>No Active Courses</h3>
            <p id="active-empty-message">You don't have any active courses at the moment.</p>
        </div>
    </div>

    <!-- Completed Courses Section -->
    <div id="completed-courses-section" class="courses-section completed-section">
        <div class="section-header">
            <h3><i class="fas fa-check-circle"></i> Completed Courses</h3>
            <div class="section-info">
                <span class="course-count" id="completed-total-count">0 courses</span>
                <span class="credits-earned" id="completed-credits-total">0 credits earned</span>
            </div>
        </div>
        
        <div class="courses-table-container">
            <table class="courses-table">
                <thead>
                    <tr>
                        <th>Course Name</th>
                        <th>Unit Code</th>
                        <th>Credits</th>
                        <th>Term</th>
                        <th>Completion Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="completed-courses-table">
                    <tr class="loading">
                        <td colspan="6">
                            <div class="loading-content">
                                <div class="loading-spinner"></div>
                                <p>Loading completed courses...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Completed Summary -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i>
                    <h4>Academic Summary</h4>
                </div>
                <div class="card-body">
                    <div class="summary-item">
                        <span class="label">GPA (Completed)</span>
                        <span class="value" id="completed-gpa">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Highest Grade</span>
                        <span class="value grade-A" id="highest-grade">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Average Grade</span>
                        <span class="value" id="average-grade">--</span>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="card-header">
                    <i class="fas fa-calendar-alt"></i>
                    <h4>Completion Timeline</h4>
                </div>
                <div class="card-body">
                    <div class="timeline-item">
                        <span class="label">First Course</span>
                        <span class="value" id="first-course-date">--</span>
                    </div>
                    <div class="timeline-item">
                        <span class="label">Latest Course</span>
                        <span class="value" id="latest-course-date">--</span>
                    </div>
                    <div class="timeline-item">
                        <span class="label">Completion Rate</span>
                        <span class="value" id="completion-rate">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty state -->
        <div id="completed-empty" class="empty-state" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h3>No Completed Courses</h3>
            <p id="completed-empty-message">Complete your active courses to see them listed here!</p>
            <button onclick="switchToActiveCourses()" class="btn btn-primary" id="completed-empty-button">
                <i class="fas fa-eye"></i> View Active Courses
            </button>
        </div>
    </div>
</section>
                <!-- Attendance Tab -->
                <section id="attendance" class="tab-content">
                    <h2 style="color: var(--color-primary);">Daily Attendance Check-in</h2>

                    <div class="check-in-controls">
                        <div class="control-group">
                            <label for="session-type">Session Type:</label>
                            <select id="session-type">
                                <option value="Clinical">Clinical Session</option>
                                <option value="Class">On Class Session</option>
                            </select>
                        </div>

                        <div class="control-group" id="target-control-group">
                            <label for="attendance-target" id="target-label">Department/Course:</label>
                            <select id="attendance-target">
                                <option value="">Select Session Type first...</option>
                            </select>
                        </div>

                        <button id="check-in-button">Check In Now</button>

                        <p id="geo-message">Select a <strong>Session Type</strong> and then a specific <strong>Department or Course</strong> to check in at your current GPS location and time.</p>
                    </div>

                    <h3 style="color: var(--color-primary);">Past Attendance History (Check-in Logs)</h3>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Session Type</th>
                                    <th>Target</th>
                                    <th>Verified</th>
                                </tr>
                            </thead>
                            <tbody id="geo-attendance-history">
                                <tr><td colspan="4">Loading geo check-in history...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

               <!-- Exams & Assessments Tab -->
<section id="cats" class="tab-content">
    <!-- Header Section -->
    <div class="exams-header">
        <div class="header-content">
            <h2><i class="fas fa-chart-bar"></i> Assessments & Grades</h2>
            <p class="subtitle">Track your CATS, exams, and assessment results</p>
        </div>
        <div class="header-stats">
            <div class="stat-card">
                <i class="fas fa-spinner stat-icon active"></i>
                <div class="stat-info">
                    <span class="stat-value" id="current-assessments-count">0</span>
                    <span class="stat-label">Current</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle stat-icon completed"></i>
                <div class="stat-info">
                    <span class="stat-value" id="completed-assessments-count">0</span>
                    <span class="stat-label">Completed</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-percentage stat-icon average"></i>
                <div class="stat-info">
                    <span class="stat-value" id="overall-average">--</span>
                    <span class="stat-label">Avg Score</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button id="view-all-assessments" class="action-btn active">
            <i class="fas fa-list"></i> View All
        </button>
        <button id="view-current-only" class="action-btn">
            <i class="fas fa-spinner"></i> Current Only
        </button>
        <button id="view-completed-only" class="action-btn">
            <i class="fas fa-check-circle"></i> Completed Only
        </button>
        <button id="view-transcript" class="action-btn">
            <i class="fas fa-file-pdf"></i> View Transcript
        </button>
        <button id="refresh-assessments" class="action-btn refresh">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <!-- Current Assessments Section -->
    <div class="assessments-section current-section">
        <div class="section-header">
            <h3><i class="fas fa-spinner"></i> Current Assessments</h3>
            <div class="section-info">
                <span class="count-badge" id="current-count">0 pending</span>
                <span class="info-text">Awaiting results or submission</span>
            </div>
        </div>
        
        <div class="assessments-table-container">
            <table class="assessments-table">
                <thead>
                    <tr>
                        <th>Assessment</th>
                        <th>Type</th>
                        <th>Unit</th>
                        <th class="text-center">Block</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th class="text-center">CAT 1</th>
                        <th class="text-center">CAT 2</th>
                        <th class="text-center">Final</th>
                        <th class="text-center">Total</th>
                    </tr>
                </thead>
                <tbody id="current-assessments-table">
                    <tr class="loading">
                        <td colspan="10">
                            <div class="loading-content">
                                <div class="loading-spinner"></div>
                                <p>Loading current assessments...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Empty state -->
        <div id="current-empty" class="empty-state" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <h3>No Current Assessments</h3>
            <p>You don't have any pending assessments at the moment.</p>
        </div>
    </div>

    <!-- Completed Assessments Section -->
    <div class="assessments-section completed-section">
        <div class="section-header">
            <h3><i class="fas fa-check-circle"></i> Completed Assessments</h3>
            <div class="section-info">
                <span class="count-badge" id="completed-count">0 graded</span>
                <span class="average-score" id="completed-average">Average: --</span>
            </div>
        </div>
        
        <div class="assessments-table-container">
            <table class="assessments-table">
                <thead>
                    <tr>
                        <th>Assessment</th>
                        <th>Type</th>
                        <th>Unit</th>
                        <th class="text-center">Block</th>
                        <th>Date Graded</th>
                        <th>Status</th>
                        <th class="text-center">CAT 1</th>
                        <th class="text-center">CAT 2</th>
                        <th class="text-center">Final Exam</th>
                        <th class="text-center">Total (%)</th>
                        <th class="text-center">Grade</th>
                    </tr>
                </thead>
                <tbody id="completed-assessments-table">
                    <tr class="loading">
                        <td colspan="11">
                            <div class="loading-content">
                                <div class="loading-spinner"></div>
                                <p>Loading completed assessments...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Performance Summary -->
        <div class="performance-summary">
            <div class="summary-card">
                <div class="card-header">
                    <i class="fas fa-trophy"></i>
                    <h4>Performance Overview</h4>
                </div>
                <div class="card-body">
                    <div class="summary-item">
                        <span class="label">Best Score</span>
                        <span class="value best-score" id="best-score">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Lowest Score</span>
                        <span class="value lowest-score" id="lowest-score">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Pass Rate</span>
                        <span class="value" id="pass-rate">--</span>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="card-header">
                    <i class="fas fa-chart-pie"></i>
                    <h4>Grade Distribution</h4>
                </div>
                <div class="card-body">
                    <div class="distribution-item">
                        <span class="label">Distinction (‚â•85%)</span>
                        <div class="distribution-bar">
                            <div class="bar-fill" id="distinction-bar" style="width: 0%"></div>
                        </div>
                        <span class="value" id="distinction-count">0</span>
                    </div>
                    <div class="distribution-item">
                        <span class="label">Credit (75-84%)</span>
                        <div class="distribution-bar">
                            <div class="bar-fill" id="credit-bar" style="width: 0%"></div>
                        </div>
                        <span class="value" id="credit-count">0</span>
                    </div>
                    <div class="distribution-item">
                        <span class="label">Pass (60-74%)</span>
                        <div class="distribution-bar">
                            <div class="bar-fill" id="pass-bar" style="width: 0%"></div>
                        </div>
                        <span class="value" id="pass-count">0</span>
                    </div>
                    <div class="distribution-item">
                        <span class="label">Fail (<60%)</span>
                        <div class="distribution-bar">
                            <div class="bar-fill" id="fail-bar" style="width: 0%"></div>
                        </div>
                        <span class="value" id="fail-count">0</span>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="card-header">
                    <i class="fas fa-calendar-alt"></i>
                    <h4>Assessment Timeline</h4>
                </div>
                <div class="card-body">
                    <div class="timeline-item">
                        <span class="label">First Assessment</span>
                        <span class="value" id="first-assessment-date">--</span>
                    </div>
                    <div class="timeline-item">
                        <span class="label">Latest Assessment</span>
                        <span class="value" id="latest-assessment-date">--</span>
                    </div>
                    <div class="timeline-item">
                        <span class="label">Total Submitted</span>
                        <span class="value" id="total-submitted">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty state -->
        <div id="completed-empty" class="empty-state" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h3>No Completed Assessments</h3>
            <p>Your assessment results will appear here once graded.</p>
            <button onclick="switchToCurrentAssessments()" class="btn btn-primary">
                <i class="fas fa-eye"></i> View Current Assessments
            </button>
        </div>
    </div>

    <!-- Grading Notes -->
    <div class="notes-section">
        <div class="notes-header">
            <i class="fas fa-info-circle"></i>
            <h4>Grading Information (Pass Mark: 50%)</h4>
        </div>
        <div class="notes-content">
            <div class="grading-breakdown">
                <h5>Grade Distribution:</h5>
                <ul>
                    <li><strong>Distinction:</strong> 85% and above</li>
                    <li><strong>Credit:</strong> 75% - 85%</li>
                    <li><strong>Pass:</strong> 65% - 74%</li>
                    <li><strong>Fail:</strong> Below 60%</li>
                </ul>
            </div>
            <div class="weighting-info">
                <h5>Assessment Weighting:</h5>
                <ul>
                    <li><strong>CAT 1:</strong> 15% of final grade</li>
                    <li><strong>CAT 2:</strong> 15% of final grade</li>
                    <li><strong>Final Exam:</strong> 70% of final grade</li>
                    <li><strong>Total Score:</strong> CAT 1 + CAT 2 + Final = 100%</li>
                </ul>
            </div>
            <div class="important-notes">
                <h5>Important Notes:</h5>
                <ul>
                    <li>Minimum pass mark is <strong>60%</strong></li>
                    <li>Grades are provisional until officially confirmed</li>
                    <li>Contact your lecturer for grade inquiries</li>
                    <li>Official transcripts can be requested from administration</li>
                </ul>
            </div>
        </div>
    </div>
</section>

<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

                <!-- Enhanced Resources Tab - VIEW ONLY -->
                <section id="resources" class="tab-content">
                    <div class="resources-header">
                        <h2 style="color: var(--color-primary); margin-bottom: 8px;">Learning Resources</h2>
                        <p class="subtitle" style="margin-bottom: 20px;">View your course materials and study resources</p>
                        
                        <!-- Mobile-Optimized Controls -->
                        <div class="resources-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="resource-search" placeholder="Search resources...">
                            </div>
                            
                            <div class="filter-group">
                                <select id="resource-filter">
                                    <option value="all">All Resources</option>
                                    <option value="pdf">PDF Notes</option>
                                    <option value="video">Video Lectures</option>
                                    <option value="slides">Presentation Slides</option>
                                </select>
                                
                                <select id="course-filter">
                                    <option value="all">All Courses</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile-First Resources Grid -->
                    <div class="resources-grid" id="resources-grid">
                        <!-- Resources will be loaded here dynamically -->
                        <div class="loading-state">Loading resources...</div>
                    </div>

                    <!-- Mobile Reader View -->
                    <div id="mobile-reader" class="mobile-reader" style="display: none;">
                        <div class="reader-header">
                            <button class="reader-back" id="readerBackBtn">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h3 id="reader-title">Resource Title</h3>
                            <div class="view-only-badge">
                                <i class="fas fa-eye"></i> View Only
                            </div>
                        </div>
                        <div class="reader-content" id="reader-content">
                            <!-- Resource content will be loaded here -->
                        </div>
                    </div>
                </section>

               <!-- Messages Tab - Enhanced -->
<section id="messages" class="tab-content">
    <div class="messages-container">
        <!-- Send Message Section -->
        <div class="message-send-section">
            <h2 style="color: var(--color-primary); margin-bottom: 20px;">
                <i class="fas fa-comments"></i> Message Center
            </h2>
            
            <div class="message-controls">
                <div class="form-row">
                    <div class="form-group">
                        <label for="message-recipient">To:</label>
                        <select id="message-recipient" class="form-select">
                            <option value="admin">üìã Administration Office</option>
                            <option value="academic">üë®‚Äçüè´ Academic Department</option>
                            <option value="finance">üí∞ Finance Office</option>
                            <option value="instructor">üë®‚Äçüè´ Course Instructor</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="message-priority">Priority:</label>
                        <select id="message-priority" class="form-select">
                            <option value="normal">üìÑ Normal</option>
                            <option value="urgent">‚ö†Ô∏è Urgent</option>
                            <option value="emergency">üö® Emergency</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="message-subject">Subject:</label>
                    <input type="text" id="message-subject" 
                           placeholder="Enter message subject..." 
                           class="form-input">
                </div>
                
                <div class="form-group">
                    <label for="student-message-body">Message:</label>
                    <textarea id="student-message-body" 
                              placeholder="Write your message here..." 
                              required
                              class="form-textarea"
                              maxlength="1000"></textarea>
                    <div class="char-counter">
                        <span id="char-count">0</span>/1000 characters
                    </div>
                </div>
                
                <div class="message-actions">
                    <button type="submit" id="send-message-btn" class="btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        <span id="send-text">Send Message</span>
                        <span id="sending-text" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Sending...
                        </span>
                    </button>
                    
                    <button type="button" id="preview-btn" class="btn-secondary">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                </div>
                
                <p id="message-status" class="status-message"></p>
                
                <div class="message-info">
                    <p><i class="fas fa-info-circle"></i> 
                       Messages are typically responded to within 24-48 hours.
                    </p>
                    <p><i class="fas fa-clock"></i> 
                       Office hours: Monday-Friday, 8:00 AM - 5:00 PM
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Message History Section -->
        <div class="message-history-section">
            <h3><i class="fas fa-history"></i> Message History</h3>
            
            <div class="message-filters">
                <button class="filter-btn active">All</button>
                <button class="filter-btn">Unread</button>
                <button class="filter-btn">Sent</button>
                <button class="filter-btn">Archived</button>
            </div>
            
            <div id="messages-list" class="messages-list">
                <!-- Messages will be loaded here -->
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No messages yet. Send your first message!</p>
                </div>
            </div>
        </div>
    </div>
</section>
                
                <div style="font-size: 13px; color: #6b7280;">Total Questions</div>
                         <!-- NurseIQ Tab -->
<section id="nurseiq" class="tab-content">
    <h1>NurseIQ Question Bank</h1>
    <p class="subtitle">NSCHEQ Curriculum practice questions for Kenya Registered Community Health Nursing program</p>
    
    <!-- Only Question Bank Mode -->
    <div id="questionBankModeContent">
        <!-- Student Question Bank -->
        <div class="question-bank-section" style="background: white; border-radius: 12px; padding: 25px; margin: 25px 0; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="margin: 0; color: #4f46e5; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-database"></i>
                        Question Bank
                    </h2>
                    <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">
                        Browse NSCHEQ questions organized by courses - Click any course to start a test
                    </p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="background: #4f46e5; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                        <i class="fas fa-play-circle"></i> Interactive Tests
                    </div>
                </div>
            </div>
            
            <!-- Search Box -->
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1; position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
                        <input type="text" id="studentQuestionBankSearch" placeholder="Search courses..." 
                               style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    </div>
                    <button id="nurseiqSearchBtn" style="background: #4f46e5; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button id="clearSearchBtn" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-redo"></i> Clear
                    </button>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="studentQuestionBankLoading" style="display: none; text-align: center; padding: 40px;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 15px; color: #6b7280;">Loading courses...</p>
            </div>
            
            <!-- Main Content Area -->
            <div id="studentQuestionBankContent">
                <!-- Initial welcome message -->
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="display: inline-block; width: 80px; height: 80px; background: linear-gradient(135deg, #4f46e5, #7c3aed); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <i class="fas fa-book-medical" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h3 style="color: #4f46e5; margin-bottom: 10px;">NurseIQ Question Bank</h3>
                    <p style="color: #6b7280; max-width: 500px; margin: 0 auto 30px;">
                        Access practice questions organized by NSCHEQ courses. Click any course card to start a practice test.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 24px; font-weight: bold; color: #4f46e5;">0</div>
                            <div style="font-size: 13px; color: #6b7280;">Total Questions</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">0</div>
                            <div style="font-size: 13px; color: #6b7280;">Total Courses</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">0</div>
                            <div style="font-size: 13px; color: #6b7280;">Active Questions</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">0%</div>
                            <div style="font-size: 13px; color: #6b7280;">Active Rate</div>
                        </div>
                    </div>
                    
                    <button id="loadCourseCatalogBtn" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; display: inline-flex; align-items: center; gap: 10px; transition: transform 0.2s;">
                        <i class="fas fa-play-circle"></i>
                        Load Course Catalog
                    </button>
                    
                    <p style="margin-top: 20px; color: #6b7280; font-size: 13px;">
                        <i class="fas fa-info-circle"></i> Courses will load with detailed statistics
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add spinner animation style -->
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>               

                <!-- Coming Soon Quizlets Tab -->
                <section id="coming-soon-quizlets" class="tab-content">
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-tools" style="font-size: 4rem; color: #9CA3AF; margin-bottom: 20px;"></i>
                        <h2 style="color: #4C1D95;">Coming Soon: Quizlets</h2>
                        <p style="color: #6B7280; max-width: 500px; margin: 0 auto 30px;">
                            We're working on interactive quizlets to help you study better. 
                            This feature will be available soon!
                        </p>
                        <div class="progress-bar" style="width: 300px; height: 10px; background: #E5E7EB; border-radius: 5px; margin: 30px auto;">
                            <div class="progress-fill" style="width: 65%; height: 100%; background: linear-gradient(135deg, #4C1D95, #7C3AED); border-radius: 5px;"></div>
                        </div>
                        <p style="color: #9CA3AF; font-size: 0.9rem;">Development in progress - 65% complete</p>
                    </div>
                </section>

                <!-- Toast Notification -->
                <div class="toast" id="toast" style="display: none;"></div>

                <!-- FOOTER -->
                <footer class="app-footer">
                    <div class="footer-content">
                        <div class="footer-section">
                            <h3>Nakuru College of Health Sciences and Management (NCHSM)</h3>
                            <p>Providing quality health sciences and management education with practical skills and digital innovation.</p>
                            <div class="contact-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Kiamunyi Off Nakuru - Kabarak Rd, Along Canon Ndungu Street, Nakuru</span>
                            </div>
                        </div>
                        
                        <div class="footer-section">
                            <h3>Contact Information</h3>
                            <div class="footer-contact">
                                <div class="contact-item">
                                    <i class="fas fa-envelope"></i>
                                    <span>portal.nchsm@gmail.com</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i>
                                    <span>0790969743</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-map-pin"></i>
                                    <span>P. O. Box 12906 - 20100, Nakuru</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-clock"></i>
                                    <span>Mon - Fri: 8:00 AM - 5:00 PM</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer-section">
                            <h3>Quick Links</h3>
                            <ul class="footer-links">
                                <li><a href="#" data-tab="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                                <li><a href="#" data-tab="courses"><i class="fas fa-book"></i> My Courses</a></li>
                                <li><a href="#" data-tab="calendar"><i class="fas fa-calendar"></i> Academic Calendar</a></li>
                                <li><a href="#" data-tab="resources"><i class="fas fa-file-pdf"></i> Resources</a></li>
                            </ul>
                        </div>
                        
                        <div class="footer-section">
                            <h3>Support</h3>
                            <ul class="footer-links">
                                <li><a href="#" data-tab="messages"><i class="fas fa-question-circle"></i> Contact Admin</a></li>
                                <li><a href="#" id="clearCacheBtn"><i class="fas fa-broom"></i> Clear Cache</a></li>
                                <li><a href="#" id="exportDataBtn"><i class="fas fa-download"></i> Export Data</a></li>
                                <li><a href="#" id="systemInfoBtn"><i class="fas fa-info-circle"></i> System Info</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="footer-bottom">
                        <div class="copyright">
                            ¬© 2025 Nakuru College of Health Sciences and Management. All rights reserved.
                            <span id="appVersion" style="margin-left: 10px; opacity: 0.7;">v2.1</span>
                        </div>
                        <div class="footer-social">
                            <a href="https://facebook.com" class="social-icon" target="_blank" aria-label="Facebook">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="https://twitter.com" class="social-icon" target="_blank" aria-label="Twitter">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="https://instagram.com" class="social-icon" target="_blank" aria-label="Instagram">
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="mailto:portal.nchsm@gmail.com" class="social-icon" aria-label="Email">
                                <i class="fas fa-envelope"></i>
                            </a>
                        </div>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <!-- Transcript Modal -->
    <div id="transcript-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:white; padding:16px; border-radius:8px; max-width:350px; width:90%; position:relative; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
            <button id="closeTranscriptBtn" style="position:absolute; top:8px; right:8px; background:none; border:none; font-size:1.2em; cursor:pointer; color:#6B7280; padding:4px; width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:50%;">√ó</button>
            
            <!-- Header -->
            <div style="text-align:center; margin-bottom:15px; padding-bottom:8px; border-bottom:1px solid var(--color-primary, #4F46E5);">
                <h4 style="margin:0; color: var(--color-primary, #4F46E5); font-size:1.1em; font-weight:600;">
                    <i class="fas fa-file-alt" style="margin-right:6px;"></i> Exam Transcript
                </h4>
                <p id="transcript-exam-name" style="margin:5px 0 0; font-size:0.85em; color:#6B7280;"></p>
            </div>
            
            <!-- Scores Table -->
            <table style="width:100%; border-collapse:collapse; font-size:0.9em; margin-bottom:10px;">
                <tr>
                    <td style="font-weight:600; padding:6px 0; width:50%;">CAT 1 (30):</td>
                    <td id="transcript-cat1" style="padding:6px 0; text-align:right;"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">CAT 2 (30):</td>
                    <td id="transcript-cat2" style="padding:6px 0; text-align:right;"></td>
                </tr>
                <tr>
                    <td style="font-weight:600; padding:6px 0;">Final (40):</td>
                    <td id="transcript-final" style="padding:6px 0; text-align:right;"></td>
                </tr>
                <tr style="border-top:1px solid #e5e7eb;">
                    <td style="font-weight:700; padding:8px 0;">Total Score:</td>
                    <td id="transcript-total" style="padding:8px 0; font-weight:700; text-align:right;"></td>
                </tr>
                <tr>
                    <td style="font-weight:700; padding:6px 0;">Status:</td>
                    <td id="transcript-status" style="padding:6px 0; font-weight:700; text-align:right;"></td>
                </tr>
            </table>
            
            <!-- Note -->
            <div style="margin-top:10px; padding:8px; background:#f0f9ff; border-radius:4px; font-size:0.8em; color:#0369a1; border-left:3px solid #0ea5e9;">
                <i class="fas fa-info-circle" style="margin-right:5px;"></i>
                Provisional - subject to moderation
            </div>
            
            <!-- Close Button Only -->
            <div style="margin-top:15px; text-align:center;">
                <button id="closeTranscriptModalBtn" style="padding:8px 20px; background:var(--color-primary, #4F46E5); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.9em; font-weight:500; width:100%;">
                    Close Transcript
                </button>
            </div>
        </div>
    </div>
<!-- JavaScript Files -->
<script src="./js/database.js"></script>
<script src="./js/utils.js"></script>
<script src="./js/ui.js"></script>
<script src="./js/dashboard.js"></script>
<script src="./js/profile.js"></script>
<script src="./js/attendance.js"></script>
<script src="./js/courses.js"></script>
<script src="./js/exams.js"></script>
<script src="./js/resources.js"></script>
<script src="./js/calendar.js"></script>
<script src="./js/messages.js"></script>
<script src="./js/nurseiq.js"></script>


     <!-- Initialize App -->
<!-- Initialize App -->
<script>
// Global app state
window.app = {
    config: null,
    supabase: null,
    db: null,
    user: null,
    isInitialized: false
};

// Update loading status
function updateLoadingStatus(status, details) {
    const statusEl = document.getElementById('status-text');
    const detailsEl = document.getElementById('config-details');
    
    if (statusEl) statusEl.textContent = status;
    if (detailsEl && details) {
        detailsEl.innerHTML = '<small>' + details + '</small>';
    }
}

// Initialize application - FIXED VERSION
async function initializeApp() {
    try {
        console.log('üöÄ Starting app initialization...');
        
        updateLoadingStatus('Checking configuration...');
        
        // 1. Check config
        if (!window.APP_CONFIG) {
            throw new Error('Configuration not loaded. Check if config.js exists.');
        }
        
        const config = window.APP_CONFIG;
        window.app.config = config;
        
        // Validate configuration
        if (!config.SUPABASE_URL || config.SUPABASE_URL === '%%SUPABASE_URL%%') {
            throw new Error('SUPABASE_URL is not configured in GitHub Secrets');
        }
        
        if (!config.SUPABASE_ANON_KEY || config.SUPABASE_ANON_KEY === '%%SUPABASE_ANON_KEY%%') {
            throw new Error('SUPABASE_ANON_KEY is not configured in GitHub Secrets');
        }
        
        updateLoadingStatus('Configuration loaded', 
            'Environment: ' + (config.ENVIRONMENT || 'production') + '<br>' +
            'Build: ' + (config.BUILD_TIME || 'Unknown') + '<br>' +
            'Commit: ' + (config.COMMIT_SHA ? config.COMMIT_SHA.substring(0, 7) : 'Unknown')
        );
        
        // 2. Initialize database
        updateLoadingStatus('Initializing database...');
        
        if (typeof window.db === 'undefined') {
            throw new Error('Database module not loaded. Check js/database.js');
        }
        
        const dbInstance = await window.db.initialize();
        if (!dbInstance) {
            throw new Error('Database initialization failed');
        }
        
        console.log('‚úÖ Database initialized');
        
        // 3. Check authentication
        updateLoadingStatus('Checking authentication...');
        
        let userSession = null;
        if (window.db.supabase) {
            const { data, error } = await window.db.supabase.auth.getSession();
            if (error) throw error;
            userSession = data.session;
        }
        
        if (!userSession) {
            console.log('‚ö†Ô∏è No active session, redirecting to login...');
            window.location.href = 'login.html';
            return;
        }
        
        // 4. Set user ID
        window.db.currentUserId = userSession.user.id;
        
        // 5. Load user profile
        updateLoadingStatus('Loading user profile...');
        
        try {
            // Try consolidated user profiles table
            const { data: consolidatedProfile, error: consolidatedError } = await window.db.supabase
                .from('consolidated_user_profiles_table')
                .select('*')
                .eq('id', userSession.user.id)
                .single();
            
            if (!consolidatedError && consolidatedProfile) {
                window.db.currentUserProfile = consolidatedProfile;
                console.log('‚úÖ User loaded from consolidated_user_profiles_table');
            } else {
                // Fallback to profiles table
                const { data: regularProfile, error: regularError } = await window.db.supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userSession.user.id)
                    .single();
                
                if (!regularError && regularProfile) {
                    window.db.currentUserProfile = regularProfile;
                    console.log('‚úÖ User loaded from profiles table');
                } else {
                    // Fallback to email lookup
                    const { data: emailProfile, error: emailError } = await window.db.supabase
                        .from('consolidated_user_profiles_table')
                        .select('*')
                        .eq('email', userSession.user.email)
                        .single();
                    
                    if (!emailError && emailProfile) {
                        window.db.currentUserProfile = emailProfile;
                        console.log('‚úÖ User loaded by email from consolidated table');
                    } else {
                        // Ultimate fallback
                        console.warn('Using auth data as fallback');
                        window.db.currentUserProfile = {
                            id: userSession.user.id,
                            email: userSession.user.email,
                            full_name: userSession.user.email.split('@')[0],
                            student_id: userSession.user.id.substring(0, 8),
                            program: 'Unknown',
                            block: 'Unknown',
                            intake_year: new Date().getFullYear()
                        };
                    }
                }
            }
        } catch (profileError) {
            console.error('Profile loading error:', profileError);
            // Emergency fallback
            window.db.currentUserProfile = {
                id: userSession.user.id,
                email: userSession.user.email,
                full_name: userSession.user.email.split('@')[0]
            };
        }
        
        console.log('‚úÖ User authenticated:', {
            userId: window.db.currentUserId,
            email: window.db.currentUserProfile.email,
            name: window.db.currentUserProfile.full_name
        });
        
        // 6. HIDE LOADING SCREEN AND SHOW APP
        updateLoadingStatus('Loading dashboard...');
        
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        
        // 7. Set global variables
        window.supabase = window.db.supabase;
        window.currentUserId = window.db.currentUserId;
        window.currentUserProfile = window.db.currentUserProfile;
        
        // 8. Update welcome message
        const welcomeHeader = document.getElementById('welcome-header');
        if (welcomeHeader && window.db.currentUserProfile.full_name) {
            welcomeHeader.textContent = 'Welcome back, ' + window.db.currentUserProfile.full_name + '!';
        }
        
        // 9. Initialize UI if function exists
        if (typeof initUI === 'function') {
            initUI();
        }
        
        // 10. CRITICAL FIX: Don't force dashboard - respect existing tab state
        // Check if ui module is loaded
        if (window.ui && typeof window.ui.showTab === 'function') {
            console.log('‚úÖ UI module loaded, checking current tab state...');
            
            // Check URL hash first
            const hash = window.location.hash.substring(1);
            
            // Check localStorage for last tab
            const lastTab = localStorage.getItem('nchsm_last_tab');
            
            // Determine which tab to show
            let targetTab = 'dashboard'; // Default
            
            if (hash && window.ui.isValidTab(hash)) {
                targetTab = hash;
                console.log(`üîó Using URL hash: ${hash}`);
            } else if (lastTab && window.ui.isValidTab(lastTab)) {
                targetTab = lastTab;
                console.log(`üíæ Using saved tab: ${lastTab}`);
            }
            
            console.log(`üéØ Showing tab: ${targetTab}`);
            
            // Use UI module to show the tab
            window.ui.showTab(targetTab);
            
            // Update URL to match
            if (hash !== targetTab) {
                history.replaceState(null, null, `#${targetTab}`);
            }
        } else {
            console.warn('‚ö†Ô∏è UI module not available, using fallback');
            // Fallback - show dashboard
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            const dashboard = document.getElementById('dashboard');
            if (dashboard) {
                dashboard.classList.add('active');
            }
        }
        
        // 11. Mark as initialized
        window.app.isInitialized = true;
        window.app.supabase = window.db.supabase;
        window.app.user = window.db.currentUserProfile;
        
        console.log('‚úÖ Application initialized successfully');
        
        // 12. Dispatch app ready event
        document.dispatchEvent(new CustomEvent('appReady', {
            detail: {
                userId: window.currentUserId,
                userProfile: window.currentUserProfile,
                database: window.db
            }
        }));
        
    } catch (error) {
        console.error('‚ùå Initialization failed:', error);
        
        // Show error but at least show the UI
        try {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            
            // Try to use UI module if available
            if (window.ui && typeof window.ui.showTab === 'function') {
                window.ui.showTab('dashboard');
            } else {
                const dashboard = document.getElementById('dashboard');
                if (dashboard) {
                    dashboard.classList.add('active');
                }
            }
            
            const welcomeSection = document.getElementById('welcome-section');
            if (welcomeSection) {
                welcomeSection.innerHTML = 
                    '<h2>Application Error</h2>' +
                    '<p>' + error.message + '</p>' +
                    '<button onclick="location.reload()" class="profile-button">Retry</button>';
            }
            
            console.log('‚ö†Ô∏è Showing UI in error fallback mode');
        } catch (uiError) {
            showErrorScreen('Initialization Error', 'Failed to initialize the application.', error.message);
        }
    }
}

// Tab switching function - UPDATED
window.showTab = function(tabId) {
    // Use UI module if available
    if (window.ui && typeof window.ui.showTab === 'function') {
        console.log('üì± Using UI module for tab switching');
        window.ui.showTab(tabId);
    } else {
        // Fallback
        console.warn('UI module not available, using fallback');
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        const selectedTab = document.getElementById(tabId);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
    }
};

// Load tab data
async function loadTabData(tabId) {
    if (!window.app.isInitialized) {
        console.warn('App not initialized yet, waiting...');
        setTimeout(() => loadTabData(tabId), 500);
        return;
    }
    
    try {
        console.log('Loading tab data:', tabId);
        
        // Ensure we have user data
        if (!window.currentUserId && window.db && window.db.currentUserId) {
            window.currentUserId = window.db.currentUserId;
            window.currentUserProfile = window.db.currentUserProfile;
        }
        
        switch(tabId) {
            case 'dashboard':
                if (typeof loadDashboard === 'function') {
                    await loadDashboard();
                }
                break;
            case 'profile':
                if (typeof loadProfile === 'function') {
                    await loadProfile();
                }
                break;
            case 'calendar':
                if (typeof loadAcademicCalendar === 'function') {
                    await loadAcademicCalendar();
                }
                break;
            case 'courses':
                if (typeof loadCourses === 'function') {
                    await loadCourses();
                }
                break;
            case 'attendance':
                if (window.attendanceModule && window.attendanceModule.loadAttendanceData) {
                    await window.attendanceModule.loadAttendanceData();
                }
                break;
            case 'cats':
                if (typeof loadExams === 'function') {
                    await loadExams();
                }
                break;
            case 'resources':
                if (typeof loadResources === 'function') {
                    await loadResources();
                }
                break;
            case 'messages':
                if (typeof loadMessages === 'function') {
                    await loadMessages();
                }
                break;
            case 'nurseiq':
                if (typeof loadNurseIQ === 'function') {
                    await loadNurseIQ();
                }
                break;
            default:
                console.log('No specific loader for tab:', tabId);
        }
        
        console.log('‚úÖ Tab loaded successfully:', tabId);
    } catch (error) {
        console.error('Error loading tab:', tabId, error);
    }
}

// Basic UI functions
window.toggleMenu = function() {
    if (window.ui && typeof window.ui.toggleMenu === 'function') {
        window.ui.toggleMenu();
    } else {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }
};

window.closeMenu = function() {
    if (window.ui && typeof window.ui.closeMenu === 'function') {
        window.ui.closeMenu();
    } else {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
    }
};

// Logout function
window.logout = async function() {
    try {
        // Clear tab state first
        localStorage.removeItem('nchsm_last_tab');
        
        if (window.db && window.db.logout) {
            await window.db.logout();
        } else if (window.app.supabase) {
            await window.app.supabase.auth.signOut();
            // Clear localStorage
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
    } catch (error) {
        console.error('Logout error:', error);
        window.location.href = 'login.html';
    }
};

// Global refresh function
window.refreshApp = function() {
    console.log('Refreshing application...');
    
    // Clear caches
    if (window.db && window.db.clearCache) {
        window.db.clearCache();
    }
    
    // Clear any remaining inline styles
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.removeProperty('display');
        tab.style.removeProperty('opacity');
        tab.style.removeProperty('visibility');
    });
    
    // Get current tab before reload
    const currentTab = window.ui ? window.ui.currentTab : 'dashboard';
    localStorage.setItem('refresh_tab', currentTab);
    
    // Reload page
    location.reload();
};

// Check for refresh tab state on load
function checkRefreshState() {
    const refreshTab = localStorage.getItem('refresh_tab');
    if (refreshTab && window.ui && window.ui.isValidTab(refreshTab)) {
        console.log(`üîÑ Refreshing back to: ${refreshTab}`);
        localStorage.removeItem('refresh_tab');
        setTimeout(() => {
            if (window.ui.showTab) {
                window.ui.showTab(refreshTab);
            }
        }, 100);
    }
}

// Start initialization when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('üì± DOM ready, starting app initialization...');
    
    // First, clear any existing inline styles
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.removeProperty('display');
    });
    
    // Check refresh state
    checkRefreshState();
    
    // Check if initializeApp exists
    if (typeof initializeApp === 'function') {
        console.log('‚úÖ initializeApp function found, calling it...');
        initializeApp();
    } else {
        console.error('‚ùå initializeApp function NOT FOUND!');
        // Fallback: manually show the UI
        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            
            // Use UI module if available
            if (window.ui && window.ui.showTab) {
                window.ui.showTab('dashboard');
            } else {
                const dashboard = document.getElementById('dashboard');
                if (dashboard) dashboard.classList.add('active');
            }
            
            console.log('‚ö†Ô∏è Manual fallback activated');
        }, 1000);
    }
});
</script>
</body>
</html>
