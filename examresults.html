<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nakuru College of Health Sciences - Exam Portal</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>    
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- jsPDF for PDF Transcript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            margin-top: 15px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .debug-info {
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            background: rgba(0,0,0,0.5);
            padding: 8px;
            border-radius: 4px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .progress-bar {
            width: 300px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.2s ease;
            border-radius: 4px;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 12px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            animation: slideIn 0.2s ease;
            font-size: 14px;
        }
        
        .toast.success { border-left: 4px solid #4CAF50; }
        .toast.error { border-left: 4px solid #f44336; }
        .toast.info { border-left: 4px solid #2196F3; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0%); opacity: 1; }
        }
        
        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table tr:hover {
            background-color: #f8fafc;
        }
        
        /* Cards */
        .portal-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px;
            transition: all 0.2s ease;
        }
        
        /* Grade Badges */
        .grade-badge {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .grade-a { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; }
        .grade-b { background: linear-gradient(135deg, #059669 0%, #10B981 100%); color: white; }
        .grade-c { background: linear-gradient(135deg, #D97706 0%, #F59E0B 100%); color: white; }
        .grade-d { background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%); color: white; }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pass { background: #dcfce7; color: #166534; }
        .status-fail { background: #fee2e2; color: #991b1b; }
        .status-credit { background: #dbeafe; color: #1e40af; }
        .status-distinction { background: #ede9fe; color: #5b21b6; }
        
        /* Student Summary Card */
        .student-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-value { font-size: 28px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Gradient Cards */
        .gradient-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .gradient-card-green { background: linear-gradient(135deg, #34b1aa 0%, #1c8f7c 100%); color: white; }
        .gradient-card-orange { background: linear-gradient(135deg, #f09351 0%, #e9692c 100%); color: white; }
        .gradient-card-purple { background: linear-gradient(135deg, #a166ab 0%, #6d4c7d 100%); color: white; }
        
        .row-even { background-color: #f9fafb; }
        .row-odd { background-color: white; }
        
        /* Filter Badges */
        .filter-badge {
            background: #e2e8f0;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .filter-badge.active {
            background: #4f46e5;
            color: white;
        }
        
        .selected-classes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .selected-class-tag {
            background: #4f46e5;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-class-tag i {
            cursor: pointer;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        
        /* Class Selection */
        .class-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .class-option:hover {
            border-color: #4f46e5;
            background: #f5f3ff;
        }
        
        .class-option.selected {
            border-color: #4f46e5;
            background: #eef2ff;
        }
        
        .class-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #4f46e5;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: white;
        }
        
        .class-option.selected .class-checkbox {
            background: #4f46e5;
        }
        
        /* Sheet Tabs */
        .sheet-tab {
            transition: all 0.2s ease;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 2px;
            white-space: nowrap;
        }
        
        .sheet-tab:hover {
            transform: translateY(-1px);
        }
        
        .sheet-tab.active {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }
        
        /* Excel Viewer Table */
        .excel-viewer-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
        }
        
        .excel-viewer-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 8px;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .excel-viewer-table td {
            padding: 8px;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        .excel-viewer-table tr:hover td {
            background-color: #eff6ff !important;
        }
        
        /* Mark Colors */
        .mark-excellent { color: #4F46E5; font-weight: bold; }
        .mark-good { color: #059669; font-weight: bold; }
        .mark-average { color: #D97706; font-weight: bold; }
        .mark-fail { color: #DC2626; font-weight: bold; }
        
        /* ===== ENHANCED GOOGLE SHEETS EDITOR STYLES ===== */
        
        /* Modern Edit Button */
        .edit-sheets-btn {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .edit-sheets-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 133, 244, 0.4);
        }
        
        .edit-sheets-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(66, 133, 244, 0.3);
        }
        
        .edit-sheets-btn i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .edit-sheets-btn:hover i {
            transform: rotate(10deg) scale(1.1);
        }
        
        /* Google Sheets Modal - Glassmorphism Style */
        #googleSheetsEditor .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 20px;
            max-width: 98%;
            width: 98%;
            height: 96vh;
            animation: modalPopIn 0.3s ease;
            position: relative;
            overflow: visible !important;
        }
        
        @keyframes modalPopIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* Modal Header - Premium Look */
        #googleSheetsEditor .modal-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            margin: -20px -20px 20px -20px;
            padding: 20px;
            border-radius: 24px 24px 0 0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        #googleSheetsEditor .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #googleSheetsEditor .modal-header h2 i {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        /* Google Sheets Icon with Animation */
        #googleSheetsEditor .modal-header .google-icon {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Action Buttons Container */
        #googleSheetsEditor .action-buttons {
            display: flex;
            gap: 12px;
        }
        
        /* Sync Button - Modern Gradient */
        #googleSheetsEditor .sync-btn {
            background: linear-gradient(135deg, #34a853 0%, #0f9d58 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 168, 83, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        #googleSheetsEditor .sync-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        #googleSheetsEditor .sync-btn:hover::before {
            left: 100%;
        }
        
        #googleSheetsEditor .sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 168, 83, 0.5);
        }
        
        #googleSheetsEditor .sync-btn i {
            font-size: 16px;
            animation: spin 2s linear infinite;
            animation-play-state: paused;
        }
        
        #googleSheetsEditor .sync-btn:hover i {
            animation-play-state: running;
        }
        
        /* Close Button - Modern */
        #googleSheetsEditor .close-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #googleSheetsEditor .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        /* Google Sheets Frame - Enhanced */
        #googleSheetsEditor .sheets-frame-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05), 0 8px 20px rgba(0,0,0,0.1);
            height: calc(96vh - 120px);
            border: 1px solid #e0e0e0;
        }
        
        #googleSheetsEditor .google-sheets-frame {
            width: 100%;
            height: 100%;
            border: none;
            transition: opacity 0.3s ease;
        }
        
        /* File Name Badge */
        #googleSheetsEditor .file-name-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            margin-left: 15px;
        }
        
        /* Sheet Notifications - Appear above the Google Sheet */
        .sheet-notification {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            padding: 16px 32px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
            z-index: 10002;
            animation: slideDown 0.3s ease;
            min-width: 350px;
            text-align: center;
            border-left: 6px solid;
            font-weight: 500;
            pointer-events: none;
        }
        
        .sheet-notification.success {
            border-left-color: #10b981;
            background: linear-gradient(to right, #f0fdf4, #ffffff);
        }
        
        .sheet-notification.error {
            border-left-color: #ef4444;
            background: linear-gradient(to right, #fef2f2, #ffffff);
        }
        
        .sheet-notification.info {
            border-left-color: #3b82f6;
            background: linear-gradient(to right, #eff6ff, #ffffff);
        }
        
        .sheet-notification .notification-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 16px;
        }
        
        .sheet-notification.success i {
            color: #10b981;
            font-size: 24px;
        }
        
        .sheet-notification.error i {
            color: #ef4444;
            font-size: 24px;
        }
        
        .sheet-notification.info i {
            color: #3b82f6;
            font-size: 24px;
        }
        
        @keyframes slideDown {
            from {
                top: 20px;
                opacity: 0;
                transform: translateX(-50%) scale(0.9);
            }
            to {
                top: 80px;
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
        }
        
        /* Auto-sync indicator */
        .auto-sync-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10003;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            animation: pulse 2s infinite;
        }
        
        .auto-sync-indicator i {
            color: #34a853;
            animation: spin 2s linear infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            #googleSheetsEditor .modal-content {
                padding: 15px;
                height: 98vh;
            }
            
            #googleSheetsEditor .modal-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            #googleSheetsEditor .action-buttons {
                width: 100%;
                justify-content: center;
            }
            
            #googleSheetsEditor .sync-btn,
            #googleSheetsEditor .close-btn {
                padding: 10px 20px;
                font-size: 13px;
            }
            
            .edit-sheets-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .sheet-notification {
                min-width: 280px;
                padding: 12px 20px;
                font-size: 14px;
            }
        }
        
        /* Pulse Animation for Sync Button */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 168, 83, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 168, 83, 0); }
        }
        
        #googleSheetsEditor .sync-btn:focus {
            animation: pulse 1.5s infinite;
        }
        
        /* Success Checkmark Animation */
        @keyframes checkmark {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .sync-success i {
            animation: checkmark 0.5s ease;
        }
        
        /* Grading Table */
        .grading-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .grading-table th {
            background: #1e3c72;
            color: white;
            padding: 8px;
            text-align: center;
        }
        
        .grading-table td {
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .grading-table .grade-a { background: #ede9fe; color: #5b21b6; font-weight: bold; }
        .grading-table .grade-b { background: #d1fae5; color: #065f46; font-weight: bold; }
        .grading-table .grade-c { background: #fed7aa; color: #92400e; font-weight: bold; }
        .grading-table .grade-d { background: #fee2e2; color: #991b1b; font-weight: bold; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div id="loadingMessage" class="loading-text">Loading...</div>
            <div id="debugInfo" class="debug-info"></div>
            <div id="progressContainer" style="width: 300px; margin-top: 15px; display: none;">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div id="progressText" class="text-white text-xs mt-1">0%</div>
            </div>
        </div>
    </div>

    <!-- Class Selection Modal -->
    <div id="classModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Select Classes</h3>
            <p class="text-sm text-gray-600 mb-4">Choose which classes this file belongs to (you can select multiple):</p>
            
            <div id="classOptions" class="space-y-2">
                <div class="class-option" onclick="toggleClass('2024')">
                    <div class="class-checkbox" id="class-check-2024">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2024</div>
                        <div class="text-xs text-gray-500">Class of 2024</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2025')">
                    <div class="class-checkbox" id="class-check-2025">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2025</div>
                        <div class="text-xs text-gray-500">Class of 2025</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2026')">
                    <div class="class-checkbox" id="class-check-2026">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2026</div>
                        <div class="text-xs text-gray-500">Class of 2026</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2027')">
                    <div class="class-checkbox" id="class-check-2027">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2027</div>
                        <div class="text-xs text-gray-500">Class of 2027</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2028')">
                    <div class="class-checkbox" id="class-check-2028">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2028</div>
                        <div class="text-xs text-gray-500">Class of 2028</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('other')">
                    <div class="class-checkbox" id="class-check-other">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">Other</div>
                        <div class="text-xs text-gray-500">Different intake</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="cancelClassSelection()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">Cancel</button>
                <button onclick="confirmClassSelection()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Google Sheets Editor Modal -->
    <div id="googleSheetsEditor" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fab fa-google google-icon"></i>
                    GOOGLE SHEETS EDITOR
                    <span class="file-name-badge" id="googleSheetsFileName"></span>
                </h2>
                <div class="action-buttons">
                    <button onclick="syncFromGoogleSheets()" class="sync-btn">
                        <i class="fas fa-sync-alt"></i>
                        <span>Sync to Database</span>
                    </button>
                    <button onclick="closeGoogleSheetsEditor()" class="close-btn">
                        <i class="fas fa-times"></i>
                        <span>Close</span>
                    </button>
                </div>
            </div>
            <div class="sheets-frame-container">
                <iframe id="googleSheetIframe" class="google-sheets-frame" 
                        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-downloads allow-popups-to-escape-sandbox allow-modals">
                </iframe>
            </div>
        </div>
    </div>

    <!-- Auto-sync indicator (hidden by default) -->
    <div id="autoSyncIndicator" class="auto-sync-indicator" style="display: none;">
        <i class="fas fa-sync-alt"></i>
        <span>Auto-sync enabled - watching for changes</span>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- ========== SUPABASE CONFIG ========== -->
        <script>
            // ðŸ”´ YOUR SUPABASE CREDENTIALS
            const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
            
            // Google Sheets Configuration
            const GOOGLE_API_KEY = 'AIzaSyBxp7H4REEC6qzxwbmU2jQfQ-CRVUAe9Zc';
            const GOOGLE_CLIENT_ID = '843012088804-ndacuhhd0mu4lm2taum16vgj4gfi7347.apps.googleusercontent.com';
            
            // Initialize Supabase
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            console.log('âœ… Supabase initialized!');
            
            // Global state
            let currentUser = null;
            let currentRole = null;
            let sharedFiles = [];
            let allStudentMarks = [];
            let studentIndex = new Map();
            let performanceChart = null;
            let distributionChart = null;
            let isProcessing = false;
            let processingQueue = [];
            let currentTranscriptData = null;
            let selectedClasses = new Set();
            let pendingFile = null;
            let pendingFileClasses = new Set();
            
            // Google Sheets state
            let currentGoogleSheetId = null;
            let currentGoogleSheetFileId = null;
            
            // Auto-sync state
            let autoSyncInterval = null;
            let lastDataHash = null;
            
            // College Info
            const COLLEGE_NAME = 'NAKURU COLLEGE OF HEALTH SCIENCES & MANAGEMENT';
            const COLLEGE_MOTTO = 'Excellence in Health Training, Research & Professional Development';
            const COLLEGE_ADDRESS = 'Kiamunyi Campus | P.O. Box 12906 â€“ 20100, Nakuru | Tel: 0745 215594 | 0703 345771 | 0103614355';
            const COLLEGE_EMAIL = 'info@nakurucollegeofhealth.ac.ke';
            const COLLEGE_WEBSITE = 'www.nakurucollegeofhealth.ac.ke';
            const COLLEGE_FOOTER = 'Accredited & Registered Institution | Committed to Academic Excellence | Â© 2026 Nakuru College of Health Sciences & Management';
            const PROGRAM_NAME = 'KRCHN'; // Kenya Registered Community Health Nurse
        </script>

        <!-- ========== LOGIN SCREEN ========== -->
        <div id="loginScreen" class="flex items-center justify-center min-h-screen">
            <div class="portal-card w-full max-w-md">
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-graduation-cap text-white text-3xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">NAKURU COLLEGE OF HEALTH SCIENCES</h1>
                    <p class="text-gray-600 mt-1 text-sm">EXAM RESULTS PROVISIONAL PORTAL</p>
                    <div class="mt-2">
                        <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-xs">
                            <i class="fas fa-clock mr-1"></i>
                            PROVISIONAL RESULTS
                        </span>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">
                            <i class="fas fa-envelope mr-2 text-gray-500"></i>
                            Email Address
                        </label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" 
                               class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-0 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">
                            <i class="fas fa-lock mr-2 text-gray-500"></i>
                            Password
                        </label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" 
                               class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-0 text-sm">
                    </div>
                    
                    <button onclick="handleLogin()" 
                            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2.5 rounded-lg hover:opacity-90 transition font-medium text-sm shadow-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        LOGIN
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== MAIN PORTAL ========== -->
        <div id="mainPortal" class="hidden space-y-6">
            <!-- Header -->
            <div class="portal-card">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-xl shadow-lg mr-3">
                            <i class="fas fa-graduation-cap text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl md:text-2xl font-bold text-gray-800">NAKURU COLLEGE EXAM PORTAL</h1>
                            <div class="flex items-center mt-1 text-sm">
                                <span id="userRoleBadge" class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-bold mr-2"></span>
                                <span id="userDisplayName" class="text-gray-600"></span>
                                <span class="mx-2 text-gray-400">â€¢</span>
                                <span id="userEmailDisplay" class="text-gray-500 text-xs"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="bg-orange-100 px-3 py-1.5 rounded-full flex items-center">
                            <i class="fas fa-clock text-orange-600 mr-1 text-xs"></i>
                            <span class="text-orange-800 text-xs font-semibold">PROVISIONAL</span>
                        </div>
                        <button onclick="logout()" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-300 transition text-sm">
                            <i class="fas fa-sign-out-alt mr-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Class Filter Section -->
            <div class="portal-card">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-filter text-purple-600 mr-2"></i> Filter by Class
                </h2>
                
                <div class="flex flex-wrap gap-2 mb-3">
                    <button onclick="toggleAllClasses()" class="filter-badge">
                        <i class="fas fa-check-double"></i> All Classes
                    </button>
                    <button onclick="clearClassFilter()" class="filter-badge">
                        <i class="fas fa-times"></i> Clear All
                    </button>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <span onclick="toggleClassFilter('2024')" id="filter-class-2024" class="filter-badge">March 2024</span>
                    <span onclick="toggleClassFilter('2025')" id="filter-class-2025" class="filter-badge">March 2025</span>
                    <span onclick="toggleClassFilter('2026')" id="filter-class-2026" class="filter-badge">March 2026</span>
                    <span onclick="toggleClassFilter('2027')" id="filter-class-2027" class="filter-badge">March 2027</span>
                    <span onclick="toggleClassFilter('2028')" id="filter-class-2028" class="filter-badge">March 2028</span>
                    <span onclick="toggleClassFilter('other')" id="filter-class-other" class="filter-badge">Other</span>
                </div>
                
                <!-- Selected Classes Display -->
                <div id="selectedClassesDisplay" class="selected-classes-container mt-3">
                    <!-- Selected classes will appear here -->
                </div>
                
                <div class="mt-3 text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Showing files that match any of the selected classes
                </div>
            </div>

            <!-- Grading System Reference -->
            <div class="portal-card">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-table text-blue-600 mr-2"></i> Grading System - KRCHN Program
                </h2>
                <table class="grading-table">
                    <thead>
                        <tr>
                            <th>Marks From</th>
                            <th>Marks To</th>
                            <th>Grade</th>
                            <th>Points</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>0</td>
                            <td>59</td>
                            <td class="grade-d">D</td>
                            <td>0</td>
                            <td>FAIL</td>
                        </tr>
                        <tr>
                            <td>60</td>
                            <td>74</td>
                            <td class="grade-c">C</td>
                            <td>2</td>
                            <td>PASS</td>
                        </tr>
                        <tr>
                            <td>75</td>
                            <td>84</td>
                            <td class="grade-b">B</td>
                            <td>3</td>
                            <td>CREDIT</td>
                        </tr>
                        <tr>
                            <td>85</td>
                            <td>100</td>
                            <td class="grade-a">A</td>
                            <td>4</td>
                            <td>DISTINCTION</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="gradient-card p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Files</p>
                            <p id="totalFilesStats" class="text-3xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-file-excel text-white text-xl"></i></div>
                    </div>
                </div>
                <div class="gradient-card-green p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Records</p>
                            <p id="totalRecordsStats" class="text-3xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-users text-white text-xl"></i></div>
                    </div>
                </div>
                <div class="gradient-card-orange p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Staff</p>
                            <p id="totalStaffStats" class="text-3xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-chalkboard-teacher text-white text-xl"></i></div>
                    </div>
                </div>
                <div class="gradient-card-purple p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Role</p>
                            <p id="userRoleDisplay" class="text-2xl font-bold mt-1">-</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-shield-alt text-white text-xl"></i></div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="portal-card">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-pie text-purple-600 mr-2"></i> Grade Distribution
                        <span id="chartFilterBadge" class="ml-2 text-xs bg-gray-200 px-2 py-1 rounded-full"></span>
                    </h2>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                <div class="portal-card">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-green-600 mr-2"></i> Mark Ranges
                        <span id="barChartFilterBadge" class="ml-2 text-xs bg-gray-200 px-2 py-1 rounded-full"></span>
                    </h2>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Student Search -->
            <div id="adminSearchSection" class="portal-card">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-search text-blue-600 mr-2"></i> Search Student (Admission No. or Name)
                </h2>
                
                <div class="flex gap-3 mb-6">
                    <input type="text" id="studentSearchInput" placeholder="Enter Admission Number or Student Name..." 
                           class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 text-sm">
                    <button onclick="searchStudentMarks()" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center text-sm">
                        <i class="fas fa-search mr-2"></i> Search
                    </button>
                    <button onclick="clearSearch()" class="bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600 text-sm">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Results -->
                <div id="studentResultsContainer" class="hidden">
                    <div id="studentSummaryCard" class="student-summary-card">
                        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4">
                            <div>
                                <h3 id="studentNameDisplay" class="text-xl font-bold">-</h3>
                                <p id="studentIdDisplay" class="text-white/80 text-sm">Admission No: -</p>
                                <p id="studentProgramDisplay" class="text-white/80 text-sm">Program: KRCHN</p>
                            </div>
                            <div class="mt-2 md:mt-0 flex gap-2">
                                <span id="overallGradeDisplay" class="grade-badge grade-a text-sm px-4 py-2">-</span>
                                <span id="gpaDisplay" class="grade-badge bg-white text-blue-800 text-sm px-4 py-2">GPA: 0.0</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div class="stat-box"><div class="stat-value" id="totalExamsCount">0</div><div class="stat-label">Exams</div></div>
                            <div class="stat-box"><div class="stat-value" id="averageMarkDisplay">0.0</div><div class="stat-label">Average</div></div>
                            <div class="stat-box"><div class="stat-value" id="totalPointsDisplay">0</div><div class="stat-label">Points</div></div>
                            <div class="stat-box"><div class="stat-value" id="gpaValueDisplay">0.0</div><div class="stat-label">GPA</div></div>
                        </div>
                        
                        <!-- Transcript Actions -->
                        <div class="flex gap-2 mt-4 flex-wrap">
                            <button onclick="downloadOfficialTranscriptPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm flex items-center gap-2">
                                <i class="fas fa-file-pdf"></i> Official Transcript
                            </button>
                            <button onclick="downloadTranscriptExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm flex items-center gap-2">
                                <i class="fas fa-file-excel"></i> Excel Transcript
                            </button>
                            <button onclick="printOfficialTranscript()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-file-alt text-blue-600 mr-2"></i> Detailed Results
                    </h3>
                    <div id="studentResultsTable" class="overflow-x-auto bg-white rounded-lg border max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="space-y-6">
                <div class="portal-card">
                    <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-upload text-green-600 mr-2"></i> Upload Excel
                    </h2>
                    <div onclick="document.getElementById('excelUpload').click()"
                         class="border-3 border-dashed border-blue-300 rounded-xl p-6 text-center cursor-pointer hover:border-blue-500 bg-blue-50 transition">
                        <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-2"></i>
                        <p class="text-gray-700 text-sm font-medium">Click to Upload</p>
                        <p class="text-gray-500 text-xs mt-1">.xlsx, .xls, .csv</p>
                        <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelUpload(this)">
                    </div>
                </div>

                <div id="filePreviewSection" class="hidden portal-card">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800 text-sm">Preview</h3>
                        <button onclick="closeFilePreview()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="filePreview" class="overflow-x-auto text-sm"></div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button onclick="publishFile()" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 text-sm">
                            <i class="fas fa-cloud-upload-alt mr-1"></i> Publish
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shared Files -->
            <div class="portal-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fas fa-folder-open text-purple-600 mr-2"></i> Shared Files
                    </h2>
                    <div class="flex gap-2">
                        <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs">
                            <span id="filteredFileCount">0</span> files
                        </span>
                    </div>
                </div>
                <div id="sharedFilesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== UTILITIES ==========
        let toastTimeout;
        function showToast(message, type = 'success', duration = 3000) {
            if (toastTimeout) clearTimeout(toastTimeout);
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle text-green-600' : type === 'error' ? 'fa-exclamation-circle text-red-600' : 'fa-info-circle text-blue-600'} text-sm"></i><span class="text-sm">${message}</span>`;
            document.body.appendChild(toast);
            
            toastTimeout = setTimeout(() => toast.remove(), duration);
        }

        let loadingTimeout;
        function showLoading(message = 'Loading...', showProgress = false, timeoutMs = 60000) {
            if (loadingTimeout) clearTimeout(loadingTimeout);
            document.getElementById('loadingMessage').innerText = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('debugInfo').innerHTML = '';
            if (showProgress) {
                document.getElementById('progressContainer').style.display = 'block';
                updateProgress(0);
            } else {
                document.getElementById('progressContainer').style.display = 'none';
            }
            
            loadingTimeout = setTimeout(() => {
                if (document.getElementById('loadingOverlay').style.display === 'flex') {
                    hideLoading();
                    showToast('Operation timed out', 'error');
                    debugLog('âŒ OPERATION TIMED OUT');
                }
            }, timeoutMs);
        }
        
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').innerText = Math.round(percent) + '%';
        }
        
        function hideLoading() { 
            document.getElementById('loadingOverlay').style.display = 'none'; 
            if (loadingTimeout) clearTimeout(loadingTimeout);
        }

        function debugLog(message) {
            const time = new Date().toLocaleTimeString();
            const log = `[${time}] ${message}`;
            console.log(log);
            
            const debugEl = document.getElementById('debugInfo');
            if (debugEl && document.getElementById('loadingOverlay').style.display === 'flex') {
                debugEl.innerHTML += `<div>${log}</div>`;
                debugEl.scrollTop = debugEl.scrollHeight;
            }
        }

          // ========== GRADE FUNCTION ==========
        function getGrade(mark) {
            if (mark >= 85) return { 
                grade: 'A', 
                points: 4, 
                status: 'DISTINCTION', 
                class: 'grade-a', 
                pass: true,
                color: 'mark-excellent'
            };
            if (mark >= 75) return { 
                grade: 'B', 
                points: 3, 
                status: 'CREDIT', 
                class: 'grade-b', 
                pass: true,
                color: 'mark-good'
            };
            if (mark >= 60) return { 
                grade: 'C', 
                points: 2, 
                status: 'PASS', 
                class: 'grade-c', 
                pass: true,
                color: 'mark-average'
            };
            return { 
                grade: 'D', 
                points: 0, 
                status: 'FAIL', 
                class: 'grade-d', 
                pass: false,
                color: 'mark-fail'
            };
        }

        // ========== UNIVERSAL EXCEL PARSER - HANDLES ANY EXCEL STRUCTURE ==========
        const ExcelParser = {
            
            // Main function to parse any Excel file
            parseWorkbook(workbook, fileId, filename) {
                const allRecords = [];
                const sheetNames = workbook.SheetNames;
                
                console.log(`ðŸ“š Parsing workbook: ${filename} with ${sheetNames.length} sheets`);
                
                sheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const records = this.parseSheet(worksheet, sheetName, filename, fileId);
                    allRecords.push(...records);
                });
                
                console.log(`âœ… Extracted ${allRecords.length} student records from ${filename}`);
                return allRecords;
            },

            // Parse a single sheet
            parseSheet(worksheet, sheetName, filename, fileId) {
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                if (jsonData.length < 2) return [];
                
                // Detect the structure of this sheet
                const structure = this.detectStructure(jsonData, sheetName, filename);
                if (!structure) return [];
                
                console.log(`ðŸ“Š Sheet "${sheetName}" detected as: ${structure.type} (confidence: ${structure.confidence}%)`);
                
                const headerRow = structure.headerRow;
                const headers = jsonData[headerRow].map(h => String(h || '').trim());
                const records = [];
                
                // Process each data row
                for (let r = headerRow + 1; r < jsonData.length; r++) {
                    const row = jsonData[r];
                    if (!row || row.length === 0) continue;
                    
                    // Skip empty rows
                    let hasData = false;
                    for (let c = 0; c < row.length; c++) {
                        if (row[c] && String(row[c]).trim() !== '') {
                            hasData = true;
                            break;
                        }
                    }
                    if (!hasData) continue;
                    
                    // Extract student information using detected columns
                    const studentInfo = this.extractStudentInfo(row, headers, structure);
                    if (!studentInfo.studentName) continue; // Skip if no student name
                    
                    // Extract marks based on structure type
                    const marks = this.extractMarks(row, headers, structure, sheetName);
                    
                    if (marks.length > 0) {
                        records.push({
                            fileId: fileId,
                            filename: filename,
                            sheetName: sheetName,
                            studentName: studentInfo.studentName,
                            studentId: studentInfo.studentId,
                            indexNumber: studentInfo.indexNumber,
                            rawData: this.rowToObject(row, headers),
                            marks: marks,
                            structure: structure.type
                        });
                    }
                }
                
                return records;
            },

            // Detect the structure of the Excel sheet
            detectStructure(jsonData, sheetName, filename) {
                if (jsonData.length < 2) return null;
                
                // Find header row
                let headerRow = -1;
                for (let i = 0; i < Math.min(15, jsonData.length); i++) {
                    const row = jsonData[i];
                    if (!row) continue;
                    
                    const rowStr = row.join(' ').toLowerCase();
                    if (rowStr.includes('name') || rowStr.includes('student') || 
                        rowStr.includes('admission') || rowStr.includes('adm') ||
                        rowStr.includes('marks') || rowStr.includes('score') ||
                        rowStr.includes('grade') || rowStr.includes('cat') ||
                        rowStr.includes('ebe') || rowStr.includes('final')) {
                        headerRow = i;
                        break;
                    }
                }
                
                if (headerRow === -1) return null;
                
                const headers = jsonData[headerRow].map(h => String(h || '').toLowerCase().trim());
                
                // Initialize structure
                const structure = {
                    type: 'unknown',
                    headerRow: headerRow,
                    confidence: 0,
                    studentNameCol: -1,
                    studentIdCol: -1,
                    indexCol: -1,
                    catCols: [],
                    ebeCols: [],
                    finalCols: [],
                    practicalCols: [],
                    theoryCols: [],
                    clinicalCols: [],
                    otherMarkCols: [],
                    isClinical: false,
                    isTheory: false,
                    subjectName: this.detectSubjectName(sheetName, filename)
                };
                
                // Analyze each column
                headers.forEach((header, idx) => {
                    if (!header) return;
                    
                    // Student identification
                    if (header.includes('name') || header.includes('student') || header.includes('candidate')) {
                        structure.studentNameCol = idx;
                        structure.confidence += 15;
                    }
                    if (header.includes('admission') || header.includes('adm') || 
                        header.includes('reg no') || header.includes('registration')) {
                        structure.studentIdCol = idx;
                        structure.confidence += 10;
                    }
                    if (header.includes('index') || header.includes('s/no') || 
                        header.includes('sn') || header.includes('serial') || header.includes('no.')) {
                        structure.indexCol = idx;
                        structure.confidence += 5;
                    }
                    
                    // Assessment types
                    if (header.includes('cat') || header.includes('continuous')) {
                        structure.catCols.push(idx);
                        structure.confidence += 8;
                    }
                    if (header.includes('ebe') || header.includes('end term') || header.includes('end of term') || header.includes('endterm')) {
                        structure.ebeCols.push(idx);
                        structure.confidence += 8;
                    }
                    if (header.includes('final') || header.includes('total') || 
                        header.includes('score') || header.includes('marks %') ||
                        header.includes('percentage') || header.includes('result') ||
                        header.includes('final marks') || header.includes('final %')) {
                        structure.finalCols.push(idx);
                        structure.confidence += 20; // HIGH confidence for final marks
                    }
                    if (header.includes('practical') || header.includes('clinical') || 
                        header.includes('rotation') || header.includes('ward') ||
                        header.includes('rotation')) {
                        structure.practicalCols.push(idx);
                        structure.clinicalCols.push(idx);
                        structure.confidence += 10;
                    }
                    
                    // Theory subjects (by common subject names)
                    const theorySubjects = [
                        'midwifery', 'pharmacology', 'paediatrics', 'medsurg',
                        'medical surgical', 'community health', 'hematological',
                        'respiratory', 'cardiovascular', 'immunization', 'trauma',
                        'srh', 'reproductive health', 'psychiatry', 'mental health',
                        'research', 'block', 'paper', 'unit'
                    ];
                    
                    for (const subject of theorySubjects) {
                        if (header.includes(subject)) {
                            structure.theoryCols.push(idx);
                            structure.confidence += 12;
                            break;
                        }
                    }
                });
                
                // Check sample data to identify mark columns
                const sampleRow = jsonData[headerRow + 1];
                if (sampleRow) {
                    headers.forEach((header, idx) => {
                        if (sampleRow[idx] && !isNaN(parseFloat(sampleRow[idx]))) {
                            const value = parseFloat(sampleRow[idx]);
                            if (value > 0 && value <= 100) {
                                // This is likely a mark column
                                if (!structure.catCols.includes(idx) && 
                                    !structure.ebeCols.includes(idx) &&
                                    !structure.finalCols.includes(idx) &&
                                    !structure.practicalCols.includes(idx) &&
                                    !structure.theoryCols.includes(idx)) {
                                    structure.otherMarkCols.push(idx);
                                }
                            }
                        }
                    });
                }
                
                // Determine file type based on sheet name and filename
                const sheetLower = sheetName.toLowerCase();
                const fileLower = filename.toLowerCase();
                
                if (sheetLower.includes('clinical') || sheetLower.includes('rotation') || 
                    fileLower.includes('clinical') || fileLower.includes('rotation') ||
                    sheetLower.includes('xy forms') || sheetLower.includes('case study')) {
                    structure.isClinical = true;
                    structure.type = 'clinical';
                    structure.confidence += 20;
                }
                
                if (sheetLower.includes('theory') || sheetLower.includes('block') || 
                    fileLower.includes('theory') || fileLower.includes('paper') ||
                    sheetLower.includes('cat') || sheetLower.includes('exam') ||
                    sheetLower.includes('midwifery') || sheetLower.includes('pharmacology')) {
                    structure.isTheory = true;
                    structure.type = 'theory';
                    structure.confidence += 20;
                }
                
                // If we have both clinical and theory indicators, it's combined
                if (structure.isClinical && structure.isTheory) {
                    structure.isCombined = true;
                    structure.type = 'combined';
                }
                
                // If no specific type but has mark columns
                if (structure.type === 'unknown' && (structure.finalCols.length > 0 || structure.catCols.length > 0)) {
                    structure.type = 'generic_marks';
                    structure.confidence += 10;
                }
                
                return structure;
            },

            // Extract student information from row
            extractStudentInfo(row, headers, structure) {
                let studentName = '';
                let studentId = '';
                let indexNumber = '';
                
                // Get student name
                if (structure.studentNameCol !== -1 && row[structure.studentNameCol]) {
                    studentName = String(row[structure.studentNameCol]).trim();
                } else {
                    // Try to find name in first few columns
                    for (let i = 0; i < Math.min(3, row.length); i++) {
                        const cell = row[i];
                        if (cell) {
                            const val = String(cell).trim();
                            if (val.length > 3 && !val.match(/^\d+$/)) {
                                studentName = val;
                                break;
                            }
                        }
                    }
                }
                
                // Get student ID
                if (structure.studentIdCol !== -1 && row[structure.studentIdCol]) {
                    studentId = String(row[structure.studentIdCol]).trim();
                }
                
                // Get index number
                if (structure.indexCol !== -1 && row[structure.indexCol]) {
                    indexNumber = String(row[structure.indexCol]).trim();
                }
                
                return { studentName, studentId, indexNumber };
            },

            // Extract marks from row
            extractMarks(row, headers, structure, sheetName) {
                const marks = [];
                
                // Helper to add a mark
                const addMark = (colIdx, type, category) => {
                    const header = headers[colIdx];
                    const cellValue = row[colIdx];
                    
                    if (cellValue && !isNaN(parseFloat(cellValue))) {
                        const numValue = parseFloat(cellValue);
                        if (numValue > 0 && numValue <= 100) {
                            marks.push({
                                subject: structure.subjectName || sheetName,
                                assessmentType: type,
                                mark: numValue,
                                grade: getGrade(numValue),
                                originalColumn: header,
                                category: category,
                                isFinal: type === 'FINAL'
                            });
                        }
                    }
                };
                
                // ALWAYS prioritize FINAL marks
                if (structure.finalCols.length > 0) {
                    structure.finalCols.forEach(colIdx => {
                        addMark(colIdx, 'FINAL', 'final');
                    });
                }
                
                // Then EBE marks
                if (structure.ebeCols.length > 0) {
                    structure.ebeCols.forEach(colIdx => {
                        addMark(colIdx, 'EBE', 'ebe');
                    });
                }
                
                // Then CAT marks
                if (structure.catCols.length > 0) {
                    structure.catCols.forEach(colIdx => {
                        addMark(colIdx, 'CAT', 'cat');
                    });
                }
                
                // Then practical/clinical marks
                if (structure.practicalCols.length > 0) {
                    structure.practicalCols.forEach(colIdx => {
                        addMark(colIdx, 'PRACTICAL', 'practical');
                    });
                }
                
                // Finally, any other mark columns
                if (structure.otherMarkCols.length > 0) {
                    structure.otherMarkCols.forEach(colIdx => {
                        addMark(colIdx, 'EXAM', 'other');
                    });
                }
                
                return marks;
            },

            // Detect subject name from sheet or filename
            detectSubjectName(sheetName, filename) {
                // Common subject patterns
                const subjects = {
                    'midwifery': 'MIDWIFERY',
                    'pharmacology': 'PHARMACOLOGY',
                    'paediatrics': 'PAEDIATRICS',
                    'medsurg': 'MEDICAL SURGICAL',
                    'medical surgical': 'MEDICAL SURGICAL',
                    'community': 'COMMUNITY HEALTH',
                    'hematological': 'HEMATOLOGICAL',
                    'respiratory': 'RESPIRATORY',
                    'cardiovascular': 'CARDIOVASCULAR',
                    'immunization': 'IMMUNIZATION',
                    'trauma': 'TRAUMA',
                    'srh': 'SRH',
                    'reproductive': 'REPRODUCTIVE HEALTH',
                    'psychiatry': 'PSYCHIATRY',
                    'mental': 'MENTAL HEALTH',
                    'research': 'RESEARCH',
                    'block': 'BLOCK'
                };
                
                const combined = (sheetName + ' ' + filename).toLowerCase();
                
                for (const [key, value] of Object.entries(subjects)) {
                    if (combined.includes(key)) {
                        return value;
                    }
                }
                
                // If no subject detected, use sheet name
                return sheetName;
            },

            // Convert row to object with headers as keys
            rowToObject(row, headers) {
                const obj = {};
                headers.forEach((header, idx) => {
                    if (header && row[idx] !== undefined) {
                        obj[header] = row[idx];
                    }
                });
                return obj;
            }
        };

        // ========== FIXED SEARCH FUNCTION - ALWAYS USES FINAL MARK ==========
        function searchStudentMarks() {
            const searchTerm = document.getElementById('studentSearchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                showToast('Please enter a search term', 'error');
                return;
            }
            
            showLoading('Searching across all files...', false, 30000);
            
            try {
                console.log('ðŸ” Searching for:', searchTerm);
                console.log('Total records:', allStudentMarks.length);
                
                // Find ALL records for this student
                let studentRecords = [];
                let studentName = '';
                let studentId = '';
                let studentIndex = '';
                
                allStudentMarks.forEach(record => {
                    let matches = false;
                    
                    // Check name
                    if (record.studentName) {
                        const nameLower = record.studentName.toLowerCase();
                        if (nameLower.includes(searchTerm)) {
                            matches = true;
                            if (!studentName) studentName = record.studentName;
                        }
                    }
                    
                    // Check ID
                    if (record.studentId) {
                        const idLower = record.studentId.toLowerCase();
                        if (idLower.includes(searchTerm)) {
                            matches = true;
                            if (!studentId) studentId = record.studentId;
                        }
                    }
                    
                    // Check index
                    if (record.indexNumber) {
                        const indexLower = record.indexNumber.toLowerCase();
                        if (indexLower.includes(searchTerm)) {
                            matches = true;
                            if (!studentIndex) studentIndex = record.indexNumber;
                        }
                    }
                    
                    // Check raw data
                    if (!matches && record.rawData) {
                        Object.values(record.rawData).forEach(value => {
                            const valStr = String(value || '').toLowerCase();
                            if (valStr.includes(searchTerm)) {
                                matches = true;
                            }
                        });
                    }
                    
                    if (matches) {
                        studentRecords.push(record);
                    }
                });
                
                console.log(`ðŸ“Š Found ${studentRecords.length} records for this student`);
                
                if (studentRecords.length === 0) {
                    hideLoading();
                    showToast('No results found', 'info');
                    document.getElementById('studentResultsContainer').classList.add('hidden');
                    return;
                }
                
                // Organize marks by subject
                const theorySubjects = new Map();
                const clinicalMarks = [];
                
                studentRecords.forEach(record => {
                    const subjectName = record.structure?.subjectName || record.sheetName;
                    const isTheory = record.structure?.isTheory || 
                                    record.filename.includes('BLOCK') ||
                                    record.filename.includes('PAPER') ||
                                    record.filename.includes('RESEARCH');
                    
                    if (record.marks && record.marks.length > 0) {
                        record.marks.forEach(mark => {
                            // Skip header rows
                            if (!mark.subject || mark.subject.toLowerCase().includes('s/no')) return;
                            
                            if (isTheory || !mark.subject.includes('Clinical')) {
                                // Theory subject
                                if (!theorySubjects.has(subjectName)) {
                                    theorySubjects.set(subjectName, {
                                        name: subjectName,
                                        catMarks: [],
                                        ebeMarks: [],
                                        finalMarks: [],
                                        allMarks: [],
                                        files: new Set(),
                                        sourceFile: record.filename
                                    });
                                }
                                
                                const subject = theorySubjects.get(subjectName);
                                subject.files.add(record.filename);
                                
                                // Categorize by assessment type
                                if (mark.assessmentType === 'CAT') {
                                    subject.catMarks.push(mark.mark);
                                } else if (mark.assessmentType === 'EBE') {
                                    subject.ebeMarks.push(mark.mark);
                                } else if (mark.assessmentType === 'FINAL' || mark.isFinal) {
                                    subject.finalMarks.push(mark.mark);
                                } else {
                                    // Check column name
                                    const colName = (mark.originalColumn || '').toLowerCase();
                                    if (colName.includes('final') || colName.includes('total') || colName.includes('%')) {
                                        subject.finalMarks.push(mark.mark);
                                    } else if (colName.includes('ebe')) {
                                        subject.ebeMarks.push(mark.mark);
                                    } else if (colName.includes('cat')) {
                                        subject.catMarks.push(mark.mark);
                                    } else {
                                        subject.allMarks.push(mark.mark);
                                    }
                                }
                            } else {
                                // Clinical mark
                                clinicalMarks.push({
                                    name: mark.subject,
                                    mark: mark.mark,
                                    grade: getGrade(mark.mark),
                                    assessmentType: mark.assessmentType,
                                    sheetName: record.sheetName,
                                    filename: record.filename,
                                    passed: mark.mark >= 60
                                });
                            }
                        });
                    }
                });
                
                // Calculate final scores - ALWAYS USE FINAL MARK
                const theorySubjectsList = [];
                theorySubjects.forEach((subject, name) => {
                    // Get unique marks
                    const uniqueCat = [...new Set(subject.catMarks)];
                    const uniqueEbe = [...new Set(subject.ebeMarks)];
                    const uniqueFinal = [...new Set(subject.finalMarks)];
                    const uniqueAll = [...new Set(subject.allMarks)];
                    
                    // PRIORITY 1: Use FINAL marks
                    let finalScore = null;
                    if (uniqueFinal.length > 0) {
                        // Sort descending and take the highest
                        uniqueFinal.sort((a, b) => b - a);
                        finalScore = uniqueFinal[0];
                        console.log(`âœ… Using FINAL mark: ${finalScore} for ${name}`);
                    }
                    // PRIORITY 2: Use EBE if no FINAL
                    else if (uniqueEbe.length > 0) {
                        uniqueEbe.sort((a, b) => b - a);
                        finalScore = uniqueEbe[0];
                        console.log(`âš ï¸ Using EBE as final: ${finalScore} for ${name}`);
                    }
                    // PRIORITY 3: Use CAT if no FINAL/EBE
                    else if (uniqueCat.length > 0) {
                        uniqueCat.sort((a, b) => b - a);
                        finalScore = uniqueCat[0];
                        console.log(`âš ï¸ Using CAT as final: ${finalScore} for ${name}`);
                    }
                    // PRIORITY 4: Use any other marks
                    else if (uniqueAll.length > 0) {
                        uniqueAll.sort((a, b) => b - a);
                        finalScore = uniqueAll[0];
                        console.log(`âš ï¸ Using other mark as final: ${finalScore} for ${name}`);
                    }
                    
                    if (finalScore !== null) {
                        const grade = getGrade(finalScore);
                        const passed = finalScore >= 60;
                        
                        theorySubjectsList.push({
                            name: name,
                            catMarks: uniqueCat,
                            ebeMarks: uniqueEbe,
                            finalMarks: uniqueFinal,
                            finalScore: finalScore,
                            grade: grade,
                            passed: passed,
                            sourceFile: subject.sourceFile
                        });
                    }
                });
                
                // Sort subjects
                theorySubjectsList.sort((a, b) => a.name.localeCompare(b.name));
                
                // Calculate statistics
                const totalTheoryScore = theorySubjectsList.reduce((sum, s) => sum + s.finalScore, 0);
                const avgOverall = theorySubjectsList.length > 0 ? totalTheoryScore / theorySubjectsList.length : 0;
                const totalPoints = theorySubjectsList.reduce((sum, s) => sum + s.grade.points, 0);
                const gpa = theorySubjectsList.length > 0 ? (totalPoints / theorySubjectsList.length).toFixed(2) : '0.00';
                const overallGrade = getGrade(avgOverall);
                
                // Store for transcript
                currentTranscriptData = {
                    studentName: studentName,
                    studentId: studentId,
                    studentIndex: studentIndex,
                    theorySubjects: theorySubjectsList,
                    clinicalMarks: clinicalMarks,
                    avgOverall: avgOverall,
                    overallGrade: overallGrade,
                    gpa: gpa,
                    totalPoints: totalPoints
                };
                
                // Update display
                updateStudentDisplay(studentName, studentId, studentIndex, overallGrade, gpa,
                                   theorySubjectsList.length, avgOverall, totalPoints,
                                   theorySubjectsList, clinicalMarks, studentRecords);
                
                hideLoading();
                showToast(`Found ${theorySubjectsList.length} theory subjects and ${clinicalMarks.length} clinical assessments`, 'success');
                
            } catch (error) {
                console.error('Search error:', error);
                hideLoading();
                showToast('Error searching: ' + error.message, 'error');
            }
        }

        // Helper to update display (keep your existing updateStudentDisplay function)
        function updateStudentDisplay(studentName, studentId, studentIndex, overallGrade, gpa,
                                     theoryCount, avgOverall, totalPoints,
                                     theorySubjectsList, clinicalMarks, records) {
            
            document.getElementById('studentNameDisplay').innerText = studentName;
            
            let idDisplay = `Admission: ${studentId || 'N/A'}`;
            if (studentIndex && studentIndex !== studentId) {
                idDisplay += ` | Index: ${studentIndex}`;
            }
            document.getElementById('studentIdDisplay').innerHTML = `<i class="fas fa-id-card mr-1"></i>${idDisplay}`;
            document.getElementById('studentProgramDisplay').innerHTML = `<i class="fas fa-graduation-cap mr-1"></i>Program: KRCHN`;
            
            document.getElementById('overallGradeDisplay').innerText = `Grade: ${overallGrade.grade}`;
            document.getElementById('overallGradeDisplay').className = `grade-badge ${overallGrade.class} text-sm px-4 py-2`;
            
            document.getElementById('gpaDisplay').innerHTML = `<i class="fas fa-star mr-1"></i>GPA: ${gpa}`;
            document.getElementById('totalExamsCount').innerText = theoryCount;
            document.getElementById('averageMarkDisplay').innerText = avgOverall.toFixed(1);
            document.getElementById('totalPointsDisplay').innerText = totalPoints;
            document.getElementById('gpaValueDisplay').innerText = gpa;
            
            // Build the results table
            let tableHtml = '';
            
            // Theory subjects table
            if (theorySubjectsList.length > 0) {
                tableHtml += `
                    <div class="mb-6">
                        <h4 class="font-bold text-blue-800 mb-2 text-lg">ðŸ“š THEORY SUBJECTS (${theorySubjectsList.length})</h4>
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>CAT</th>
                                    <th>EBE</th>
                                    <th>FINAL</th>
                                    <th>Final Score</th>
                                    <th>Grade</th>
                                    <th>Points</th>
                                    <th>Status</th>
                                    <th>Source</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                theorySubjectsList.forEach(s => {
                    const catDisplay = s.catMarks.length > 0 ? s.catMarks.map(m => m.toFixed(1)).join(', ') : '-';
                    const ebeDisplay = s.ebeMarks.length > 0 ? s.ebeMarks.map(m => m.toFixed(1)).join(', ') : '-';
                    const finalDisplay = s.finalMarks.length > 0 ? s.finalMarks.map(m => m.toFixed(1)).join(', ') : '-';
                    
                    tableHtml += `
                        <tr class="${s.passed ? '' : 'bg-red-50'}">
                            <td class="font-medium">${s.name}</td>
                            <td class="text-center">${catDisplay}</td>
                            <td class="text-center">${ebeDisplay}</td>
                            <td class="text-center font-bold">${finalDisplay}</td>
                            <td class="font-bold ${s.grade.color} text-center">${s.finalScore.toFixed(1)}</td>
                            <td class="text-center"><span class="grade-badge ${s.grade.class}">${s.grade.grade}</span></td>
                            <td class="text-center">${s.grade.points}</td>
                            <td class="text-center"><span class="status-badge ${s.passed ? 'status-pass' : 'status-fail'}">${s.passed ? 'PASS' : 'FAIL'}</span></td>
                            <td class="text-xs">${s.sourceFile ? s.sourceFile.substring(0, 15) + '...' : '-'}</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                </div>
                `;
            }
            
            // Clinical marks table
            if (clinicalMarks.length > 0) {
                tableHtml += `
                    <div class="mb-6">
                        <h4 class="font-bold text-green-800 mb-2 text-lg">ðŸ¥ CLINICAL ROTATIONS & ASSESSMENTS (${clinicalMarks.length})</h4>
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th>Assessment/Rotation</th>
                                    <th>Mark</th>
                                    <th>Grade</th>
                                    <th>Points</th>
                                    <th>Status</th>
                                    <th>Source Sheet</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                clinicalMarks.forEach(m => {
                    tableHtml += `
                        <tr class="${m.passed ? '' : 'bg-red-50'}">
                            <td class="font-medium">${m.name}</td>
                            <td class="font-bold ${m.grade.color} text-center">${m.mark.toFixed(1)}</td>
                            <td class="text-center"><span class="grade-badge ${m.grade.class}">${m.grade.grade}</span></td>
                            <td class="text-center">${m.grade.points}</td>
                            <td class="text-center"><span class="status-badge ${m.passed ? 'status-pass' : 'status-fail'}">${m.passed ? 'PASS' : 'FAIL'}</span></td>
                            <td class="text-xs">${m.sheetName}</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                </div>
                `;
            }
            
            // Summary stats
            const theoryPassCount = theorySubjectsList.filter(s => s.passed).length;
            const theoryFailCount = theorySubjectsList.length - theoryPassCount;
            const clinicalPassCount = clinicalMarks.filter(m => m.passed).length;
            const clinicalFailCount = clinicalMarks.length - clinicalPassCount;
            
            tableHtml += `
                <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-600">Theory Subjects</div>
                        <div class="text-xl font-bold">${theorySubjectsList.length}</div>
                        <div class="text-xs"><span class="text-green-600">${theoryPassCount} pass</span> | <span class="text-red-600">${theoryFailCount} fail</span></div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-600">Clinical Assessments</div>
                        <div class="text-xl font-bold">${clinicalMarks.length}</div>
                        <div class="text-xs"><span class="text-green-600">${clinicalPassCount} pass</span> | <span class="text-red-600">${clinicalFailCount} fail</span></div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-600">Total Marks</div>
                        <div class="text-xl font-bold">${theorySubjectsList.reduce((sum, s) => sum + s.catMarks.length + s.ebeMarks.length + s.finalMarks.length, 0) + clinicalMarks.length}</div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg">
                        <div class="text-xs text-gray-600">GPA (Theory)</div>
                        <div class="text-xl font-bold">${gpa}</div>
                    </div>
                </div>
            `;
            
            // File sources
            const fileMap = new Map();
            records.forEach(r => {
                const key = r.filename || 'Unknown';
                if (!fileMap.has(key)) {
                    fileMap.set(key, new Set());
                }
                fileMap.get(key).add(r.sheetName || 'Sheet');
            });
            
            tableHtml += `
                <div class="mt-4 p-3 bg-gray-100 rounded-lg text-xs">
                    <details open>
                        <summary class="font-semibold cursor-pointer mb-2">
                            ðŸ“Š Data Sources (${fileMap.size} files, ${records.length} records)
                        </summary>
                        <div class="max-h-40 overflow-y-auto">
                            <ul class="list-disc list-inside space-y-1">
                                ${Array.from(fileMap.entries()).map(([file, sheets]) => 
                                    `<li class="text-gray-700">${file} <span class="bg-blue-100 text-blue-800 px-1 rounded">${sheets.size} sheet(s)</span></li>`
                                ).join('')}
                            </ul>
                        </div>
                    </details>
                </div>
            `;
            
            document.getElementById('studentResultsTable').innerHTML = tableHtml;
            document.getElementById('studentResultsContainer').classList.remove('hidden');
        }

        // ========== GOOGLE SHEETS FUNCTIONS ==========
        let tokenClient;
        let googleAccessToken = null;
        let tokenPromiseResolve = null;

        function initGoogleAPI() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive',
                callback: (tokenResponse) => {
                    if (tokenResponse.error) {
                        console.error('Token error:', tokenResponse);
                        showToast('Authentication failed: ' + tokenResponse.error, 'error');
                        if (tokenPromiseResolve) {
                            tokenPromiseResolve(false);
                            tokenPromiseResolve = null;
                        }
                        return;
                    }
                    
                    googleAccessToken = tokenResponse.access_token;
                    console.log('Google token acquired');
                    
                    if (tokenPromiseResolve) {
                        tokenPromiseResolve(true);
                        tokenPromiseResolve = null;
                    }
                },
            });
            
            console.log('Google Identity Services initialized');
        }

        async function ensureGoogleAuth() {
            if (googleAccessToken) {
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + googleAccessToken);
                    if (response.ok) {
                        return true;
                    }
                } catch (e) {
                    googleAccessToken = null;
                }
            }
            
            return new Promise((resolve) => {
                tokenPromiseResolve = resolve;
                tokenClient.requestAccessToken();
            });
        }

        // ========== AUTO-SYNC FUNCTIONS ==========
        function startAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
            
            console.log('ðŸ”„ Auto-sync started - checking for changes every 30 seconds');
            showSheetNotification('ðŸ”„ Auto-sync enabled - Changes will sync automatically', 'info', 3000);
            
            // Show indicator
            document.getElementById('autoSyncIndicator').style.display = 'flex';
            
            autoSyncInterval = setInterval(async () => {
                if (!currentGoogleSheetId || !currentGoogleSheetFileId) {
                    stopAutoSync();
                    return;
                }
                
                console.log('ðŸ” Checking for changes in Google Sheet...');
                
                try {
                    if (!await ensureGoogleAuth()) {
                        return;
                    }
                    
                    const metadataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}`, {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    });
                    
                    if (!metadataResponse.ok) return;
                    
                    const metadata = await metadataResponse.json();
                    
                    let currentDataString = '';
                    
                    for (const sheet of metadata.sheets) {
                        const sheetName = sheet.properties.title;
                        
                        const dataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}/values/${encodeURIComponent(sheetName)}`, {
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`
                            }
                        });
                        
                        if (dataResponse.ok) {
                            const data = await dataResponse.json();
                            currentDataString += JSON.stringify(data.values);
                        }
                    }
                    
                    const currentHash = btoa(currentDataString).substring(0, 50);
                    
                    if (lastDataHash === null) {
                        lastDataHash = currentHash;
                        return;
                    }
                    
                    if (lastDataHash !== currentHash) {
                        console.log('ðŸ”„ Changes detected! Auto-syncing...');
                        showSheetNotification('ðŸ“ Changes detected - Auto-syncing...', 'info', 2000);
                        
                        await performSync();
                        
                        lastDataHash = currentHash;
                    }
                    
                } catch (error) {
                    console.error('Auto-sync check failed:', error);
                }
            }, 30000);
        }

        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
                lastDataHash = null;
                console.log('ðŸ”„ Auto-sync stopped');
                document.getElementById('autoSyncIndicator').style.display = 'none';
            }
        }

        async function performSync() {
            try {
                const metadataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}`, {
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    }
                });
                
                if (!metadataResponse.ok) {
                    throw new Error('Failed to fetch spreadsheet metadata');
                }
                
                const metadata = await metadataResponse.json();
                
                const workbook = XLSX.utils.book_new();
                
                for (const sheet of metadata.sheets) {
                    const sheetName = sheet.properties.title;
                    
                    const dataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}/values/${encodeURIComponent(sheetName)}`, {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    });
                    
                    if (dataResponse.ok) {
                        const data = await dataResponse.json();
                        
                        if (data.values) {
                            const worksheet = XLSX.utils.aoa_to_sheet(data.values);
                            XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                        }
                    }
                }
                
                const wbData = XLSX.write(workbook, { type: 'base64' });
                
                const { error } = await supabase
                    .from('shared_excel_files')
                    .update({
                        file_data: wbData,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentGoogleSheetFileId);
                
                if (error) throw error;
                
                showSheetNotification('âœ… Auto-sync complete! Database updated', 'success');
                loadAllStudentMarks();
                
            } catch (error) {
                console.error('Auto-sync failed:', error);
                showSheetNotification('âŒ Auto-sync failed: ' + error.message, 'error');
            }
        }

        // ========== SHEET NOTIFICATION FUNCTIONS ==========
        function showSheetNotification(message, type = 'success', duration = 4000) {
            const existing = document.querySelector('.sheet-notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `sheet-notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            const modal = document.getElementById('googleSheetsEditor');
            if (modal) {
                modal.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, duration);
            } else {
                showToast(message, type);
            }
        }

        async function openInGoogleSheets(fileId) {
            if (currentRole !== 'admin' && currentRole !== 'super_admin') { 
                showToast('Admins only', 'error'); 
                return; 
            }
            
            const file = sharedFiles.find(f => f.id === fileId);
            if (!file) { 
                showToast('File not found', 'error'); 
                return; 
            }
            
            showLoading('Opening in Google Sheets...', true, 60000);
            
            try {
                if (!tokenClient) {
                    initGoogleAPI();
                }
                
                const isAuthenticated = await ensureGoogleAuth();
                if (!isAuthenticated) {
                    hideLoading();
                    return;
                }
                
                if (file.google_sheet_id) {
                    currentGoogleSheetId = file.google_sheet_id;
                    currentGoogleSheetFileId = fileId;
                    document.getElementById('googleSheetsFileName').innerText = file.filename;
                    document.getElementById('googleSheetIframe').src = `https://docs.google.com/spreadsheets/d/${file.google_sheet_id}/edit`;
                    document.getElementById('googleSheetsEditor').style.display = 'flex';
                    hideLoading();
                    showToast('Opened in Google Sheets', 'success');
                    startAutoSync();
                    return;
                }
                
                const binaryData = atob(file.file_data);
                const array = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    array[i] = binaryData.charCodeAt(i);
                }
                
                const workbook = XLSX.read(array, { type: 'array' });
                
                const createResponse = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        properties: {
                            title: file.filename
                        }
                    })
                });
                
                if (!createResponse.ok) {
                    const errorData = await createResponse.json();
                    throw new Error(errorData.error?.message || 'Failed to create spreadsheet');
                }
                
                const spreadsheet = await createResponse.json();
                const spreadsheetId = spreadsheet.spreadsheetId;
                
                console.log(`âœ… Created spreadsheet: ${spreadsheetId}`);
                
                // Get default sheet ID
                const sheetMetadataResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );
                const sheetMetadata = await sheetMetadataResponse.json();
                const defaultSheetId = sheetMetadata.sheets[0].properties.sheetId;
                
                // Populate each sheet
                for (let i = 0; i < workbook.SheetNames.length; i++) {
                    const sheetName = workbook.SheetNames[i];
                    const worksheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    console.log(`ðŸ“„ Processing sheet ${i+1}: "${sheetName}" with ${data.length} rows`);
                    
                    if (data.length > 0) {
                        try {
                            if (i === 0) {
                                console.log(`ðŸ“ Renaming default sheet to: "${sheetName}"`);
                                
                                const renameResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${googleAccessToken}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        requests: [{
                                            updateSheetProperties: {
                                                properties: {
                                                    sheetId: defaultSheetId,
                                                    title: sheetName
                                                },
                                                fields: 'title'
                                            }
                                        }]
                                    })
                                });
                                
                                if (!renameResponse.ok) {
                                    const errorText = await renameResponse.text();
                                    console.error('âŒ Failed to rename sheet:', errorText);
                                    throw new Error(`Failed to rename sheet to: ${sheetName}`);
                                }
                                console.log(`âœ… Sheet renamed to: "${sheetName}"`);
                                
                            } else {
                                console.log(`ðŸ“ Adding sheet: "${sheetName}"`);
                                
                                const addSheetResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${googleAccessToken}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        requests: [{
                                            addSheet: {
                                                properties: {
                                                    title: sheetName
                                                }
                                            }
                                        }]
                                    })
                                });
                                
                                if (!addSheetResponse.ok) {
                                    const errorText = await addSheetResponse.text();
                                    console.error('âŒ Failed to add sheet:', errorText);
                                    throw new Error(`Failed to create sheet: ${sheetName}`);
                                }
                                console.log(`âœ… Sheet added: "${sheetName}"`);
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                        } catch (sheetError) {
                            console.error('Error with sheet:', sheetError);
                            throw sheetError;
                        }
                        
                        // Prepare data
                        const cleanData = data.filter(row => row && row.some(cell => cell !== null && cell !== ''));
                        
                        if (cleanData.length === 0) continue;
                        
                        const maxCols = Math.max(...cleanData.map(row => row ? row.length : 0));
                        const paddedData = cleanData.map(row => {
                            const newRow = row ? [...row] : [];
                            while (newRow.length < maxCols) newRow.push('');
                            return newRow;
                        });
                        
                        // Calculate column letter
                        const colCount = maxCols;
                        let colLetter;
                        
                        if (colCount <= 26) {
                            colLetter = String.fromCharCode(64 + colCount);
                        } else {
                            const first = Math.floor((colCount - 1) / 26);
                            const second = (colCount - 1) % 26;
                            colLetter = String.fromCharCode(64 + first) + String.fromCharCode(65 + second);
                        }
                        
                        // Write data
                        const range = `${sheetName}!A1:${colLetter}${paddedData.length}`;
                        const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?valueInputOption=RAW`;
                        
                        console.log(`ðŸ“¤ Writing to URL: ${url}`);
                        
                        const writeResponse = await fetch(url, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                values: paddedData
                            })
                        });
                        
                        if (!writeResponse.ok) {
                            const errorText = await writeResponse.text();
                            console.error('âŒ Write failed:', errorText);
                            throw new Error(`Write failed: ${errorText.substring(0, 200)}`);
                        } else {
                            console.log(`âœ… Successfully wrote ${paddedData.length} rows to ${sheetName}`);
                        }
                    }
                }
                
                // Set permissions
                try {
                    await fetch(`https://www.googleapis.com/drive/v3/files/${spreadsheetId}/permissions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            role: 'writer',
                            type: 'anyone'
                        })
                    });
                    console.log('âœ… Set public permissions');
                } catch (permError) {
                    console.warn('Could not set public permissions:', permError);
                }
                
                // Save Google Sheet ID
                const { error } = await supabase
                    .from('shared_excel_files')
                    .update({ google_sheet_id: spreadsheetId })
                    .eq('id', fileId);
                
                if (error) {
                    console.error('Error saving Google Sheet ID:', error);
                    showToast('Sheet created but failed to save ID', 'warning');
                }
                
                currentGoogleSheetId = spreadsheetId;
                currentGoogleSheetFileId = fileId;
                document.getElementById('googleSheetsFileName').innerText = file.filename;
                document.getElementById('googleSheetIframe').src = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
                document.getElementById('googleSheetsEditor').style.display = 'flex';
                
                hideLoading();
                showToast('Google Sheet created with all sheets', 'success');
                
                // Start auto-sync
                startAutoSync();
                
            } catch (error) {
                console.error('âŒ Error opening in Google Sheets:', error);
                hideLoading();
                showToast('Error opening in Google Sheets: ' + error.message, 'error');
            }
        }

        async function syncFromGoogleSheets() {
            if (!currentGoogleSheetId || !currentGoogleSheetFileId) {
                showSheetNotification('No Google Sheet open', 'error');
                return;
            }
            
            showLoading('Syncing from Google Sheets...', true, 60000);
            
            try {
                if (!await ensureGoogleAuth()) {
                    hideLoading();
                    return;
                }
                
                const metadataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}`, {
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    }
                });
                
                if (!metadataResponse.ok) {
                    throw new Error('Failed to fetch spreadsheet metadata');
                }
                
                const metadata = await metadataResponse.json();
                
                const workbook = XLSX.utils.book_new();
                
                for (const sheet of metadata.sheets) {
                    const sheetName = sheet.properties.title;
                    
                    const dataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}/values/${encodeURIComponent(sheetName)}`, {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    });
                    
                    if (dataResponse.ok) {
                        const data = await dataResponse.json();
                        
                        if (data.values) {
                            const worksheet = XLSX.utils.aoa_to_sheet(data.values);
                            XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                        }
                    }
                }
                
                const wbData = XLSX.write(workbook, { type: 'base64' });
                
                const { error } = await supabase
                    .from('shared_excel_files')
                    .update({
                        file_data: wbData,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentGoogleSheetFileId);
                
                if (error) throw error;
                
                hideLoading();
                showSheetNotification('âœ… Synced successfully! Database updated.', 'success');
                
                // Update hash for auto-sync
                lastDataHash = null; // Will be recalculated on next check
                
                loadAllStudentMarks();
                
            } catch (error) {
                console.error('Error syncing from Google Sheets:', error);
                hideLoading();
                showSheetNotification('âŒ Sync failed: ' + error.message, 'error');
            }
        }

        function closeGoogleSheetsEditor() {
            document.getElementById('googleSheetsEditor').style.display = 'none';
            document.getElementById('googleSheetIframe').src = '';
            currentGoogleSheetId = null;
            currentGoogleSheetFileId = null;
            stopAutoSync();
        }

        // ========== VIEW FILE WITH MULTIPLE SHEETS ==========
        async function viewFile(fileId) {
            const file = sharedFiles.find(f => f.id === fileId);
            if (!file || !file.file_data) { 
                showToast('File not found', 'error'); 
                return; 
            }
            
            showLoading('Opening file...', false, 30000);
            
            try {
                const binaryData = atob(file.file_data);
                const array = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    array[i] = binaryData.charCodeAt(i);
                }
                
                const workbook = XLSX.read(array, { type: 'array' });
                const sheetNames = workbook.SheetNames;
                
                const viewerHtml = `
                    <div class="modal-overlay" id="viewerModal" style="display: flex;">
                        <div class="modal-content" style="max-width: 1400px;">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>
                                    ${file.filename}
                                </h2>
                                <button onclick="closeViewerModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="flex gap-1 overflow-x-auto pb-2 mb-3 border-b" style="scrollbar-width: thin;">
                                ${sheetNames.map((sheet, index) => `
                                    <button onclick="switchViewerSheet('${sheet.replace(/'/g, "\\'")}', ${index})" 
                                        id="sheet-tab-${index}"
                                        class="sheet-tab px-4 py-2 rounded-t-lg text-sm font-medium transition 
                                        ${index === 0 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                        <i class="fas fa-table mr-1"></i>
                                        ${sheet.length > 25 ? sheet.substr(0,22)+'...' : sheet}
                                    </button>
                                `).join('')}
                            </div>
                            
                            <div id="sheetDataContainer" class="overflow-x-auto" style="max-height: 60vh;">
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading sheet data...</p>
                                </div>
                            </div>
                            
                            <div class="mt-3 text-sm text-gray-600 flex justify-between items-center">
                                <span>
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="sheetInfo">${sheetNames.length} sheet(s) total</span>
                                </span>
                                <span id="rowCount" class="text-xs bg-gray-100 px-2 py-1 rounded"></span>
                            </div>
                            
                            <div class="mt-4 flex justify-end gap-2">
                                ${currentRole === 'admin' || currentRole === 'super_admin' ? 
                                    `<button onclick="openInGoogleSheets('${file.id}')" class="edit-sheets-btn">
                                        <i class="fab fa-google"></i> Edit in Google Sheets
                                        <i class="fas fa-external-link-alt" style="font-size: 12px; opacity: 0.8;"></i>
                                    </button>` : ''}
                                <button onclick="closeViewerModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('viewerModal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', viewerHtml);
                
                window.currentViewerWorkbook = workbook;
                window.currentViewerSheetNames = sheetNames;
                
                loadViewerSheet(0);
                
                hideLoading();
                
            } catch (error) {
                console.error('Error viewing file:', error);
                hideLoading();
                showToast('Error viewing file: ' + error.message, 'error');
            }
        }

        function closeViewerModal() {
            const modal = document.getElementById('viewerModal');
            if (modal) modal.remove();
            window.currentViewerWorkbook = null;
            window.currentViewerSheetNames = null;
        }

        function switchViewerSheet(sheetName, index) {
            const sheetCount = window.currentViewerSheetNames.length;
            for (let i = 0; i < sheetCount; i++) {
                const tab = document.getElementById(`sheet-tab-${i}`);
                if (tab) {
                    if (i === index) {
                        tab.className = 'sheet-tab px-4 py-2 rounded-t-lg text-sm font-medium transition bg-blue-600 text-white';
                    } else {
                        tab.className = 'sheet-tab px-4 py-2 rounded-t-lg text-sm font-medium transition bg-gray-200 text-gray-700 hover:bg-gray-300';
                    }
                }
            }
            
            loadViewerSheet(index);
        }

        function loadViewerSheet(index) {
            const container = document.getElementById('sheetDataContainer');
            if (!container) return;
            
            const workbook = window.currentViewerWorkbook;
            const sheetNames = window.currentViewerSheetNames;
            
            if (!workbook || !sheetNames || index >= sheetNames.length) {
                container.innerHTML = '<p class="text-center py-8 text-gray-500">Sheet not found</p>';
                return;
            }
            
            const sheetName = sheetNames[index];
            const worksheet = workbook.Sheets[sheetName];
            
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (!jsonData || jsonData.length === 0) {
                container.innerHTML = '<p class="text-center py-8 text-gray-500">No data in this sheet</p>';
                document.getElementById('rowCount').innerText = '0 rows';
                return;
            }
            
            document.getElementById('rowCount').innerText = `${jsonData.length - 1} data rows`;
            document.getElementById('sheetInfo').innerHTML = `Sheet: <span class="font-semibold">${sheetName}</span> â€¢ ${sheetNames.length} sheet(s) total`;
            
            let html = '<div class="overflow-x-auto"><table class="excel-viewer-table w-full">';
            
            const headers = jsonData[0] || [];
            html += '<thead><tr>';
            headers.forEach(header => {
                html += `<th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">${header || ''}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            for (let i = 1; i < Math.min(jsonData.length, 1000); i++) {
                const row = jsonData[i] || [];
                const rowClass = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                html += `<tr class="${rowClass} hover:bg-blue-50 transition">`;
                
                for (let j = 0; j < headers.length; j++) {
                    const value = row[j] !== undefined && row[j] !== null ? row[j] : '';
                    
                    const headerLower = String(headers[j] || '').toLowerCase();
                    const isMark = headerLower.includes('mark') || 
                                  headerLower.includes('total') || 
                                  headerLower.includes('final') || 
                                  headerLower.includes('score') ||
                                  headerLower.includes('grade') ||
                                  headerLower.includes('exam');
                    
                    if (isMark && !isNaN(parseFloat(value))) {
                        const num = parseFloat(value);
                        const grade = getGrade(num);
                        html += `<td class="px-4 py-2 text-sm ${grade.color} font-bold">${value}</td>`;
                    } else {
                        html += `<td class="px-4 py-2 text-sm text-gray-700">${value}</td>`;
                    }
                }
                html += '</tr>';
            }
            
            if (jsonData.length > 1000) {
                html += `<tr><td colspan="${headers.length}" class="text-center text-gray-500 py-4 text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    ... and ${jsonData.length - 1000} more rows
                </td></tr>`;
            }
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ========== CLASS FILTER FUNCTIONS ==========
        function toggleClassFilter(classYear) {
            if (selectedClasses.has(classYear)) {
                selectedClasses.delete(classYear);
                document.getElementById(`filter-class-${classYear}`).classList.remove('active');
            } else {
                selectedClasses.add(classYear);
                document.getElementById(`filter-class-${classYear}`).classList.add('active');
            }
            
            updateSelectedClassesDisplay();
            loadSharedFiles();
            updateFilteredCharts();
        }

        function toggleAllClasses() {
            const allClasses = ['2024', '2025', '2026', '2027', '2028', 'other'];
            const allSelected = allClasses.every(c => selectedClasses.has(c));
            
            if (allSelected) {
                selectedClasses.clear();
                allClasses.forEach(c => {
                    document.getElementById(`filter-class-${c}`).classList.remove('active');
                });
            } else {
                allClasses.forEach(c => {
                    selectedClasses.add(c);
                    document.getElementById(`filter-class-${c}`).classList.add('active');
                });
            }
            
            updateSelectedClassesDisplay();
            loadSharedFiles();
            updateFilteredCharts();
        }

        function clearClassFilter() {
            selectedClasses.clear();
            document.querySelectorAll('[id^="filter-class-"]').forEach(el => {
                el.classList.remove('active');
            });
            updateSelectedClassesDisplay();
            loadSharedFiles();
            updateFilteredCharts();
        }

        function updateSelectedClassesDisplay() {
            const container = document.getElementById('selectedClassesDisplay');
            const classNames = {
                '2024': 'March 2024',
                '2025': 'March 2025',
                '2026': 'March 2026',
                '2027': 'March 2027',
                '2028': 'March 2028',
                'other': 'Other'
            };
            
            if (selectedClasses.size === 0) {
                container.innerHTML = '<span class="text-sm text-gray-500">No filters applied - showing all classes</span>';
                return;
            }
            
            let html = '';
            selectedClasses.forEach(c => {
                html += `
                    <span class="selected-class-tag">
                        ${classNames[c] || c}
                        <i class="fas fa-times" onclick="toggleClassFilter('${c}')"></i>
                    </span>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== CLASS SELECTION FOR UPLOAD ==========
        function showClassSelectionModal() {
            pendingFileClasses.clear();
            document.querySelectorAll('.class-option').forEach(opt => {
                opt.classList.remove('selected');
                const checkbox = opt.querySelector('.class-checkbox');
                if (checkbox) {
                    checkbox.style.background = 'white';
                    checkbox.style.color = 'white';
                }
            });
            
            document.getElementById('classModal').style.display = 'flex';
        }

        function toggleClass(classYear) {
            const option = event.currentTarget;
            const checkbox = document.getElementById(`class-check-${classYear}`);
            
            if (pendingFileClasses.has(classYear)) {
                pendingFileClasses.delete(classYear);
                option.classList.remove('selected');
                if (checkbox) {
                    checkbox.style.background = 'white';
                    checkbox.style.color = 'white';
                }
            } else {
                pendingFileClasses.add(classYear);
                option.classList.add('selected');
                if (checkbox) {
                    checkbox.style.background = '#4f46e5';
                    checkbox.style.color = 'white';
                }
            }
        }

        function cancelClassSelection() {
            document.getElementById('classModal').style.display = 'none';
            pendingFileClasses.clear();
            pendingFile = null;
        }

        function confirmClassSelection() {
            if (pendingFileClasses.size === 0) {
                showToast('Please select at least one class', 'error');
                return;
            }
            
            document.getElementById('classModal').style.display = 'none';
            
            const filename = pendingFile.name;
            const classList = Array.from(pendingFileClasses).join('_');
            const fileExt = filename.split('.').pop();
            const baseName = filename.substring(0, filename.lastIndexOf('.'));
            
            pendingFile.finalName = `${baseName}_[${classList}].${fileExt}`;
            pendingFile.classList = Array.from(pendingFileClasses);
            
            showFilePreview(pendingFile);
        }

        // ========== HANDLE EXCEL UPLOAD ==========
        async function handleExcelUpload(input) {
            if (!input.files || input.files.length === 0) return;
            
            const file = input.files[0];
            showLoading('Processing Excel file...', true, 60000);
            
            try {
                debugLog(`ðŸ“ Processing file: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        debugLog(`ðŸ“Š Workbook has ${workbook.SheetNames.length} sheets`);
                        
                        pendingFile = {
                            name: file.name,
                            data: XLSX.write(workbook, { type: 'base64' }),
                            workbook: workbook,
                            rowCount: 0
                        };
                        
                        const firstSheet = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheet];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        pendingFile.rowCount = jsonData.length;
                        
                        hideLoading();
                        showClassSelectionModal();
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        hideLoading();
                        showToast('Error processing file: ' + error.message, 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Upload error:', error);
                hideLoading();
                showToast('Error uploading file: ' + error.message, 'error');
            }
        }

        function showFilePreview(fileData) {
            const workbook = fileData.workbook;
            const firstSheet = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheet];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            const classNames = {
                '2024': 'March 2024',
                '2025': 'March 2025',
                '2026': 'March 2026',
                '2027': 'March 2027',
                '2028': 'March 2028',
                'other': 'Other'
            };
            
            const classDisplay = fileData.classList.map(c => classNames[c] || c).join(', ');
            
            let previewHtml = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
            
            if (jsonData.length > 0) {
                previewHtml += '<thead class="bg-gray-50"><tr>';
                (jsonData[0] || []).forEach(header => {
                    previewHtml += `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header || ''}</th>`;
                });
                previewHtml += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                for (let i = 1; i < Math.min(jsonData.length, 11); i++) {
                    const row = jsonData[i] || [];
                    previewHtml += '<tr>';
                    row.forEach(cell => {
                        previewHtml += `<td class="px-3 py-2 text-xs text-gray-500">${cell || ''}</td>`;
                    });
                    previewHtml += '</tr>';
                }
                
                if (jsonData.length > 11) {
                    previewHtml += `<tr><td colspan="${jsonData[0].length}" class="px-3 py-2 text-xs text-gray-400 italic">... and ${jsonData.length - 11} more rows</td></tr>`;
                }
                
                previewHtml += '</tbody></table></div>';
                
                previewHtml = `
                    <div class="mb-3 p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm"><span class="font-semibold">File:</span> ${fileData.finalName || fileData.name}</p>
                        <p class="text-sm"><span class="font-semibold">Classes:</span> ${classDisplay}</p>
                        <p class="text-sm"><span class="font-semibold">Sheets:</span> ${workbook.SheetNames.length}</p>
                        <p class="text-sm"><span class="font-semibold">Rows:</span> ${fileData.rowCount}</p>
                    </div>
                ` + previewHtml;
            }
            
            document.getElementById('filePreview').innerHTML = previewHtml;
            document.getElementById('filePreviewSection').classList.remove('hidden');
        }

        // ========== PUBLISH FILE ==========
        async function publishFile() {
            if (!pendingFile) {
                showToast('No file to publish', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('You must be logged in', 'error');
                return;
            }
            
            showLoading('Publishing file...', true, 60000);
            
            try {
                debugLog(`ðŸ“¤ Publishing: ${pendingFile.finalName || pendingFile.name}`);
                
                const { data, error } = await supabase
                    .from('shared_excel_files')
                    .insert([{
                        filename: pendingFile.finalName || pendingFile.name,
                        file_data: pendingFile.data,
                        uploaded_by: currentUser.id,
                        uploaded_by_email: currentUser.email,
                        row_count: pendingFile.rowCount || 0,
                        classes: pendingFile.classList ? pendingFile.classList.join(',') : '',
                        uploaded_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                debugLog('âœ… File published successfully');
                
                document.getElementById('filePreviewSection').classList.add('hidden');
                document.getElementById('filePreview').innerHTML = '';
                document.getElementById('excelUpload').value = '';
                pendingFile = null;
                pendingFileClasses.clear();
                
                hideLoading();
                showToast('File published successfully', 'success');
                
                loadSharedFiles();
                loadAllStudentMarks();
                
            } catch (error) {
                console.error('Publish error:', error);
                hideLoading();
                showToast('Error publishing file: ' + error.message, 'error');
            }
        }

        function closeFilePreview() {
            document.getElementById('filePreviewSection').classList.add('hidden');
            document.getElementById('filePreview').innerHTML = '';
            pendingFile = null;
            pendingFileClasses.clear();
        }

        // ========== LOGOUT ==========
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            currentRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainPortal').classList.add('hidden');
            showToast('Logged out successfully', 'success');
        }

        // ========== CLEAR SEARCH ==========
        function clearSearch() {
            document.getElementById('studentSearchInput').value = '';
            document.getElementById('studentResultsContainer').classList.add('hidden');
            document.getElementById('studentResultsTable').innerHTML = '';
        }

        // ========== LOAD SHARED FILES ==========
        async function loadSharedFiles() {
            try {
                const { data: files, error } = await supabase
                    .from('shared_excel_files')
                    .select('*')
                    .order('uploaded_at', { ascending: false });
                
                if (error) throw error;
                
                sharedFiles = files || [];
                
                let filteredFiles = sharedFiles;
                if (selectedClasses.size > 0) {
                    filteredFiles = filteredFiles.filter(file => {
                        if (!file.classes) return false;
                        const fileClasses = file.classes.split(',');
                        return Array.from(selectedClasses).some(c => fileClasses.includes(c));
                    });
                }
                
                const container = document.getElementById('sharedFilesContainer');
                document.getElementById('filteredFileCount').innerText = filteredFiles.length;
                
                if (filteredFiles.length === 0) {
                    container.innerHTML = `<div class="col-span-3 text-center py-8 text-gray-500 text-sm">No files match the selected filters</div>`;
                    return;
                }
                
                container.innerHTML = filteredFiles.map(file => {
                    const date = new Date(file.uploaded_at).toLocaleString();
                    const canEdit = currentRole === 'admin' || currentRole === 'super_admin';
                    
                    const fileClasses = file.classes ? file.classes.split(',') : [];
                    const classNames = {
                        '2024': 'March 2024',
                        '2025': 'March 2025',
                        '2026': 'March 2026',
                        '2027': 'March 2027',
                        '2028': 'March 2028',
                        'other': 'Other'
                    };
                    
                    const classDisplay = fileClasses.map(c => classNames[c] || c).join(', ');
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition bg-white">
                            <div class="flex items-start">
                                <i class="fas fa-file-excel text-green-600 text-2xl mr-3"></i>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <p class="font-semibold text-gray-800 text-sm truncate" title="${file.filename}">${file.filename}</p>
                                    </div>
                                    <div class="flex items-center mt-1 text-xs gap-1 flex-wrap">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${file.row_count || 0} records</span>
                                        <span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">${classDisplay}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1"><i class="fas fa-user mr-1"></i>${file.uploaded_by_email || 'Unknown'} â€¢ ${date}</p>
                                    <div class="mt-2 flex gap-1 flex-wrap">
                                        ${canEdit ? `<button onclick="openInGoogleSheets('${file.id}')" class="edit-sheets-btn text-xs px-3 py-1.5">
                                            <i class="fab fa-google"></i> Edit
                                        </button>` : ''}
                                        <button onclick="viewFile('${file.id}')" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700"><i class="fas fa-eye mr-1"></i>View</button>
                                        ${canEdit ? `<button onclick="deleteFile('${file.id}', '${file.filename}')" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700"><i class="fas fa-trash mr-1"></i>Delete</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) { 
                debugLog('âŒ Error loading files: ' + error.message);
                console.error(error); 
            }
        }

        // ========== DELETE FILE ==========
        async function deleteFile(fileId, filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"? This cannot be undone.`)) {
                return;
            }
            
            showLoading('Deleting file...', false, 30000);
            
            try {
                const { error } = await supabase
                    .from('shared_excel_files')
                    .delete()
                    .eq('id', fileId);
                
                if (error) throw error;
                
                hideLoading();
                showToast('File deleted successfully', 'success');
                
                loadSharedFiles();
                loadAllStudentMarks();
                
            } catch (error) {
                console.error('Delete error:', error);
                hideLoading();
                showToast('Error deleting file: ' + error.message, 'error');
            }
        }

        // ========== LOGIN FUNCTION ==========
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { showToast('Enter email and password', 'error'); return; }
            
            showLoading('Logging in...', false, 10000);
            
            try {
                debugLog('ðŸ” Attempting login for: ' + email);
                
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({ 
                    email, 
                    password 
                });
                
                if (authError) throw authError;
                
                debugLog('âœ… Auth successful for: ' + authData.user.email);
                
                const { data: profile, error: profileError } = await supabase
                    .from('consolidated_user_profiles_table')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (profileError) {
                    debugLog('ðŸ“ Creating new profile...');
                    const { data: newProfile, error: createError } = await supabase
                        .from('consolidated_user_profiles_table')
                        .insert([{
                            email: email,
                            full_name: email.split('@')[0],
                            role: email.includes('admin') ? 'admin' : 'lecturer',
                            department: 'Nursing',
                            is_active: true,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (createError) throw createError;
                    
                    currentUser = newProfile;
                    currentRole = newProfile.role;
                } else {
                    currentUser = profile;
                    currentRole = profile.role;
                }
                
                debugLog('âœ… User role: ' + currentRole);
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainPortal').classList.remove('hidden');
                
                document.getElementById('userDisplayName').innerHTML = `<i class="fas fa-user mr-1"></i>${currentUser.full_name || currentUser.email}`;
                document.getElementById('userEmailDisplay').innerText = currentUser.email;
                document.getElementById('userRoleDisplay').innerText = currentRole.replace('_', ' ').toUpperCase();
                
                const badge = document.getElementById('userRoleBadge');
                badge.innerText = currentRole.replace('_', ' ').toUpperCase();
                
                if (currentRole === 'admin' || currentRole === 'super_admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminSearchSection').classList.remove('hidden');
                } else {
                    document.getElementById('adminDashboard').classList.add('hidden');
                    document.getElementById('adminSearchSection').classList.add('hidden');
                }
                
                hideLoading();
                showToast('Login successful!', 'success');
                
                setTimeout(() => { 
                    loadSharedFiles(); 
                    loadAllStudentMarks(); 
                }, 100);
                
            } catch (error) {
                debugLog('âŒ Login error: ' + error.message);
                hideLoading();
                showToast(error.message, 'error');
            }
        }

        // ========== LOAD ALL STUDENT MARKS ==========
        async function loadAllStudentMarks() {
            if (isProcessing) {
                processingQueue.push(loadAllStudentMarks);
                return;
            }
            
            isProcessing = true;
            showLoading('Loading data from Excel files...', true, 120000);
            
            try {
                debugLog('ðŸ“¡ Fetching files from Supabase...');
                
                const { data: files, error } = await supabase
                    .from('shared_excel_files')
                    .select('id, filename, file_data, uploaded_by_email, uploaded_at, classes')
                    .order('uploaded_at', { ascending: false });
                
                if (error) throw error;
                
                if (!files || files.length === 0) {
                    debugLog('âš ï¸ No files found');
                    document.getElementById('totalFilesStats').innerText = '0';
                    document.getElementById('totalRecordsStats').innerText = '0';
                    hideLoading();
                    isProcessing = false;
                    return;
                }
                
                debugLog(`ðŸ“ Found ${files.length} files`);
                sharedFiles = files;
                
                allStudentMarks = [];
                studentIndex.clear();
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const progress = (i / files.length) * 100;
                    updateProgress(progress);
                    
                    debugLog(`\nðŸ“Š Processing file ${i+1}/${files.length}: ${file.filename}`);
                    document.getElementById('loadingMessage').innerText = `Processing: ${file.filename}`;
                    
                    if (!file.file_data) {
                        debugLog(`âš ï¸ File ${i+1} has no data, skipping`);
                        continue;
                    }
                    
                    try {
                        const binaryData = atob(file.file_data);
                        const array = new Uint8Array(binaryData.length);
                        for (let j = 0; j < binaryData.length; j++) {
                            array[j] = binaryData.charCodeAt(j);
                        }
                        
                        const workbook = XLSX.read(array, { type: 'array' });
                        debugLog(`ðŸ“š Workbook has ${workbook.SheetNames.length} sheets: ${workbook.SheetNames.join(', ')}`);
                        
                        const isClinicalRotationsFile = workbook.SheetNames.some(name => 
                            name.includes('XY FORMS') || name.includes('MARCH 2024') || name.includes('CASE STUDY')
                        );
                        
                        const isUnitsPerSheetFile = workbook.SheetNames.length > 3 && 
                            workbook.SheetNames.every(name => 
                                !name.includes('MARCH') && !name.includes('XY') && !name.includes('Sheet')
                            );
                        
                        debugLog(`ðŸ“‹ File type: ${isClinicalRotationsFile ? 'Clinical Rotations' : isUnitsPerSheetFile ? 'Units per Sheet' : 'Mixed/Unknown'}`);
                        
                        for (const sheetName of workbook.SheetNames) {
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                            
                            debugLog(`\nðŸ“„ Processing sheet: "${sheetName}" - ${jsonData.length} rows`);
                            
                            if (!jsonData || jsonData.length < 2) continue;
                            
                            let headerRowIndex = -1;
                            for (let r = 0; r < Math.min(10, jsonData.length); r++) {
                                const row = jsonData[r];
                                if (!row) continue;
                                
                                const rowStr = row.join(' ').toLowerCase();
                                if (rowStr.includes('student') || rowStr.includes('name') || 
                                    rowStr.includes('s.no') || rowStr.includes('sn no')) {
                                    headerRowIndex = r;
                                    break;
                                }
                            }
                            
                            if (headerRowIndex === -1) {
                                debugLog(`âš ï¸ No header row found in sheet "${sheetName}", skipping`);
                                continue;
                            }
                            
                            const headers = jsonData[headerRowIndex] || [];
                            debugLog(`ðŸ“‹ Headers: ${headers.map(h => String(h).substring(0, 20)).join(' | ')}`);
                            
                            for (let r = headerRowIndex + 1; r < jsonData.length; r++) {
                                const row = jsonData[r];
                                if (!row || row.length === 0) continue;
                                
                                if (row.every(cell => !cell || String(cell).trim() === '')) continue;
                                
                                let studentName = '';
                                let studentId = '';
                                let indexNumber = '';
                                
                                for (let col = 0; col < Math.min(5, row.length); col++) {
                                    const header = headers[col] ? String(headers[col]).toLowerCase() : '';
                                    const cellValue = row[col];
                                    
                                    if (!cellValue) continue;
                                    
                                    const valueStr = String(cellValue).trim();
                                    
                                    if (header.includes('name') || header.includes('student')) {
                                        if (valueStr.length > 2 && !valueStr.match(/^\d+$/)) {
                                            studentName = valueStr;
                                        }
                                    }
                                    
                                    if (header.includes('index') || header.includes('adm')) {
                                        if (valueStr.length > 0) {
                                            indexNumber = valueStr;
                                        }
                                    }
                                    
                                    if (header.includes('id') || header.includes('reg')) {
                                        if (valueStr.length > 0) {
                                            studentId = valueStr;
                                        }
                                    }
                                }
                                
                                if (!studentName) {
                                    for (let col = 0; col < Math.min(3, row.length); col++) {
                                        const cellValue = row[col];
                                        if (cellValue) {
                                            const valueStr = String(cellValue).trim();
                                            if (valueStr.length > 3 && !valueStr.match(/^\d+$/)) {
                                                studentName = valueStr;
                                                break;
                                            }
                                        }
                                    }
                                }
                                
                                if (!studentName) continue;
                                
                                const record = {
                                    fileId: file.id,
                                    filename: file.filename,
                                    sheetName: sheetName,
                                    studentName: studentName,
                                    studentId: studentId || indexNumber || '',
                                    indexNumber: indexNumber,
                                    rawData: {},
                                    marks: []
                                };
                                
                                headers.forEach((header, colIdx) => {
                                    if (header) {
                                        record.rawData[String(header)] = row[colIdx];
                                    }
                                });
                                
                                if (isClinicalRotationsFile && sheetName.includes('XY FORMS')) {
                                    const rotationColumns = [
                                        'MAT 1', 'MAT 2', 'MAT 3',
                                        'PEAD 1', 'PEAD2[ward mgt]',
                                        'SURG 1 GEN', 'SURG 2 GYNA', 'SURG 3 ORTHO',
                                        'OPD/CASUALITY', 'NBU 1', 'NBU 2', 'THEATRE',
                                        'PSYCHIATRY', 'RURALS', 'DISTRICT', 'SPECIAL CLINICS',
                                        'MED 2', 'MED  3 {Ward mgt}', 'MCH 1', 'MCH 2', 'MCH 3'
                                    ];
                                    
                                    headers.forEach((header, colIdx) => {
                                        if (!header) return;
                                        
                                        const headerStr = String(header).trim();
                                        const cellValue = row[colIdx];
                                        
                                        const isRotation = rotationColumns.some(rot => 
                                            headerStr.includes(rot) || rot.includes(headerStr)
                                        );
                                        
                                        if (isRotation && cellValue) {
                                            const numValue = parseFloat(cellValue);
                                            if (!isNaN(numValue) && numValue > 0) {
                                                record.marks.push({
                                                    subject: `Clinical Rotation - ${headerStr}`,
                                                    assessmentType: 'CLINICAL ROTATION',
                                                    mark: numValue,
                                                    grade: getGrade(numValue),
                                                    originalColumn: headerStr,
                                                    category: 'rotation'
                                                });
                                            }
                                        }
                                    });
                                }
                                
                                if (isClinicalRotationsFile && sheetName.includes('CASE STUDY')) {
                                    const assessmentColumns = [
                                        'PREGNANT WOMAN ASSESMENT', 'IMMUNIZATION', 'NURSING CARE',
                                        'PSYCHIATRY assesment', 'PSYCHIATRY CASE STUDY',
                                        'GENERAL NURSING CASE STUDY', 'MIDWIFERY CASE STUDY',
                                        'MCH CASE STUDY', 'PROJECT'
                                    ];
                                    
                                    headers.forEach((header, colIdx) => {
                                        if (!header) return;
                                        
                                        const headerStr = String(header).trim();
                                        const cellValue = row[colIdx];
                                        
                                        const isAssessment = assessmentColumns.some(ass => 
                                            headerStr.includes(ass) || ass.includes(headerStr)
                                        );
                                        
                                        if (isAssessment && cellValue) {
                                            const numValue = parseFloat(cellValue);
                                            if (!isNaN(numValue) && numValue > 0) {
                                                record.marks.push({
                                                    subject: headerStr,
                                                    assessmentType: 'CLINICAL ASSESSMENT',
                                                    mark: numValue,
                                                    grade: getGrade(numValue),
                                                    originalColumn: headerStr,
                                                    category: 'assessment'
                                                });
                                            }
                                        }
                                    });
                                }
                                
                                if (isUnitsPerSheetFile) {
                                    const unitName = sheetName;
                                    
                                    headers.forEach((header, colIdx) => {
                                        if (!header) return;
                                        
                                        const headerStr = String(header).toLowerCase();
                                        const cellValue = row[colIdx];
                                        
                                        if (headerStr.includes('name') || headerStr.includes('s.no') || 
                                            headerStr.includes('sn') || headerStr.includes('adm') ||
                                            headerStr.includes('index') || headerStr.includes('id')) {
                                            return;
                                        }
                                        
                                        if (cellValue) {
                                            const numValue = parseFloat(cellValue);
                                            if (!isNaN(numValue) && numValue > 0 && numValue <= 100) {
                                                let assessmentType = 'EXAM';
                                                if (headerStr.includes('cat')) assessmentType = 'CAT';
                                                else if (headerStr.includes('ebe')) assessmentType = 'EBE';
                                                else if (headerStr.includes('final')) assessmentType = 'FINAL';
                                                else if (headerStr.includes('practical')) assessmentType = 'PRACTICAL';
                                                
                                                record.marks.push({
                                                    subject: unitName,
                                                    assessmentType: assessmentType,
                                                    mark: numValue,
                                                    grade: getGrade(numValue),
                                                    originalColumn: String(header),
                                                    category: 'unit'
                                                });
                                            }
                                        }
                                    });
                                }
                                
                                headers.forEach((header, colIdx) => {
                                    if (!header) return;
                                    
                                    const headerStr = String(header).toLowerCase();
                                    if (headerStr.includes('final clinical score') || headerStr.includes('final score')) {
                                        const cellValue = row[colIdx];
                                        if (cellValue) {
                                            const numValue = parseFloat(cellValue);
                                            if (!isNaN(numValue) && numValue > 0) {
                                                record.marks.push({
                                                    subject: 'FINAL CLINICAL SCORE',
                                                    assessmentType: 'FINAL',
                                                    mark: numValue,
                                                    grade: getGrade(numValue),
                                                    originalColumn: String(header),
                                                    category: 'final',
                                                    isFinal: true
                                                });
                                            }
                                        }
                                    }
                                });
                                
                                if (record.marks.length > 0) {
                                    const studentKey = studentName.toLowerCase();
                                    
                                    if (!studentIndex.has(studentKey)) {
                                        studentIndex.set(studentKey, []);
                                    }
                                    
                                    studentIndex.get(studentKey).push(record);
                                    allStudentMarks.push(record);
                                    
                                    if (allStudentMarks.length <= 20) {
                                        debugLog(`  âœ… Added: ${studentName} - ${record.marks.length} marks from "${sheetName}"`);
                                        record.marks.forEach(m => {
                                            debugLog(`     - ${m.subject}: ${m.mark} (${m.assessmentType})`);
                                        });
                                    }
                                }
                            }
                        }
                        
                    } catch (fileError) {
                        debugLog(`âŒ Error processing file ${file.filename}: ${fileError.message}`);
                        console.error(fileError);
                    }
                }
                
                debugLog(`\nâœ… FINAL: ${allStudentMarks.length} total student records`);
                
                const totalMarks = allStudentMarks.reduce((sum, r) => sum + r.marks.length, 0);
                debugLog(`ðŸ“Š Total marks extracted: ${totalMarks}`);
                
                document.getElementById('totalFilesStats').innerText = files.length;
                document.getElementById('totalRecordsStats').innerText = allStudentMarks.length;
                
                updateStatsAndCharts();
                hideLoading();
                isProcessing = false;
                
                if (processingQueue.length > 0) {
                    const next = processingQueue.shift();
                    setTimeout(next, 100);
                }
                
                showToast(`Successfully loaded ${allStudentMarks.length} student records with ${totalMarks} marks`, 'success');
                
            } catch (error) {
                console.error('Error loading student marks:', error);
                hideLoading();
                isProcessing = false;
                showToast('Error loading data: ' + error.message, 'error');
            }
        }

        // ========== UPDATE STATS AND CHARTS ==========
        function updateStatsAndCharts() {
            try {
                let filteredMarks = allStudentMarks;
                
                if (selectedClasses.size > 0) {
                    filteredMarks = filteredMarks.filter(mark => {
                        const file = sharedFiles.find(f => f.id === mark.fileId);
                        if (!file || !file.classes) return false;
                        const fileClasses = file.classes.split(',');
                        return Array.from(selectedClasses).some(c => fileClasses.includes(c));
                    });
                }
                
                const classNames = Array.from(selectedClasses).map(c => {
                    const map = {'2024':'Mar24','2025':'Mar25','2026':'Mar26','2027':'Mar27','2028':'Mar28','other':'Other'};
                    return map[c] || c;
                }).join(', ');
                
                document.getElementById('chartFilterBadge').innerText = selectedClasses.size > 0 ? classNames : 'All Classes';
                document.getElementById('barChartFilterBadge').innerText = selectedClasses.size > 0 ? classNames : 'All Classes';
                
                let gradeCounts = { A: 0, B: 0, C: 0, D: 0 };
                let markRanges = { '0-59': 0, '60-74': 0, '75-84': 0, '85-100': 0 };
                
                filteredMarks.forEach(record => {
                    record.marks.forEach(m => {
                        if (m.grade.grade === 'A') gradeCounts.A++;
                        else if (m.grade.grade === 'B') gradeCounts.B++;
                        else if (m.grade.grade === 'C') gradeCounts.C++;
                        else gradeCounts.D++;
                        
                        if (m.mark < 60) markRanges['0-59']++;
                        else if (m.mark < 75) markRanges['60-74']++;
                        else if (m.mark < 85) markRanges['75-84']++;
                        else markRanges['85-100']++;
                    });
                });
                
                const ctx1 = document.getElementById('performanceChart').getContext('2d');
                if (performanceChart) performanceChart.destroy();
                
                performanceChart = new Chart(ctx1, {
                    type: 'pie',
                    data: {
                        labels: ['A (85-100)', 'B (75-84)', 'C (60-74)', 'D (0-59)'],
                        datasets: [{
                            data: [gradeCounts.A, gradeCounts.B, gradeCounts.C, gradeCounts.D],
                            backgroundColor: ['#4F46E5', '#059669', '#D97706', '#DC2626'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
                
                const ctx2 = document.getElementById('distributionChart').getContext('2d');
                if (distributionChart) distributionChart.destroy();
                
                distributionChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['0-59 (D)', '60-74 (C)', '75-84 (B)', '85-100 (A)'],
                        datasets: [{
                            label: 'Number of Marks',
                            data: [markRanges['0-59'], markRanges['60-74'], markRanges['75-84'], markRanges['85-100']],
                            backgroundColor: ['#DC2626', '#D97706', '#059669', '#4F46E5'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, grid: { display: false } }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        function updateFilteredCharts() {
            updateStatsAndCharts();
        }


        // ========== TRANSCRIPT FUNCTIONS ==========
        function downloadOfficialTranscriptPDF() {
            if (!currentTranscriptData) {
                showToast('No student data available', 'error');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 51, 102);
                doc.text(COLLEGE_NAME, 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(100, 100, 100);
                doc.text(COLLEGE_MOTTO, 105, 27, { align: 'center' });
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80, 80, 80);
                const addressLines = doc.splitTextToSize(COLLEGE_ADDRESS, 180);
                doc.text(addressLines, 105, 34, { align: 'center' });
                
                doc.setDrawColor(0, 51, 102);
                doc.setLineWidth(0.5);
                doc.line(20, 40, 190, 40);
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 51, 102);
                doc.text('OFFICIAL ACADEMIC TRANSCRIPT', 105, 48, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 0, 0);
                doc.text('PROVISIONAL RESULTS - NOT FOR OFFICIAL USE', 105, 55, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                let yPos = 65;
                doc.text(`Student Name: ${currentTranscriptData.studentName || 'N/A'}`, 20, yPos);
                yPos += 6;
                
                let idLine = '';
                if (currentTranscriptData.studentId) idLine += `Admission: ${currentTranscriptData.studentId}`;
                if (currentTranscriptData.studentIndex) {
                    if (idLine) idLine += ' | ';
                    idLine += `Index: ${currentTranscriptData.studentIndex}`;
                }
                doc.text(idLine || 'N/A', 20, yPos);
                yPos += 6;
                
                doc.text(`Program: ${PROGRAM_NAME} - Kenya Registered Community Health Nurse`, 20, yPos);
                yPos += 6;
                doc.text(`Date Printed: ${new Date().toLocaleDateString()}`, 20, yPos);
                yPos += 10;
                
                const allSubjects = [];
                
                if (currentTranscriptData.theorySubjects) {
                    currentTranscriptData.theorySubjects.forEach(s => {
                        allSubjects.push({
                            name: s.name,
                            finalScore: s.finalScore,
                            grade: s.grade,
                            points: s.grade.points,
                            status: s.passed ? 'PASS' : 'FAIL'
                        });
                    });
                }
                
                if (currentTranscriptData.clinicalMarks) {
                    currentTranscriptData.clinicalMarks.forEach(m => {
                        allSubjects.push({
                            name: m.name,
                            finalScore: m.mark,
                            grade: m.grade,
                            points: m.grade.points,
                            status: m.passed ? 'PASS' : 'FAIL'
                        });
                    });
                }
                
                const tableHeaders = [['#', 'Subject/Assessment', 'Final Score', 'Grade', 'Points', 'Status']];
                const tableBody = allSubjects.map((s, index) => {
                    return [
                        (index + 1).toString(),
                        s.name,
                        s.finalScore.toFixed(1),
                        s.grade.grade,
                        s.points.toString(),
                        s.status
                    ];
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: tableHeaders,
                    body: tableBody,
                    theme: 'striped',
                    styles: {
                        fontSize: 9,
                        cellPadding: 4,
                        lineColor: [200, 200, 200],
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [0, 51, 102],
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' },
                        1: { cellWidth: 80, halign: 'left' },
                        2: { cellWidth: 25, halign: 'center' },
                        3: { cellWidth: 20, halign: 'center' },
                        4: { cellWidth: 20, halign: 'center' },
                        5: { cellWidth: 25, halign: 'center' }
                    },
                    margin: { left: 15, right: 15 }
                });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 51, 102);
                doc.text('SUMMARY', 20, finalY);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                let summaryY = finalY + 7;
                
                const passCount = allSubjects.filter(s => s.status === 'PASS').length;
                const failCount = allSubjects.length - passCount;
                
                const summaryData = [
                    ['Total Subjects:', allSubjects.length.toString()],
                    ['Passed:', passCount.toString()],
                    ['Failed:', failCount.toString()],
                    ['Overall Average:', currentTranscriptData.avgOverall.toFixed(1) + '%'],
                    ['Total Points:', currentTranscriptData.totalPoints.toString()],
                    ['GPA:', currentTranscriptData.gpa.toString()]
                ];
                
                summaryData.forEach((item, index) => {
                    doc.text(item[0], 25, summaryY + (index * 6));
                    doc.setFont('helvetica', 'bold');
                    doc.text(item[1], 70, summaryY + (index * 6));
                    doc.setFont('helvetica', 'normal');
                });
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                
                if (currentTranscriptData.overallGrade.grade === 'A') {
                    doc.setTextColor(0, 102, 0);
                } else if (currentTranscriptData.overallGrade.grade === 'B') {
                    doc.setTextColor(0, 102, 204);
                } else if (currentTranscriptData.overallGrade.grade === 'C') {
                    doc.setTextColor(204, 102, 0);
                } else {
                    doc.setTextColor(204, 0, 0);
                }
                
                doc.text(`Overall Grade: ${currentTranscriptData.overallGrade.grade} - ${currentTranscriptData.overallGrade.status}`, 120, summaryY + 20);
                
                const signatureY = finalY + 70;
                
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.line(20, signatureY, 90, signatureY);
                doc.line(120, signatureY, 190, signatureY);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 51, 102);
                doc.text('HOD NURSING', 40, signatureY + 5, { align: 'center' });
                doc.text('PRINCIPAL', 155, signatureY + 5, { align: 'center' });
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(100, 100, 100);
                doc.text('(Signed & Stamped)', 40, signatureY + 10, { align: 'center' });
                doc.text('(Signed & Stamped)', 155, signatureY + 10, { align: 'center' });
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80, 80, 80);
                doc.text('Name: Dr. Jane Akinyi', 40, signatureY + 15, { align: 'center' });
                doc.text('Name: Prof. James Mwangi', 155, signatureY + 15, { align: 'center' });
                
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                const gradingKey = 'Grading: A=85-100 (Distinction, 4pts), B=75-84 (Credit, 3pts), C=60-74 (Pass, 2pts), D=0-59 (Fail, 0pts)';
                doc.text(gradingKey, 105, 260, { align: 'center' });
                
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text(COLLEGE_FOOTER, 105, 270, { align: 'center' });
                
                const fileName = `${(currentTranscriptData.studentName || 'Student').replace(/[^a-zA-Z0-9]/g, '_')}_Transcript.pdf`;
                doc.save(fileName);
                
                showToast('PDF downloaded successfully', 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('Error generating PDF: ' + error.message, 'error');
            }
        }

        function downloadTranscriptExcel() {
            if (!currentTranscriptData) {
                showToast('No student data available', 'error');
                return;
            }
            
            try {
                const wb = XLSX.utils.book_new();
                
                const allSubjects = [];
                
                if (currentTranscriptData.theorySubjects) {
                    currentTranscriptData.theorySubjects.forEach(s => {
                        allSubjects.push({
                            name: s.name,
                            finalScore: s.finalScore,
                            grade: s.grade,
                            points: s.grade.points,
                            status: s.passed ? 'PASS' : 'FAIL'
                        });
                    });
                }
                
                if (currentTranscriptData.clinicalMarks) {
                    currentTranscriptData.clinicalMarks.forEach(m => {
                        allSubjects.push({
                            name: m.name,
                            finalScore: m.mark,
                            grade: m.grade,
                            points: m.grade.points,
                            status: m.passed ? 'PASS' : 'FAIL'
                        });
                    });
                }
                
                const summaryData = [
                    ['NAKURU COLLEGE OF HEALTH SCIENCES - ACADEMIC TRANSCRIPT'],
                    ['PROVISIONAL RESULTS'],
                    [],
                    ['Student Name:', currentTranscriptData.studentName],
                    ['Admission No:', currentTranscriptData.studentId || 'N/A'],
                    ['Index Number:', currentTranscriptData.studentIndex || 'N/A'],
                    ['Program:', PROGRAM_NAME + ' - Kenya Registered Community Health Nurse'],
                    ['Date:', new Date().toLocaleDateString()],
                    [],
                    ['#', 'Subject/Assessment', 'Final Score', 'Grade', 'Points', 'Status']
                ];
                
                allSubjects.forEach((s, index) => {
                    summaryData.push([
                        (index + 1).toString(),
                        s.name,
                        s.finalScore.toFixed(1),
                        s.grade.grade,
                        s.points.toString(),
                        s.status
                    ]);
                });
                
                summaryData.push([]);
                
                const passCount = allSubjects.filter(s => s.status === 'PASS').length;
                const failCount = allSubjects.length - passCount;
                
                summaryData.push(
                    ['SUMMARY'],
                    ['Total Subjects:', allSubjects.length.toString()],
                    ['Passed:', passCount.toString()],
                    ['Failed:', failCount.toString()],
                    ['Overall Average:', currentTranscriptData.avgOverall.toFixed(1) + '%'],
                    ['Total Points:', currentTranscriptData.totalPoints.toString()],
                    ['GPA:', currentTranscriptData.gpa.toString()],
                    ['Overall Grade:', `${currentTranscriptData.overallGrade.grade} - ${currentTranscriptData.overallGrade.status}`],
                    [],
                    ['SIGNED BY:'],
                    ['HOD NURSING: Dr. Jane Akinyi', '', 'PRINCIPAL: Prof. James Mwangi'],
                    ['Date: ' + new Date().toLocaleDateString(), '', 'Date: ' + new Date().toLocaleDateString()]
                );
                
                const ws = XLSX.utils.aoa_to_sheet(summaryData);
                
                ws['!cols'] = [
                    { wch: 5 },   // #
                    { wch: 40 },  // Subject
                    { wch: 12 },  // Final Score
                    { wch: 8 },   // Grade
                    { wch: 8 },   // Points
                    { wch: 10 }   // Status
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Transcript');
                
                const fileName = `${(currentTranscriptData.studentName || 'Student').replace(/[^a-zA-Z0-9]/g, '_')}_Transcript.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('Excel downloaded successfully', 'success');
                
            } catch (error) {
                console.error('Excel error:', error);
                showToast('Error generating Excel: ' + error.message, 'error');
            }
        }

        function printOfficialTranscript() {
            if (!currentTranscriptData) {
                showToast('No student data available', 'error');
                return;
            }
            
            try {
                const allSubjects = [];
                
                if (currentTranscriptData.theorySubjects) {
                    currentTranscriptData.theorySubjects.forEach(s => {
                        allSubjects.push({
                            name: s.name,
                            finalScore: s.finalScore,
                            grade: s.grade,
                            points: s.grade.points,
                            status: s.passed ? 'PASS' : 'FAIL'
                        });
                    });
                }
                
                if (currentTranscriptData.clinicalMarks) {
                    currentTranscriptData.clinicalMarks.forEach(m => {
                        allSubjects.push({
                            name: m.name,
                            finalScore: m.mark,
                            grade: m.grade,
                            points: m.grade.points,
                            status: m.passed ? 'PASS' : 'FAIL'
                        });
                    });
                }
                
                const passCount = allSubjects.filter(s => s.status === 'PASS').length;
                const failCount = allSubjects.length - passCount;
                
                const tableRows = allSubjects.map((s, index) => {
                    const statusClass = s.status === 'PASS' ? 'status-pass' : 'status-fail';
                    
                    return `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td>${s.name}</td>
                            <td class="text-center font-bold ${s.grade.color}">${s.finalScore.toFixed(1)}</td>
                            <td class="text-center"><span class="grade-badge grade-${s.grade.grade.toLowerCase()}">${s.grade.grade}</span></td>
                            <td class="text-center">${s.points}</td>
                            <td class="text-center ${statusClass}">${s.status}</td>
                        </tr>
                    `;
                }).join('');
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Academic Transcript - ${currentTranscriptData.studentName}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 30px;
                                font-size: 12px;
                                line-height: 1.4;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 25px; 
                                border-bottom: 2px solid #003366;
                                padding-bottom: 15px;
                            }
                            .college-name { 
                                font-size: 20px; 
                                font-weight: bold; 
                                color: #003366; 
                                margin: 5px 0;
                            }
                            .motto { 
                                font-size: 12px; 
                                color: #666; 
                                margin: 5px 0; 
                                font-style: italic;
                            }
                            .address { 
                                font-size: 10px; 
                                color: #999; 
                                margin: 5px 0;
                            }
                            .title { 
                                font-size: 16px; 
                                font-weight: bold; 
                                color: #003366; 
                                margin: 20px 0; 
                                text-align: center; 
                            }
                            .provisional { 
                                color: red; 
                                font-weight: bold; 
                                text-align: center; 
                                margin: 10px 0;
                                font-size: 12px;
                                border: 1px solid red;
                                padding: 5px;
                                background: #ffeeee;
                            }
                            .student-info { 
                                margin: 20px 0; 
                                padding: 15px;
                                background: #f5f5f5;
                                border-radius: 5px;
                                border-left: 4px solid #003366;
                            }
                            .student-info p {
                                margin: 5px 0;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin: 20px 0;
                                font-size: 11px;
                            }
                            th { 
                                background: #003366; 
                                color: white; 
                                padding: 10px; 
                                text-align: left;
                                font-weight: bold;
                            }
                            td { 
                                padding: 8px; 
                                border: 1px solid #ddd; 
                            }
                            tr:nth-child(even) {
                                background: #f9f9f9;
                            }
                            .grade-badge {
                                padding: 4px 10px;
                                border-radius: 20px;
                                display: inline-block;
                                font-weight: bold;
                                font-size: 11px;
                            }
                            .grade-a { 
                                background: #ede9fe; 
                                color: #5b21b6; 
                            }
                            .grade-b { 
                                background: #d1fae5; 
                                color: #065f46; 
                            }
                            .grade-c { 
                                background: #fed7aa; 
                                color: #92400e; 
                            }
                            .grade-d { 
                                background: #fee2e2; 
                                color: #991b1b; 
                            }
                            .status-pass {
                                color: #065f46;
                                font-weight: bold;
                                background: #dcfce7;
                                padding: 4px 8px;
                                border-radius: 20px;
                            }
                            .status-fail {
                                color: #991b1b;
                                font-weight: bold;
                                background: #fee2e2;
                                padding: 4px 8px;
                                border-radius: 20px;
                            }
                            .summary-container { 
                                margin: 30px 0;
                                display: grid;
                                grid-template-columns: repeat(3, 1fr);
                                gap: 15px;
                            }
                            .summary-item {
                                background: #f0f7ff;
                                padding: 12px;
                                border-radius: 8px;
                                text-align: center;
                                border: 1px solid #cbd5e1;
                            }
                            .summary-label {
                                font-size: 10px;
                                color: #666;
                                text-transform: uppercase;
                            }
                            .summary-value {
                                font-size: 20px;
                                font-weight: bold;
                                color: #003366;
                            }
                            .signatures {
                                margin-top: 50px;
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 50px;
                            }
                            .signature-box {
                                text-align: center;
                                border-top: 1px solid #000;
                                padding-top: 10px;
                            }
                            .signature-title {
                                font-weight: bold;
                                color: #003366;
                                margin: 5px 0;
                            }
                            .signature-name {
                                font-size: 11px;
                                color: #666;
                                font-style: italic;
                            }
                            .footer { 
                                margin-top: 40px; 
                                font-size: 9px; 
                                color: #999; 
                                text-align: center; 
                                border-top: 1px solid #ccc;
                                padding-top: 15px;
                            }
                            .grading-key {
                                margin: 20px 0;
                                padding: 10px;
                                background: #f5f5f5;
                                font-size: 9px;
                                color: #666;
                                text-align: center;
                                border-radius: 5px;
                            }
                            .text-center { text-align: center; }
                            .font-bold { font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="college-name">${COLLEGE_NAME}</div>
                            <div class="motto">${COLLEGE_MOTTO}</div>
                            <div class="address">${COLLEGE_ADDRESS}</div>
                        </div>
                        
                        <div class="title">OFFICIAL ACADEMIC TRANSCRIPT</div>
                        <div class="provisional">PROVISIONAL RESULTS - NOT FOR OFFICIAL USE</div>
                        
                        <div class="student-info">
                            <p><strong>Student Name:</strong> ${currentTranscriptData.studentName}</p>
                            <p><strong>Admission No:</strong> ${currentTranscriptData.studentId || 'N/A'}</p>
                            <p><strong>Index Number:</strong> ${currentTranscriptData.studentIndex || 'N/A'}</p>
                            <p><strong>Program:</strong> ${PROGRAM_NAME} - Kenya Registered Community Health Nurse</p>
                            <p><strong>Date Printed:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Subject/Assessment</th>
                                    <th>Final Score</th>
                                    <th>Grade</th>
                                    <th>Points</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                        
                        <div class="summary-container">
                            <div class="summary-item">
                                <div class="summary-label">Total Subjects</div>
                                <div class="summary-value">${allSubjects.length}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Passed</div>
                                <div class="summary-value" style="color: #065f46;">${passCount}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Failed</div>
                                <div class="summary-value" style="color: #991b1b;">${failCount}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Average</div>
                                <div class="summary-value">${currentTranscriptData.avgOverall.toFixed(1)}%</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">GPA</div>
                                <div class="summary-value">${currentTranscriptData.gpa}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Overall Grade</div>
                                <div class="summary-value">${currentTranscriptData.overallGrade.grade}</div>
                            </div>
                        </div>
                        
                        <div class="grading-key">
                            <strong>Grading Key:</strong> A=85-100 (Distinction, 4pts) | B=75-84 (Credit, 3pts) | C=60-74 (Pass, 2pts) | D=0-59 (Fail, 0pts)
                        </div>
                        
                        <div class="signatures">
                            <div class="signature-box">
                                <div class="signature-title">HOD NURSING</div>
                                <div class="signature-name">Dr. Jane Akinyi</div>
                                <div style="margin-top: 5px; font-size: 10px;">Signed: ___________________</div>
                                <div style="margin-top: 5px; font-size: 10px;">Date: ${new Date().toLocaleDateString()}</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-title">PRINCIPAL</div>
                                <div class="signature-name">Prof. James Mwangi</div>
                                <div style="margin-top: 5px; font-size: 10px;">Signed: ___________________</div>
                                <div style="margin-top: 5px; font-size: 10px;">Date: ${new Date().toLocaleDateString()}</div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            ${COLLEGE_FOOTER}
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                };
                
                showToast('Print window opened', 'success');
                
            } catch (error) {
                console.error('Print error:', error);
                showToast('Error preparing print: ' + error.message, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    handleLogin();
                }
            });
        });
    </script>
</body>
</html>
