<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nakuru College of Health Sciences - Exam Portal</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client"></script>    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- jsPDF for PDF Transcript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            margin-top: 15px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .debug-info {
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            background: rgba(0,0,0,0.5);
            padding: 8px;
            border-radius: 4px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .progress-bar {
            width: 300px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.2s ease;
            border-radius: 4px;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 12px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            animation: slideIn 0.2s ease;
            font-size: 14px;
        }
        
        .toast.success { border-left: 4px solid #4CAF50; }
        .toast.error { border-left: 4px solid #f44336; }
        .toast.info { border-left: 4px solid #2196F3; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0%); opacity: 1; }
        }
        
        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table tr:hover {
            background-color: #f8fafc;
        }
        
        /* Cards */
        .portal-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px;
            transition: all 0.2s ease;
        }
        
        /* Grade Badges */
        .grade-badge {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .grade-a { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; }
        .grade-b { background: linear-gradient(135deg, #059669 0%, #10B981 100%); color: white; }
        .grade-c { background: linear-gradient(135deg, #D97706 0%, #F59E0B 100%); color: white; }
        .grade-d { background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%); color: white; }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pass { background: #dcfce7; color: #166534; }
        .status-fail { background: #fee2e2; color: #991b1b; }
        .status-credit { background: #dbeafe; color: #1e40af; }
        .status-distinction { background: #ede9fe; color: #5b21b6; }
        
        /* Student Summary Card */
        .student-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-value { font-size: 28px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Gradient Cards */
        .gradient-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .gradient-card-green { background: linear-gradient(135deg, #34b1aa 0%, #1c8f7c 100%); color: white; }
        .gradient-card-orange { background: linear-gradient(135deg, #f09351 0%, #e9692c 100%); color: white; }
        .gradient-card-purple { background: linear-gradient(135deg, #a166ab 0%, #6d4c7d 100%); color: white; }
        
        .row-even { background-color: #f9fafb; }
        .row-odd { background-color: white; }
        
        /* Filter Badges */
        .filter-badge {
            background: #e2e8f0;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .filter-badge.active {
            background: #4f46e5;
            color: white;
        }
        
        .selected-classes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .selected-class-tag {
            background: #4f46e5;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-class-tag i {
            cursor: pointer;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        
        /* Class Selection */
        .class-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .class-option:hover {
            border-color: #4f46e5;
            background: #f5f3ff;
        }
        
        .class-option.selected {
            border-color: #4f46e5;
            background: #eef2ff;
        }
        
        .class-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #4f46e5;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: white;
        }
        
        .class-option.selected .class-checkbox {
            background: #4f46e5;
        }
        
        /* Sheet Tabs */
        .sheet-tab {
            transition: all 0.2s ease;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 2px;
            white-space: nowrap;
        }
        
        .sheet-tab:hover {
            transform: translateY(-1px);
        }
        
        .sheet-tab.active {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }
        
        /* Excel Viewer Table */
        .excel-viewer-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
        }
        
        .excel-viewer-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 8px;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .excel-viewer-table td {
            padding: 8px;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        .excel-viewer-table tr:hover td {
            background-color: #eff6ff !important;
        }
        
        /* Mark Colors */
        .mark-excellent { color: #4F46E5; font-weight: bold; }
        .mark-good { color: #059669; font-weight: bold; }
        .mark-average { color: #D97706; font-weight: bold; }
        .mark-fail { color: #DC2626; font-weight: bold; }
        
        /* Google Sheets Editor */
        .google-sheets-editor {
            height: 70vh;
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .google-sheets-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Scrollbar Styling */
        .modal-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Grading Table */
        .grading-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .grading-table th {
            background: #1e3c72;
            color: white;
            padding: 8px;
            text-align: center;
        }
        
        .grading-table td {
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .grading-table .grade-a { background: #ede9fe; color: #5b21b6; font-weight: bold; }
        .grading-table .grade-b { background: #d1fae5; color: #065f46; font-weight: bold; }
        .grading-table .grade-c { background: #fed7aa; color: #92400e; font-weight: bold; }
        .grading-table .grade-d { background: #fee2e2; color: #991b1b; font-weight: bold; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div id="loadingMessage" class="loading-text">Loading...</div>
            <div id="debugInfo" class="debug-info"></div>
            <div id="progressContainer" style="width: 300px; margin-top: 15px; display: none;">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div id="progressText" class="text-white text-xs mt-1">0%</div>
            </div>
        </div>
    </div>

    <!-- Class Selection Modal -->
    <div id="classModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Select Classes</h3>
            <p class="text-sm text-gray-600 mb-4">Choose which classes this file belongs to (you can select multiple):</p>
            
            <div id="classOptions" class="space-y-2">
                <div class="class-option" onclick="toggleClass('2024')">
                    <div class="class-checkbox" id="class-check-2024">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2024</div>
                        <div class="text-xs text-gray-500">Class of 2024</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2025')">
                    <div class="class-checkbox" id="class-check-2025">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2025</div>
                        <div class="text-xs text-gray-500">Class of 2025</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2026')">
                    <div class="class-checkbox" id="class-check-2026">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2026</div>
                        <div class="text-xs text-gray-500">Class of 2026</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2027')">
                    <div class="class-checkbox" id="class-check-2027">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2027</div>
                        <div class="text-xs text-gray-500">Class of 2027</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2028')">
                    <div class="class-checkbox" id="class-check-2028">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2028</div>
                        <div class="text-xs text-gray-500">Class of 2028</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('other')">
                    <div class="class-checkbox" id="class-check-other">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">Other</div>
                        <div class="text-xs text-gray-500">Different intake</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="cancelClassSelection()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">Cancel</button>
                <button onclick="confirmClassSelection()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Google Sheets Editor Modal -->
    <div id="googleSheetsEditor" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 1400px; height: 90vh; padding: 16px;">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fab fa-google text-green-600 mr-2"></i>
                    GOOGLE SHEETS: <span id="googleSheetsFileName" class="text-blue-600 ml-1 text-sm font-medium"></span>
                </h2>
                <div class="flex gap-2">
                    <button onclick="syncFromGoogleSheets()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2">
                        <i class="fas fa-sync"></i> Sync to Database
                    </button>
                    <button onclick="closeGoogleSheetsEditor()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm flex items-center gap-2">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            <div class="google-sheets-editor">
                <iframe id="googleSheetIframe" class="google-sheets-frame" 
                        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-downloads allow-popups-to-escape-sandbox allow-modals">
                </iframe>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- ========== SUPABASE CONFIG ========== -->
        <script>
            // üî¥ YOUR SUPABASE CREDENTIALS
            const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
            
            // Google Sheets Configuration
          const GOOGLE_API_KEY = 'AIzaSyBxp7H4REEC6qzxwbmU2jQfQ-CRVUAe9Zc';
const GOOGLE_CLIENT_ID = '843012088804-ndacuhhd0mu4lm2taum16vgj4gfi7347.apps.googleusercontent.com';
            
            // Initialize Supabase
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            console.log('‚úÖ Supabase initialized!');
            
            // Global state
            let currentUser = null;
            let currentRole = null;
            let sharedFiles = [];
            let allStudentMarks = [];
            let studentIndex = new Map();
            let performanceChart = null;
            let distributionChart = null;
            let isProcessing = false;
            let processingQueue = [];
            let currentTranscriptData = null;
            let selectedClasses = new Set();
            let pendingFile = null;
            let pendingFileClasses = new Set();
            
            // Google Sheets state
            let currentGoogleSheetId = null;
            let currentGoogleSheetFileId = null;
            
            // College Info
            const COLLEGE_NAME = 'NAKURU COLLEGE OF HEALTH SCIENCES & MANAGEMENT';
            const COLLEGE_MOTTO = 'Excellence in Health Training, Research & Professional Development';
            const COLLEGE_ADDRESS = 'Kiamunyi Campus | P.O. Box 12906 ‚Äì 20100, Nakuru | Tel: 0745 215594 | 0703 345771 | 0103614355';
            const COLLEGE_EMAIL = 'info@nakurucollegeofhealth.ac.ke';
            const COLLEGE_WEBSITE = 'www.nakurucollegeofhealth.ac.ke';
            const COLLEGE_FOOTER = 'Accredited & Registered Institution | Committed to Academic Excellence | ¬© 2026 Nakuru College of Health Sciences & Management';
            const PROGRAM_NAME = 'KRCHN'; // Kenya Registered Community Health Nurse
        </script>

        <!-- ========== LOGIN SCREEN ========== -->
        <div id="loginScreen" class="flex items-center justify-center min-h-screen">
            <div class="portal-card w-full max-w-md">
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-graduation-cap text-white text-3xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">NAKURU COLLEGE OF HEALTH SCIENCES</h1>
                    <p class="text-gray-600 mt-1 text-sm">EXAM RESULTS PROVISIONAL PORTAL</p>
                    <div class="mt-2">
                        <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-xs">
                            <i class="fas fa-clock mr-1"></i>
                            PROVISIONAL RESULTS
                        </span>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">
                            <i class="fas fa-envelope mr-2 text-gray-500"></i>
                            Email Address
                        </label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" 
                               class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-0 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">
                            <i class="fas fa-lock mr-2 text-gray-500"></i>
                            Password
                        </label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" 
                               class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-0 text-sm">
                    </div>
                    
                    <button onclick="handleLogin()" 
                            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2.5 rounded-lg hover:opacity-90 transition font-medium text-sm shadow-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        LOGIN
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== MAIN PORTAL ========== -->
        <div id="mainPortal" class="hidden space-y-6">
            <!-- Header -->
            <div class="portal-card">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-xl shadow-lg mr-3">
                            <i class="fas fa-graduation-cap text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl md:text-2xl font-bold text-gray-800">NAKURU COLLEGE EXAM PORTAL</h1>
                            <div class="flex items-center mt-1 text-sm">
                                <span id="userRoleBadge" class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-bold mr-2"></span>
                                <span id="userDisplayName" class="text-gray-600"></span>
                                <span class="mx-2 text-gray-400">‚Ä¢</span>
                                <span id="userEmailDisplay" class="text-gray-500 text-xs"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="bg-orange-100 px-3 py-1.5 rounded-full flex items-center">
                            <i class="fas fa-clock text-orange-600 mr-1 text-xs"></i>
                            <span class="text-orange-800 text-xs font-semibold">PROVISIONAL</span>
                        </div>
                        <button onclick="logout()" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-300 transition text-sm">
                            <i class="fas fa-sign-out-alt mr-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Class Filter Section -->
            <div class="portal-card">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-filter text-purple-600 mr-2"></i> Filter by Class
                </h2>
                
                <div class="flex flex-wrap gap-2 mb-3">
                    <button onclick="toggleAllClasses()" class="filter-badge">
                        <i class="fas fa-check-double"></i> All Classes
                    </button>
                    <button onclick="clearClassFilter()" class="filter-badge">
                        <i class="fas fa-times"></i> Clear All
                    </button>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <span onclick="toggleClassFilter('2024')" id="filter-class-2024" class="filter-badge">March 2024</span>
                    <span onclick="toggleClassFilter('2025')" id="filter-class-2025" class="filter-badge">March 2025</span>
                    <span onclick="toggleClassFilter('2026')" id="filter-class-2026" class="filter-badge">March 2026</span>
                    <span onclick="toggleClassFilter('2027')" id="filter-class-2027" class="filter-badge">March 2027</span>
                    <span onclick="toggleClassFilter('2028')" id="filter-class-2028" class="filter-badge">March 2028</span>
                    <span onclick="toggleClassFilter('other')" id="filter-class-other" class="filter-badge">Other</span>
                </div>
                
                <!-- Selected Classes Display -->
                <div id="selectedClassesDisplay" class="selected-classes-container mt-3">
                    <!-- Selected classes will appear here -->
                </div>
                
                <div class="mt-3 text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Showing files that match any of the selected classes
                </div>
            </div>

            <!-- Grading System Reference -->
            <div class="portal-card">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-table text-blue-600 mr-2"></i> Grading System - KRCHN Program
                </h2>
                <table class="grading-table">
                    <thead>
                        <tr>
                            <th>Marks From</th>
                            <th>Marks To</th>
                            <th>Grade</th>
                            <th>Points</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>0</td>
                            <td>59</td>
                            <td class="grade-d">D</td>
                            <td>0</td>
                            <td>FAIL</td>
                        </tr>
                        <tr>
                            <td>60</td>
                            <td>74</td>
                            <td class="grade-c">C</td>
                            <td>2</td>
                            <td>PASS</td>
                        </tr>
                        <tr>
                            <td>75</td>
                            <td>84</td>
                            <td class="grade-b">B</td>
                            <td>3</td>
                            <td>CREDIT</td>
                        </tr>
                        <tr>
                            <td>85</td>
                            <td>100</td>
                            <td class="grade-a">A</td>
                            <td>4</td>
                            <td>DISTINCTION</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="gradient-card p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Files</p>
                            <p id="totalFilesStats" class="text-3xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-file-excel text-white text-xl"></i></div>
                    </div>
                </div>
                <div class="gradient-card-green p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Records</p>
                            <p id="totalRecordsStats" class="text-3xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-users text-white text-xl"></i></div>
                    </div>
                </div>
                <div class="gradient-card-orange p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Staff</p>
                            <p id="totalStaffStats" class="text-3xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-chalkboard-teacher text-white text-xl"></i></div>
                    </div>
                </div>
                <div class="gradient-card-purple p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Role</p>
                            <p id="userRoleDisplay" class="text-2xl font-bold mt-1">-</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-shield-alt text-white text-xl"></i></div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="portal-card">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-pie text-purple-600 mr-2"></i> Grade Distribution
                        <span id="chartFilterBadge" class="ml-2 text-xs bg-gray-200 px-2 py-1 rounded-full"></span>
                    </h2>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                <div class="portal-card">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-green-600 mr-2"></i> Mark Ranges
                        <span id="barChartFilterBadge" class="ml-2 text-xs bg-gray-200 px-2 py-1 rounded-full"></span>
                    </h2>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Student Search -->
            <div id="adminSearchSection" class="portal-card">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-search text-blue-600 mr-2"></i> Search Student (Admission No. or Name)
                </h2>
                
                <div class="flex gap-3 mb-6">
                    <input type="text" id="studentSearchInput" placeholder="Enter Admission Number or Student Name..." 
                           class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 text-sm">
                    <button onclick="searchStudentMarks()" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center text-sm">
                        <i class="fas fa-search mr-2"></i> Search
                    </button>
                    <button onclick="clearSearch()" class="bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600 text-sm">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Results -->
                <div id="studentResultsContainer" class="hidden">
                    <div id="studentSummaryCard" class="student-summary-card">
                        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4">
                            <div>
                                <h3 id="studentNameDisplay" class="text-xl font-bold">-</h3>
                                <p id="studentIdDisplay" class="text-white/80 text-sm">Admission No: -</p>
                                <p id="studentProgramDisplay" class="text-white/80 text-sm">Program: KRCHN</p>
                            </div>
                            <div class="mt-2 md:mt-0 flex gap-2">
                                <span id="overallGradeDisplay" class="grade-badge grade-a text-sm px-4 py-2">-</span>
                                <span id="gpaDisplay" class="grade-badge bg-white text-blue-800 text-sm px-4 py-2">GPA: 0.0</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div class="stat-box"><div class="stat-value" id="totalExamsCount">0</div><div class="stat-label">Exams</div></div>
                            <div class="stat-box"><div class="stat-value" id="averageMarkDisplay">0.0</div><div class="stat-label">Average</div></div>
                            <div class="stat-box"><div class="stat-value" id="totalPointsDisplay">0</div><div class="stat-label">Points</div></div>
                            <div class="stat-box"><div class="stat-value" id="gpaValueDisplay">0.0</div><div class="stat-label">GPA</div></div>
                        </div>
                        
                        <!-- Transcript Actions -->
                        <div class="flex gap-2 mt-4 flex-wrap">
                            <button onclick="downloadOfficialTranscriptPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm flex items-center gap-2">
                                <i class="fas fa-file-pdf"></i> Official Transcript
                            </button>
                            <button onclick="downloadTranscriptExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm flex items-center gap-2">
                                <i class="fas fa-file-excel"></i> Excel Transcript
                            </button>
                            <button onclick="printOfficialTranscript()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-file-alt text-blue-600 mr-2"></i> Detailed Results
                    </h3>
                    <div id="studentResultsTable" class="overflow-x-auto bg-white rounded-lg border max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="space-y-6">
                <div class="portal-card">
                    <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-upload text-green-600 mr-2"></i> Upload Excel
                    </h2>
                    <div onclick="document.getElementById('excelUpload').click()"
                         class="border-3 border-dashed border-blue-300 rounded-xl p-6 text-center cursor-pointer hover:border-blue-500 bg-blue-50 transition">
                        <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-2"></i>
                        <p class="text-gray-700 text-sm font-medium">Click to Upload</p>
                        <p class="text-gray-500 text-xs mt-1">.xlsx, .xls, .csv</p>
                        <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelUpload(this)">
                    </div>
                </div>

                <div id="filePreviewSection" class="hidden portal-card">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800 text-sm">Preview</h3>
                        <button onclick="closeFilePreview()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="filePreview" class="overflow-x-auto text-sm"></div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button onclick="publishFile()" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 text-sm">
                            <i class="fas fa-cloud-upload-alt mr-1"></i> Publish
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shared Files -->
            <div class="portal-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fas fa-folder-open text-purple-600 mr-2"></i> Shared Files
                    </h2>
                    <div class="flex gap-2">
                        <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs">
                            <span id="filteredFileCount">0</span> files
                        </span>
                    </div>
                </div>
                <div id="sharedFilesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== UTILITIES ==========
        let toastTimeout;
        function showToast(message, type = 'success', duration = 3000) {
            if (toastTimeout) clearTimeout(toastTimeout);
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle text-green-600' : type === 'error' ? 'fa-exclamation-circle text-red-600' : 'fa-info-circle text-blue-600'} text-sm"></i><span class="text-sm">${message}</span>`;
            document.body.appendChild(toast);
            
            toastTimeout = setTimeout(() => toast.remove(), duration);
        }

        let loadingTimeout;
        function showLoading(message = 'Loading...', showProgress = false, timeoutMs = 60000) {
            if (loadingTimeout) clearTimeout(loadingTimeout);
            document.getElementById('loadingMessage').innerText = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('debugInfo').innerHTML = '';
            if (showProgress) {
                document.getElementById('progressContainer').style.display = 'block';
                updateProgress(0);
            } else {
                document.getElementById('progressContainer').style.display = 'none';
            }
            
            loadingTimeout = setTimeout(() => {
                if (document.getElementById('loadingOverlay').style.display === 'flex') {
                    hideLoading();
                    showToast('Operation timed out', 'error');
                    debugLog('‚ùå OPERATION TIMED OUT');
                }
            }, timeoutMs);
        }
        
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').innerText = Math.round(percent) + '%';
        }
        
        function hideLoading() { 
            document.getElementById('loadingOverlay').style.display = 'none'; 
            if (loadingTimeout) clearTimeout(loadingTimeout);
        }

        function debugLog(message) {
            const time = new Date().toLocaleTimeString();
            const log = `[${time}] ${message}`;
            console.log(log);
            
            const debugEl = document.getElementById('debugInfo');
            if (debugEl && document.getElementById('loadingOverlay').style.display === 'flex') {
                debugEl.innerHTML += `<div>${log}</div>`;
                debugEl.scrollTop = debugEl.scrollHeight;
            }
        }

        // ========== GRADE FUNCTION ==========
        function getGrade(mark) {
            if (mark >= 85) return { 
                grade: 'A', 
                points: 4, 
                status: 'DISTINCTION', 
                class: 'grade-a', 
                pass: true,
                color: 'mark-excellent'
            };
            if (mark >= 75) return { 
                grade: 'B', 
                points: 3, 
                status: 'CREDIT', 
                class: 'grade-b', 
                pass: true,
                color: 'mark-good'
            };
            if (mark >= 60) return { 
                grade: 'C', 
                points: 2, 
                status: 'PASS', 
                class: 'grade-c', 
                pass: true,
                color: 'mark-average'
            };
            return { 
                grade: 'D', 
                points: 0, 
                status: 'FAIL', 
                class: 'grade-d', 
                pass: false,
                color: 'mark-fail'
            };
        }

       // ========== GOOGLE SHEETS FUNCTIONS (UPDATED FOR GIS) ==========
let tokenClient;
let googleAccessToken = null;
let tokenPromiseResolve = null;

function initGoogleAPI() {
    // Initialize the token client
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive',
        callback: (tokenResponse) => {
            if (tokenResponse.error) {
                console.error('Token error:', tokenResponse);
                showToast('Authentication failed: ' + tokenResponse.error, 'error');
                if (tokenPromiseResolve) {
                    tokenPromiseResolve(false);
                    tokenPromiseResolve = null;
                }
                return;
            }
            
            googleAccessToken = tokenResponse.access_token;
            console.log('Google token acquired');
            
            if (tokenPromiseResolve) {
                tokenPromiseResolve(true);
                tokenPromiseResolve = null;
            }
        },
    });
    
    console.log('Google Identity Services initialized');
}

async function ensureGoogleAuth() {
    // If we already have a token, check if it's still valid
    if (googleAccessToken) {
        try {
            // Quick validation by fetching user info
            const response = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + googleAccessToken);
            if (response.ok) {
                return true;
            }
        } catch (e) {
            // Token is invalid, clear it
            googleAccessToken = null;
        }
    }
    
    // Request a new token
    return new Promise((resolve) => {
        tokenPromiseResolve = resolve;
        tokenClient.requestAccessToken();
    });
}

async function openInGoogleSheets(fileId) {
    if (currentRole !== 'admin' && currentRole !== 'super_admin') { 
        showToast('Admins only', 'error'); 
        return; 
    }
    
    const file = sharedFiles.find(f => f.id === fileId);
    if (!file) { 
        showToast('File not found', 'error'); 
        return; 
    }
    
    showLoading('Opening in Google Sheets...', true, 60000);
    
    try {
        // Initialize the token client if needed
        if (!tokenClient) {
            initGoogleAPI();
        }
        
        // Ensure we have authentication
        const isAuthenticated = await ensureGoogleAuth();
        if (!isAuthenticated) {
            hideLoading();
            return;
        }
        
        // Check if we already have a Google Sheet ID
        if (file.google_sheet_id) {
            currentGoogleSheetId = file.google_sheet_id;
            currentGoogleSheetFileId = fileId;
            document.getElementById('googleSheetsFileName').innerText = file.filename;
            document.getElementById('googleSheetIframe').src = `https://docs.google.com/spreadsheets/d/${file.google_sheet_id}/edit`;
            document.getElementById('googleSheetsEditor').style.display = 'flex';
            hideLoading();
            showToast('Opened in Google Sheets', 'success');
            return;
        }
        
        // Create new Google Sheet from Excel data
        const binaryData = atob(file.file_data);
        const array = new Uint8Array(binaryData.length);
        for (let i = 0; i < binaryData.length; i++) {
            array[i] = binaryData.charCodeAt(i);
        }
        
        const workbook = XLSX.read(array, { type: 'array' });
        
        // Create new spreadsheet
        const createResponse = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${googleAccessToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                properties: {
                    title: file.filename
                }
            })
        });
        
        if (!createResponse.ok) {
            const errorData = await createResponse.json();
            throw new Error(errorData.error?.message || 'Failed to create spreadsheet');
        }
        
        const spreadsheet = await createResponse.json();
        const spreadsheetId = spreadsheet.spreadsheetId;
        
        console.log(`‚úÖ Created spreadsheet: ${spreadsheetId}`);
        
        // Populate each sheet
        for (let i = 0; i < workbook.SheetNames.length; i++) {
            const sheetName = workbook.SheetNames[i];
            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            console.log(`üìÑ Processing sheet ${i+1}: "${sheetName}" with ${data.length} rows`);
            
            if (data.length > 0) {
                // Add sheet if not exists (skip first sheet as it's created by default)
                if (i > 0) {
                    try {
                        console.log(`üìù Adding sheet: ${sheetName}`);
                        const addSheetResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                requests: [{
                                    addSheet: {
                                        properties: {
                                            title: sheetName
                                        }
                                    }
                                }]
                            })
                        });
                        
                        if (!addSheetResponse.ok) {
                            const errorText = await addSheetResponse.text();
                            console.error('‚ùå Failed to add sheet:', errorText);
                            throw new Error(`Failed to create sheet: ${sheetName}`);
                        }
                        
                        console.log(`‚úÖ Sheet added: ${sheetName}`);
                        
                        // Wait a moment for sheet to be ready
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (addError) {
                        console.error('Error adding sheet:', addError);
                        throw addError;
                    }
                }
                
                // Prepare data for Google Sheets
                // Filter out empty rows
                const cleanData = data.filter(row => row && row.some(cell => cell !== null && cell !== ''));
                
                if (cleanData.length === 0) continue;
                
                // Ensure all rows have same number of columns
                const maxCols = Math.max(...cleanData.map(row => row ? row.length : 0));
                const paddedData = cleanData.map(row => {
                    const newRow = row ? [...row] : [];
                    while (newRow.length < maxCols) newRow.push('');
                    return newRow;
                });
                
                // Calculate column letter
                const colCount = maxCols;
                let colLetter;
                
                if (colCount <= 26) {
                    colLetter = String.fromCharCode(64 + colCount);
                } else {
                    const first = Math.floor((colCount - 1) / 26);
                    const second = (colCount - 1) % 26;
                    colLetter = String.fromCharCode(64 + first) + String.fromCharCode(65 + second);
                }
                
                // CRITICAL FIX: Build URL manually to avoid encoding issues
                // Sheet names with spaces need quotes, but the quotes themselves must NOT be encoded
                const needsQuotes = sheetName.includes(' ') || sheetName.match(/[^a-zA-Z0-9]/);
                const rangePath = needsQuotes 
                    ? `'${sheetName}'!A1:${colLetter}${paddedData.length}`  // Keep quotes as actual characters
                    : `${sheetName}!A1:${colLetter}${paddedData.length}`;
                
                // Build URL with the range as a path component, but don't encode the entire thing
                const baseUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/`;
                
                // Use URL constructor for safe encoding
                const url = new URL(baseUrl + rangePath);
                url.searchParams.append('valueInputOption', 'RAW');
                
                console.log(`üì§ Writing to URL: ${url.toString()}`);
                
                // Write data
                try {
                    const writeResponse = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            values: paddedData
                        })
                    });
                    
                    if (!writeResponse.ok) {
                        const errorText = await writeResponse.text();
                        console.error('‚ùå Write failed:', errorText);
                        
                        // Try alternative approach if this fails
                        if (needsQuotes) {
                            console.log('üîÑ Retrying without quotes in URL...');
                            const altRange = `${sheetName}!A1:${colLetter}${paddedData.length}`;
                            const altUrl = new URL(baseUrl + altRange);
                            altUrl.searchParams.append('valueInputOption', 'RAW');
                            
                            const altResponse = await fetch(altUrl, {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    values: paddedData
                                })
                            });
                            
                            if (!altResponse.ok) {
                                const altError = await altResponse.text();
                                throw new Error(`Both write attempts failed`);
                            }
                            console.log(`‚úÖ Success with alternative URL`);
                        } else {
                            throw new Error(`Write failed: ${errorText.substring(0, 200)}`);
                        }
                    } else {
                        console.log(`‚úÖ Successfully wrote ${paddedData.length} rows to ${sheetName}`);
                    }
                } catch (writeError) {
                    console.error('Error writing to sheet:', writeError);
                    throw writeError;
                }
            }
        }
        
        // Set permissions
        try {
            await fetch(`https://www.googleapis.com/drive/v3/files/${spreadsheetId}/permissions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    role: 'writer',
                    type: 'anyone'
                })
            });
        } catch (permError) {
            console.warn('Could not set public permissions:', permError);
        }
        
        // Save Google Sheet ID to database
        const { error } = await supabase
            .from('shared_excel_files')
            .update({ google_sheet_id: spreadsheetId })
            .eq('id', fileId);
        
        if (error) {
            console.error('Error saving Google Sheet ID:', error);
            showToast('Sheet created but failed to save ID', 'warning');
        }
        
        currentGoogleSheetId = spreadsheetId;
        currentGoogleSheetFileId = fileId;
        document.getElementById('googleSheetsFileName').innerText = file.filename;
        document.getElementById('googleSheetIframe').src = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
        document.getElementById('googleSheetsEditor').style.display = 'flex';
        
        hideLoading();
        showToast('Google Sheet created with all sheets', 'success');
        
    } catch (error) {
        console.error('‚ùå Error opening in Google Sheets:', error);
        hideLoading();
        showToast('Error opening in Google Sheets: ' + error.message, 'error');
    }
}
async function syncFromGoogleSheets() {
    if (!currentGoogleSheetId || !currentGoogleSheetFileId) {
        showToast('No Google Sheet open', 'error');
        return;
    }
    
    showLoading('Syncing from Google Sheets...', true, 60000);
    
    try {
        if (!await ensureGoogleAuth()) {
            hideLoading();
            return;
        }
        
        // Get spreadsheet metadata
        const metadataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}`, {
            headers: {
                'Authorization': `Bearer ${googleAccessToken}`
            }
        });
        
        if (!metadataResponse.ok) {
            throw new Error('Failed to fetch spreadsheet metadata');
        }
        
        const metadata = await metadataResponse.json();
        
        // Create new workbook
        const workbook = XLSX.utils.book_new();
        
        // Get data from each sheet
        for (const sheet of metadata.sheets) {
            const sheetName = sheet.properties.title;
            
            const dataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}/values/${encodeURIComponent(sheetName)}`, {
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`
                }
            });
            
            if (dataResponse.ok) {
                const data = await dataResponse.json();
                
                if (data.values) {
                    const worksheet = XLSX.utils.aoa_to_sheet(data.values);
                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                }
            }
        }
        
        // Convert to base64
        const wbData = XLSX.write(workbook, { type: 'base64' });
        
        // Update in database
        const { error } = await supabase
            .from('shared_excel_files')
            .update({
                file_data: wbData,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentGoogleSheetFileId);
        
        if (error) throw error;
        
        hideLoading();
        showToast('Synced from Google Sheets successfully', 'success');
        
        // Refresh data
        loadAllStudentMarks();
        
    } catch (error) {
        console.error('Error syncing from Google Sheets:', error);
        hideLoading();
        showToast('Error syncing: ' + error.message, 'error');
    }
}

function closeGoogleSheetsEditor() {
    document.getElementById('googleSheetsEditor').style.display = 'none';
    document.getElementById('googleSheetIframe').src = '';
    currentGoogleSheetId = null;
    currentGoogleSheetFileId = null;
}
        // ========== VIEW FILE WITH MULTIPLE SHEETS ==========
        async function viewFile(fileId) {
            const file = sharedFiles.find(f => f.id === fileId);
            if (!file || !file.file_data) { 
                showToast('File not found', 'error'); 
                return; 
            }
            
            showLoading('Opening file...', false, 30000);
            
            try {
                // Decode base64 data
                const binaryData = atob(file.file_data);
                const array = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    array[i] = binaryData.charCodeAt(i);
                }
                
                // Parse Excel workbook
                const workbook = XLSX.read(array, { type: 'array' });
                const sheetNames = workbook.SheetNames;
                
                // Create viewer modal with tabs
                const viewerHtml = `
                    <div class="modal-overlay" id="viewerModal" style="display: flex;">
                        <div class="modal-content" style="max-width: 1400px;">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>
                                    ${file.filename}
                                </h2>
                                <button onclick="closeViewerModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Sheet Tabs -->
                            <div class="flex gap-1 overflow-x-auto pb-2 mb-3 border-b" style="scrollbar-width: thin;">
                                ${sheetNames.map((sheet, index) => `
                                    <button onclick="switchViewerSheet('${sheet.replace(/'/g, "\\'")}', ${index})" 
                                        id="sheet-tab-${index}"
                                        class="sheet-tab px-4 py-2 rounded-t-lg text-sm font-medium transition 
                                        ${index === 0 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                        <i class="fas fa-table mr-1"></i>
                                        ${sheet.length > 25 ? sheet.substr(0,22)+'...' : sheet}
                                    </button>
                                `).join('')}
                            </div>
                            
                            <!-- Sheet Data Container -->
                            <div id="sheetDataContainer" class="overflow-x-auto" style="max-height: 60vh;">
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading sheet data...</p>
                                </div>
                            </div>
                            
                            <!-- Sheet Info -->
                            <div class="mt-3 text-sm text-gray-600 flex justify-between items-center">
                                <span>
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="sheetInfo">${sheetNames.length} sheet(s) total</span>
                                </span>
                                <span id="rowCount" class="text-xs bg-gray-100 px-2 py-1 rounded"></span>
                            </div>
                            
                            <!-- Actions -->
                            <div class="mt-4 flex justify-end gap-2">
                                ${currentRole === 'admin' || currentRole === 'super_admin' ? 
                                    `<button onclick="openInGoogleSheets('${file.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2">
                                        <i class="fab fa-google"></i> Edit in Sheets
                                    </button>` : ''}
                                <button onclick="closeViewerModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove any existing viewer modal
                const existingModal = document.getElementById('viewerModal');
                if (existingModal) existingModal.remove();
                
                // Add to body
                document.body.insertAdjacentHTML('beforeend', viewerHtml);
                
                // Store workbook data for sheet switching
                window.currentViewerWorkbook = workbook;
                window.currentViewerSheetNames = sheetNames;
                
                // Load first sheet
                loadViewerSheet(0);
                
                hideLoading();
                
            } catch (error) {
                console.error('Error viewing file:', error);
                hideLoading();
                showToast('Error viewing file: ' + error.message, 'error');
            }
        }

        function closeViewerModal() {
            const modal = document.getElementById('viewerModal');
            if (modal) modal.remove();
            window.currentViewerWorkbook = null;
            window.currentViewerSheetNames = null;
        }

        function switchViewerSheet(sheetName, index) {
            // Update tab styles
            const sheetCount = window.currentViewerSheetNames.length;
            for (let i = 0; i < sheetCount; i++) {
                const tab = document.getElementById(`sheet-tab-${i}`);
                if (tab) {
                    if (i === index) {
                        tab.className = 'sheet-tab px-4 py-2 rounded-t-lg text-sm font-medium transition bg-blue-600 text-white';
                    } else {
                        tab.className = 'sheet-tab px-4 py-2 rounded-t-lg text-sm font-medium transition bg-gray-200 text-gray-700 hover:bg-gray-300';
                    }
                }
            }
            
            // Load the selected sheet
            loadViewerSheet(index);
        }

        function loadViewerSheet(index) {
            const container = document.getElementById('sheetDataContainer');
            if (!container) return;
            
            const workbook = window.currentViewerWorkbook;
            const sheetNames = window.currentViewerSheetNames;
            
            if (!workbook || !sheetNames || index >= sheetNames.length) {
                container.innerHTML = '<p class="text-center py-8 text-gray-500">Sheet not found</p>';
                return;
            }
            
            const sheetName = sheetNames[index];
            const worksheet = workbook.Sheets[sheetName];
            
            // Convert to HTML with formatting
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (!jsonData || jsonData.length === 0) {
                container.innerHTML = '<p class="text-center py-8 text-gray-500">No data in this sheet</p>';
                document.getElementById('rowCount').innerText = '0 rows';
                return;
            }
            
            // Update row count
            document.getElementById('rowCount').innerText = `${jsonData.length - 1} data rows`;
            document.getElementById('sheetInfo').innerHTML = `Sheet: <span class="font-semibold">${sheetName}</span> ‚Ä¢ ${sheetNames.length} sheet(s) total`;
            
            // Build table with better styling
            let html = '<div class="overflow-x-auto"><table class="excel-viewer-table w-full">';
            
            // Headers
            const headers = jsonData[0] || [];
            html += '<thead><tr>';
            headers.forEach(header => {
                html += `<th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">${header || ''}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Data rows with alternating colors
            for (let i = 1; i < Math.min(jsonData.length, 1000); i++) {
                const row = jsonData[i] || [];
                const rowClass = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                html += `<tr class="${rowClass} hover:bg-blue-50 transition">`;
                
                for (let j = 0; j < headers.length; j++) {
                    const value = row[j] !== undefined && row[j] !== null ? row[j] : '';
                    
                    // Check if it's a mark column
                    const headerLower = String(headers[j] || '').toLowerCase();
                    const isMark = headerLower.includes('mark') || 
                                  headerLower.includes('total') || 
                                  headerLower.includes('final') || 
                                  headerLower.includes('score') ||
                                  headerLower.includes('grade') ||
                                  headerLower.includes('exam');
                    
                    if (isMark && !isNaN(parseFloat(value))) {
                        const num = parseFloat(value);
                        const grade = getGrade(num);
                        html += `<td class="px-4 py-2 text-sm ${grade.color} font-bold">${value}</td>`;
                    } else {
                        html += `<td class="px-4 py-2 text-sm text-gray-700">${value}</td>`;
                    }
                }
                html += '</tr>';
            }
            
            if (jsonData.length > 1000) {
                html += `<tr><td colspan="${headers.length}" class="text-center text-gray-500 py-4 text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    ... and ${jsonData.length - 1000} more rows
                </td></tr>`;
            }
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ========== CLASS FILTER FUNCTIONS ==========
        function toggleClassFilter(classYear) {
            if (selectedClasses.has(classYear)) {
                selectedClasses.delete(classYear);
                document.getElementById(`filter-class-${classYear}`).classList.remove('active');
            } else {
                selectedClasses.add(classYear);
                document.getElementById(`filter-class-${classYear}`).classList.add('active');
            }
            
            updateSelectedClassesDisplay();
            loadSharedFiles();
            updateFilteredCharts();
        }

        function toggleAllClasses() {
            const allClasses = ['2024', '2025', '2026', '2027', '2028', 'other'];
            const allSelected = allClasses.every(c => selectedClasses.has(c));
            
            if (allSelected) {
                selectedClasses.clear();
                allClasses.forEach(c => {
                    document.getElementById(`filter-class-${c}`).classList.remove('active');
                });
            } else {
                allClasses.forEach(c => {
                    selectedClasses.add(c);
                    document.getElementById(`filter-class-${c}`).classList.add('active');
                });
            }
            
            updateSelectedClassesDisplay();
            loadSharedFiles();
            updateFilteredCharts();
        }

        function clearClassFilter() {
            selectedClasses.clear();
            document.querySelectorAll('[id^="filter-class-"]').forEach(el => {
                el.classList.remove('active');
            });
            updateSelectedClassesDisplay();
            loadSharedFiles();
            updateFilteredCharts();
        }

        function updateSelectedClassesDisplay() {
            const container = document.getElementById('selectedClassesDisplay');
            const classNames = {
                '2024': 'March 2024',
                '2025': 'March 2025',
                '2026': 'March 2026',
                '2027': 'March 2027',
                '2028': 'March 2028',
                'other': 'Other'
            };
            
            if (selectedClasses.size === 0) {
                container.innerHTML = '<span class="text-sm text-gray-500">No filters applied - showing all classes</span>';
                return;
            }
            
            let html = '';
            selectedClasses.forEach(c => {
                html += `
                    <span class="selected-class-tag">
                        ${classNames[c] || c}
                        <i class="fas fa-times" onclick="toggleClassFilter('${c}')"></i>
                    </span>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== CLASS SELECTION FOR UPLOAD ==========
        function showClassSelectionModal() {
            pendingFileClasses.clear();
            document.querySelectorAll('.class-option').forEach(opt => {
                opt.classList.remove('selected');
                const checkbox = opt.querySelector('.class-checkbox');
                if (checkbox) {
                    checkbox.style.background = 'white';
                    checkbox.style.color = 'white';
                }
            });
            
            document.getElementById('classModal').style.display = 'flex';
        }

        function toggleClass(classYear) {
            const option = event.currentTarget;
            const checkbox = document.getElementById(`class-check-${classYear}`);
            
            if (pendingFileClasses.has(classYear)) {
                pendingFileClasses.delete(classYear);
                option.classList.remove('selected');
                if (checkbox) {
                    checkbox.style.background = 'white';
                    checkbox.style.color = 'white';
                }
            } else {
                pendingFileClasses.add(classYear);
                option.classList.add('selected');
                if (checkbox) {
                    checkbox.style.background = '#4f46e5';
                    checkbox.style.color = 'white';
                }
            }
        }

        function cancelClassSelection() {
            document.getElementById('classModal').style.display = 'none';
            pendingFileClasses.clear();
            pendingFile = null;
        }

        function confirmClassSelection() {
            if (pendingFileClasses.size === 0) {
                showToast('Please select at least one class', 'error');
                return;
            }
            
            document.getElementById('classModal').style.display = 'none';
            
            const filename = pendingFile.name;
            const classList = Array.from(pendingFileClasses).join('_');
            const fileExt = filename.split('.').pop();
            const baseName = filename.substring(0, filename.lastIndexOf('.'));
            
            pendingFile.finalName = `${baseName}_[${classList}].${fileExt}`;
            pendingFile.classList = Array.from(pendingFileClasses);
            
            showFilePreview(pendingFile);
        }

        // ========== HANDLE EXCEL UPLOAD ==========
        async function handleExcelUpload(input) {
            if (!input.files || input.files.length === 0) return;
            
            const file = input.files[0];
            showLoading('Processing Excel file...', true, 60000);
            
            try {
                debugLog(`üìÅ Processing file: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        debugLog(`üìä Workbook has ${workbook.SheetNames.length} sheets`);
                        
                        pendingFile = {
                            name: file.name,
                            data: XLSX.write(workbook, { type: 'base64' }),
                            workbook: workbook,
                            rowCount: 0
                        };
                        
                        const firstSheet = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheet];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        pendingFile.rowCount = jsonData.length;
                        
                        hideLoading();
                        showClassSelectionModal();
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        hideLoading();
                        showToast('Error processing file: ' + error.message, 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Upload error:', error);
                hideLoading();
                showToast('Error uploading file: ' + error.message, 'error');
            }
        }

        function showFilePreview(fileData) {
            const workbook = fileData.workbook;
            const firstSheet = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheet];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            const classNames = {
                '2024': 'March 2024',
                '2025': 'March 2025',
                '2026': 'March 2026',
                '2027': 'March 2027',
                '2028': 'March 2028',
                'other': 'Other'
            };
            
            const classDisplay = fileData.classList.map(c => classNames[c] || c).join(', ');
            
            let previewHtml = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
            
            if (jsonData.length > 0) {
                previewHtml += '<thead class="bg-gray-50"><tr>';
                (jsonData[0] || []).forEach(header => {
                    previewHtml += `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header || ''}</th>`;
                });
                previewHtml += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                for (let i = 1; i < Math.min(jsonData.length, 11); i++) {
                    const row = jsonData[i] || [];
                    previewHtml += '<tr>';
                    row.forEach(cell => {
                        previewHtml += `<td class="px-3 py-2 text-xs text-gray-500">${cell || ''}</td>`;
                    });
                    previewHtml += '</tr>';
                }
                
                if (jsonData.length > 11) {
                    previewHtml += `<tr><td colspan="${jsonData[0].length}" class="px-3 py-2 text-xs text-gray-400 italic">... and ${jsonData.length - 11} more rows</td></tr>`;
                }
                
                previewHtml += '</tbody></table></div>';
                
                previewHtml = `
                    <div class="mb-3 p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm"><span class="font-semibold">File:</span> ${fileData.finalName || fileData.name}</p>
                        <p class="text-sm"><span class="font-semibold">Classes:</span> ${classDisplay}</p>
                        <p class="text-sm"><span class="font-semibold">Sheets:</span> ${workbook.SheetNames.length}</p>
                        <p class="text-sm"><span class="font-semibold">Rows:</span> ${fileData.rowCount}</p>
                    </div>
                ` + previewHtml;
            }
            
            document.getElementById('filePreview').innerHTML = previewHtml;
            document.getElementById('filePreviewSection').classList.remove('hidden');
        }

        // ========== PUBLISH FILE ==========
        async function publishFile() {
            if (!pendingFile) {
                showToast('No file to publish', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('You must be logged in', 'error');
                return;
            }
            
            showLoading('Publishing file...', true, 60000);
            
            try {
                debugLog(`üì§ Publishing: ${pendingFile.finalName || pendingFile.name}`);
                
                const { data, error } = await supabase
                    .from('shared_excel_files')
                    .insert([{
                        filename: pendingFile.finalName || pendingFile.name,
                        file_data: pendingFile.data,
                        uploaded_by: currentUser.id,
                        uploaded_by_email: currentUser.email,
                        row_count: pendingFile.rowCount || 0,
                        classes: pendingFile.classList ? pendingFile.classList.join(',') : '',
                        uploaded_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                debugLog('‚úÖ File published successfully');
                
                document.getElementById('filePreviewSection').classList.add('hidden');
                document.getElementById('filePreview').innerHTML = '';
                document.getElementById('excelUpload').value = '';
                pendingFile = null;
                pendingFileClasses.clear();
                
                hideLoading();
                showToast('File published successfully', 'success');
                
                loadSharedFiles();
                loadAllStudentMarks();
                
            } catch (error) {
                console.error('Publish error:', error);
                hideLoading();
                showToast('Error publishing file: ' + error.message, 'error');
            }
        }

        function closeFilePreview() {
            document.getElementById('filePreviewSection').classList.add('hidden');
            document.getElementById('filePreview').innerHTML = '';
            pendingFile = null;
            pendingFileClasses.clear();
        }

        // ========== LOGOUT ==========
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            currentRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainPortal').classList.add('hidden');
            showToast('Logged out successfully', 'success');
        }

        // ========== CLEAR SEARCH ==========
        function clearSearch() {
            document.getElementById('studentSearchInput').value = '';
            document.getElementById('studentResultsContainer').classList.add('hidden');
            document.getElementById('studentResultsTable').innerHTML = '';
        }

        // ========== LOAD SHARED FILES ==========
        async function loadSharedFiles() {
            try {
                const { data: files, error } = await supabase
                    .from('shared_excel_files')
                    .select('*')
                    .order('uploaded_at', { ascending: false });
                
                if (error) throw error;
                
                sharedFiles = files || [];
                
                let filteredFiles = sharedFiles;
                if (selectedClasses.size > 0) {
                    filteredFiles = filteredFiles.filter(file => {
                        if (!file.classes) return false;
                        const fileClasses = file.classes.split(',');
                        return Array.from(selectedClasses).some(c => fileClasses.includes(c));
                    });
                }
                
                const container = document.getElementById('sharedFilesContainer');
                document.getElementById('filteredFileCount').innerText = filteredFiles.length;
                
                if (filteredFiles.length === 0) {
                    container.innerHTML = `<div class="col-span-3 text-center py-8 text-gray-500 text-sm">No files match the selected filters</div>`;
                    return;
                }
                
                container.innerHTML = filteredFiles.map(file => {
                    const date = new Date(file.uploaded_at).toLocaleString();
                    const canEdit = currentRole === 'admin' || currentRole === 'super_admin';
                    
                    const fileClasses = file.classes ? file.classes.split(',') : [];
                    const classNames = {
                        '2024': 'March 2024',
                        '2025': 'March 2025',
                        '2026': 'March 2026',
                        '2027': 'March 2027',
                        '2028': 'March 2028',
                        'other': 'Other'
                    };
                    
                    const classDisplay = fileClasses.map(c => classNames[c] || c).join(', ');
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition bg-white">
                            <div class="flex items-start">
                                <i class="fas fa-file-excel text-green-600 text-2xl mr-3"></i>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <p class="font-semibold text-gray-800 text-sm truncate" title="${file.filename}">${file.filename}</p>
                                    </div>
                                    <div class="flex items-center mt-1 text-xs gap-1 flex-wrap">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${file.row_count || 0} records</span>
                                        <span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">${classDisplay}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1"><i class="fas fa-user mr-1"></i>${file.uploaded_by_email || 'Unknown'} ‚Ä¢ ${date}</p>
                                    <div class="mt-2 flex gap-1 flex-wrap">
                                        ${canEdit ? `<button onclick="openInGoogleSheets('${file.id}')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700"><i class="fab fa-google mr-1"></i>Edit</button>` : ''}
                                        <button onclick="viewFile('${file.id}')" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700"><i class="fas fa-eye mr-1"></i>View</button>
                                        ${canEdit ? `<button onclick="deleteFile('${file.id}', '${file.filename}')" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700"><i class="fas fa-trash mr-1"></i>Delete</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) { 
                debugLog('‚ùå Error loading files: ' + error.message);
                console.error(error); 
            }
        }

        // ========== DELETE FILE ==========
        async function deleteFile(fileId, filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"? This cannot be undone.`)) {
                return;
            }
            
            showLoading('Deleting file...', false, 30000);
            
            try {
                const { error } = await supabase
                    .from('shared_excel_files')
                    .delete()
                    .eq('id', fileId);
                
                if (error) throw error;
                
                hideLoading();
                showToast('File deleted successfully', 'success');
                
                loadSharedFiles();
                loadAllStudentMarks();
                
            } catch (error) {
                console.error('Delete error:', error);
                hideLoading();
                showToast('Error deleting file: ' + error.message, 'error');
            }
        }

        // ========== LOGIN FUNCTION ==========
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { showToast('Enter email and password', 'error'); return; }
            
            showLoading('Logging in...', false, 10000);
            
            try {
                debugLog('üîê Attempting login for: ' + email);
                
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({ 
                    email, 
                    password 
                });
                
                if (authError) throw authError;
                
                debugLog('‚úÖ Auth successful for: ' + authData.user.email);
                
                const { data: profile, error: profileError } = await supabase
                    .from('consolidated_user_profiles_table')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (profileError) {
                    debugLog('üìù Creating new profile...');
                    const { data: newProfile, error: createError } = await supabase
                        .from('consolidated_user_profiles_table')
                        .insert([{
                            email: email,
                            full_name: email.split('@')[0],
                            role: email.includes('admin') ? 'admin' : 'lecturer',
                            department: 'Nursing',
                            is_active: true,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (createError) throw createError;
                    
                    currentUser = newProfile;
                    currentRole = newProfile.role;
                } else {
                    currentUser = profile;
                    currentRole = profile.role;
                }
                
                debugLog('‚úÖ User role: ' + currentRole);
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainPortal').classList.remove('hidden');
                
                document.getElementById('userDisplayName').innerHTML = `<i class="fas fa-user mr-1"></i>${currentUser.full_name || currentUser.email}`;
                document.getElementById('userEmailDisplay').innerText = currentUser.email;
                document.getElementById('userRoleDisplay').innerText = currentRole.replace('_', ' ').toUpperCase();
                
                const badge = document.getElementById('userRoleBadge');
                badge.innerText = currentRole.replace('_', ' ').toUpperCase();
                
                if (currentRole === 'admin' || currentRole === 'super_admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminSearchSection').classList.remove('hidden');
                } else {
                    document.getElementById('adminDashboard').classList.add('hidden');
                    document.getElementById('adminSearchSection').classList.add('hidden');
                }
                
                hideLoading();
                showToast('Login successful!', 'success');
                
                setTimeout(() => { 
                    loadSharedFiles(); 
                    loadAllStudentMarks(); 
                }, 100);
                
            } catch (error) {
                debugLog('‚ùå Login error: ' + error.message);
                hideLoading();
                showToast(error.message, 'error');
            }
        }

      // ========== LOAD ALL STUDENT MARKS (COMPREHENSIVE FIX) ==========
async function loadAllStudentMarks() {
    if (isProcessing) {
        processingQueue.push(loadAllStudentMarks);
        return;
    }
    
    isProcessing = true;
    showLoading('Loading data from Excel files...', true, 120000);
    
    try {
        debugLog('üì° Fetching files from Supabase...');
        
        const { data: files, error } = await supabase
            .from('shared_excel_files')
            .select('id, filename, file_data, uploaded_by_email, uploaded_at, classes')
            .order('uploaded_at', { ascending: false });
        
        if (error) throw error;
        
        if (!files || files.length === 0) {
            debugLog('‚ö†Ô∏è No files found');
            document.getElementById('totalFilesStats').innerText = '0';
            document.getElementById('totalRecordsStats').innerText = '0';
            hideLoading();
            isProcessing = false;
            return;
        }
        
        debugLog(`üìÅ Found ${files.length} files`);
        sharedFiles = files;
        
        allStudentMarks = [];
        studentIndex.clear();
        
        // Define all possible assessment patterns
        const clinicalRotationPatterns = [
            'MED', 'MCH', 'MAT', 'PEAD', 'SURG', 'OPD', 'NBU', 'THEATRE', 
            'PSYCHIATRY', 'RURALS', 'DISTRICT', 'SPECIAL CLINICS'
        ];
        
        const clinicalAssessmentPatterns = [
            'PREGNANT WOMAN', 'IMMUNIZATION', 'NURSING CARE', 'PSYCHIATRY assesment',
            'PSYCHIATRY CASE STUDY', 'GENERAL NURSING CASE STUDY', 'MIDWIFERY CASE STUDY',
            'MCH CASE STUDY', 'PROJECT'
        ];
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const progress = (i / files.length) * 100;
            updateProgress(progress);
            
            debugLog(`\nüìä Processing file ${i+1}/${files.length}: ${file.filename}`);
            document.getElementById('loadingMessage').innerText = `Processing: ${file.filename}`;
            
            if (!file.file_data) {
                debugLog(`‚ö†Ô∏è File ${i+1} has no data, skipping`);
                continue;
            }
            
            try {
                // Decode base64 data
                const binaryData = atob(file.file_data);
                const array = new Uint8Array(binaryData.length);
                for (let j = 0; j < binaryData.length; j++) {
                    array[j] = binaryData.charCodeAt(j);
                }
                
                // Parse Excel workbook
                const workbook = XLSX.read(array, { type: 'array' });
                debugLog(`üìö Workbook has ${workbook.SheetNames.length} sheets: ${workbook.SheetNames.join(', ')}`);
                
                // Detect file type based on sheet names
                const isClinicalRotationsFile = workbook.SheetNames.some(name => 
                    name.includes('XY FORMS') || name.includes('MARCH 2024') || name.includes('CASE STUDY')
                );
                
                const isUnitsPerSheetFile = workbook.SheetNames.length > 3 && 
                    workbook.SheetNames.every(name => 
                        !name.includes('MARCH') && !name.includes('XY') && !name.includes('Sheet')
                    );
                
                debugLog(`üìã File type: ${isClinicalRotationsFile ? 'Clinical Rotations' : isUnitsPerSheetFile ? 'Units per Sheet' : 'Mixed/Unknown'}`);
                
                // Process each sheet
                for (const sheetName of workbook.SheetNames) {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    debugLog(`\nüìÑ Processing sheet: "${sheetName}" - ${jsonData.length} rows`);
                    
                    if (!jsonData || jsonData.length < 2) continue;
                    
                    // Find header row - look for rows with student-related headers
                    let headerRowIndex = -1;
                    for (let r = 0; r < Math.min(10, jsonData.length); r++) {
                        const row = jsonData[r];
                        if (!row) continue;
                        
                        const rowStr = row.join(' ').toLowerCase();
                        if (rowStr.includes('student') || rowStr.includes('name') || 
                            rowStr.includes('s.no') || rowStr.includes('sn no')) {
                            headerRowIndex = r;
                            break;
                        }
                    }
                    
                    if (headerRowIndex === -1) {
                        debugLog(`‚ö†Ô∏è No header row found in sheet "${sheetName}", skipping`);
                        continue;
                    }
                    
                    const headers = jsonData[headerRowIndex] || [];
                    debugLog(`üìã Headers: ${headers.map(h => String(h).substring(0, 20)).join(' | ')}`);
                    
                    // Process each data row
                    for (let r = headerRowIndex + 1; r < jsonData.length; r++) {
                        const row = jsonData[r];
                        if (!row || row.length === 0) continue;
                        
                        // Skip empty rows
                        if (row.every(cell => !cell || String(cell).trim() === '')) continue;
                        
                        // Extract student name (usually in column B or first column with text)
                        let studentName = '';
                        let studentId = '';
                        let indexNumber = '';
                        
                        // Try to find name and ID
                        for (let col = 0; col < Math.min(5, row.length); col++) {
                            const header = headers[col] ? String(headers[col]).toLowerCase() : '';
                            const cellValue = row[col];
                            
                            if (!cellValue) continue;
                            
                            const valueStr = String(cellValue).trim();
                            
                            // Check for name columns
                            if (header.includes('name') || header.includes('student')) {
                                if (valueStr.length > 2 && !valueStr.match(/^\d+$/)) {
                                    studentName = valueStr;
                                }
                            }
                            
                            // Check for index number
                            if (header.includes('index') || header.includes('adm')) {
                                if (valueStr.length > 0) {
                                    indexNumber = valueStr;
                                }
                            }
                            
                            // Check for ID number
                            if (header.includes('id') || header.includes('reg')) {
                                if (valueStr.length > 0) {
                                    studentId = valueStr;
                                }
                            }
                        }
                        
                        // If no name found in named columns, try first non-numeric column
                        if (!studentName) {
                            for (let col = 0; col < Math.min(3, row.length); col++) {
                                const cellValue = row[col];
                                if (cellValue) {
                                    const valueStr = String(cellValue).trim();
                                    if (valueStr.length > 3 && !valueStr.match(/^\d+$/)) {
                                        studentName = valueStr;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Skip if no student name found
                        if (!studentName) continue;
                        
                        // Create record for this student
                        const record = {
                            fileId: file.id,
                            filename: file.filename,
                            sheetName: sheetName,
                            studentName: studentName,
                            studentId: studentId || indexNumber || '',
                            indexNumber: indexNumber,
                            rawData: {},
                            marks: []
                        };
                        
                        // Store all raw data
                        headers.forEach((header, colIdx) => {
                            if (header) {
                                record.rawData[String(header)] = row[colIdx];
                            }
                        });
                        
                        // EXTRACT MARKS based on file type
                        
                        // For Clinical Rotations File (XY FORMS)
                        if (isClinicalRotationsFile && sheetName.includes('XY FORMS')) {
                            // This is the rotations sheet with MAT, PEAD, SURG etc.
                            const rotationColumns = [
                                'MAT 1', 'MAT 2', 'MAT 3',
                                'PEAD 1', 'PEAD2[ward mgt]',
                                'SURG 1 GEN', 'SURG 2 GYNA', 'SURG 3 ORTHO',
                                'OPD/CASUALITY', 'NBU 1', 'NBU 2', 'THEATRE',
                                'PSYCHIATRY', 'RURALS', 'DISTRICT', 'SPECIAL CLINICS',
                                'MED 2', 'MED  3 {Ward mgt}', 'MCH 1', 'MCH 2', 'MCH 3'
                            ];
                            
                            headers.forEach((header, colIdx) => {
                                if (!header) return;
                                
                                const headerStr = String(header).trim();
                                const cellValue = row[colIdx];
                                
                                // Check if this column is a rotation
                                const isRotation = rotationColumns.some(rot => 
                                    headerStr.includes(rot) || rot.includes(headerStr)
                                );
                                
                                if (isRotation && cellValue) {
                                    const numValue = parseFloat(cellValue);
                                    if (!isNaN(numValue) && numValue > 0) {
                                        record.marks.push({
                                            subject: `Clinical Rotation - ${headerStr}`,
                                            assessmentType: 'CLINICAL ROTATION',
                                            mark: numValue,
                                            grade: getGrade(numValue),
                                            originalColumn: headerStr,
                                            category: 'rotation'
                                        });
                                    }
                                }
                            });
                        }
                        
                        // For Case Study Project Sheet
                        if (isClinicalRotationsFile && sheetName.includes('CASE STUDY')) {
                            // This is the assessments sheet
                            const assessmentColumns = [
                                'PREGNANT WOMAN ASSESMENT', 'IMMUNIZATION', 'NURSING CARE',
                                'PSYCHIATRY assesment', 'PSYCHIATRY CASE STUDY',
                                'GENERAL NURSING CASE STUDY', 'MIDWIFERY CASE STUDY',
                                'MCH CASE STUDY', 'PROJECT'
                            ];
                            
                            headers.forEach((header, colIdx) => {
                                if (!header) return;
                                
                                const headerStr = String(header).trim();
                                const cellValue = row[colIdx];
                                
                                // Check if this is an assessment column
                                const isAssessment = assessmentColumns.some(ass => 
                                    headerStr.includes(ass) || ass.includes(headerStr)
                                );
                                
                                if (isAssessment && cellValue) {
                                    const numValue = parseFloat(cellValue);
                                    if (!isNaN(numValue) && numValue > 0) {
                                        record.marks.push({
                                            subject: headerStr,
                                            assessmentType: 'CLINICAL ASSESSMENT',
                                            mark: numValue,
                                            grade: getGrade(numValue),
                                            originalColumn: headerStr,
                                            category: 'assessment'
                                        });
                                    }
                                }
                            });
                        }
                        
                        // For Units per Sheet File (each sheet is a different unit)
                        if (isUnitsPerSheetFile) {
                            // The sheet name itself is the unit/subject
                            const unitName = sheetName;
                            
                            headers.forEach((header, colIdx) => {
                                if (!header) return;
                                
                                const headerStr = String(header).toLowerCase();
                                const cellValue = row[colIdx];
                                
                                // Skip name, SN, and other non-mark columns
                                if (headerStr.includes('name') || headerStr.includes('s.no') || 
                                    headerStr.includes('sn') || headerStr.includes('adm') ||
                                    headerStr.includes('index') || headerStr.includes('id')) {
                                    return;
                                }
                                
                                if (cellValue) {
                                    const numValue = parseFloat(cellValue);
                                    if (!isNaN(numValue) && numValue > 0 && numValue <= 100) {
                                        // Determine assessment type from header
                                        let assessmentType = 'EXAM';
                                        if (headerStr.includes('cat')) assessmentType = 'CAT';
                                        else if (headerStr.includes('ebe')) assessmentType = 'EBE';
                                        else if (headerStr.includes('final')) assessmentType = 'FINAL';
                                        else if (headerStr.includes('practical')) assessmentType = 'PRACTICAL';
                                        
                                        record.marks.push({
                                            subject: unitName,
                                            assessmentType: assessmentType,
                                            mark: numValue,
                                            grade: getGrade(numValue),
                                            originalColumn: String(header),
                                            category: 'unit'
                                        });
                                    }
                                }
                            });
                        }
                        
                        // Always look for FINAL CLINICAL SCORE column
                        headers.forEach((header, colIdx) => {
                            if (!header) return;
                            
                            const headerStr = String(header).toLowerCase();
                            if (headerStr.includes('final clinical score') || headerStr.includes('final score')) {
                                const cellValue = row[colIdx];
                                if (cellValue) {
                                    const numValue = parseFloat(cellValue);
                                    if (!isNaN(numValue) && numValue > 0) {
                                        record.marks.push({
                                            subject: 'FINAL CLINICAL SCORE',
                                            assessmentType: 'FINAL',
                                            mark: numValue,
                                            grade: getGrade(numValue),
                                            originalColumn: String(header),
                                            category: 'final',
                                            isFinal: true
                                        });
                                    }
                                }
                            }
                        });
                        
                        // Add record if it has marks or is a valid student
                        if (record.marks.length > 0) {
                            const studentKey = studentName.toLowerCase();
                            
                            if (!studentIndex.has(studentKey)) {
                                studentIndex.set(studentKey, []);
                            }
                            
                            studentIndex.get(studentKey).push(record);
                            allStudentMarks.push(record);
                            
                            // Debug first few records
                            if (allStudentMarks.length <= 20) {
                                debugLog(`  ‚úÖ Added: ${studentName} - ${record.marks.length} marks from "${sheetName}"`);
                                record.marks.forEach(m => {
                                    debugLog(`     - ${m.subject}: ${m.mark} (${m.assessmentType})`);
                                });
                            }
                        }
                    }
                }
                
            } catch (fileError) {
                debugLog(`‚ùå Error processing file ${file.filename}: ${fileError.message}`);
                console.error(fileError);
            }
        }
        
        debugLog(`\n‚úÖ FINAL: ${allStudentMarks.length} total student records`);
        
        const totalMarks = allStudentMarks.reduce((sum, r) => sum + r.marks.length, 0);
        debugLog(`üìä Total marks extracted: ${totalMarks}`);
        
        // Update stats
        document.getElementById('totalFilesStats').innerText = files.length;
        document.getElementById('totalRecordsStats').innerText = allStudentMarks.length;
        
        updateStatsAndCharts();
        hideLoading();
        isProcessing = false;
        
        if (processingQueue.length > 0) {
            const next = processingQueue.shift();
            setTimeout(next, 100);
        }
        
        showToast(`Successfully loaded ${allStudentMarks.length} student records with ${totalMarks} marks`, 'success');
        
    } catch (error) {
        console.error('Error loading student marks:', error);
        hideLoading();
        isProcessing = false;
        showToast('Error loading data: ' + error.message, 'error');
    }
}
        // ========== UPDATE STATS AND CHARTS ==========
        function updateStatsAndCharts() {
            try {
                // Filter marks based on selected classes
                let filteredMarks = allStudentMarks;
                
                if (selectedClasses.size > 0) {
                    filteredMarks = filteredMarks.filter(mark => {
                        const file = sharedFiles.find(f => f.id === mark.fileId);
                        if (!file || !file.classes) return false;
                        const fileClasses = file.classes.split(',');
                        return Array.from(selectedClasses).some(c => fileClasses.includes(c));
                    });
                }
                
                // Update chart filter badges
                const classNames = Array.from(selectedClasses).map(c => {
                    const map = {'2024':'Mar24','2025':'Mar25','2026':'Mar26','2027':'Mar27','2028':'Mar28','other':'Other'};
                    return map[c] || c;
                }).join(', ');
                
                document.getElementById('chartFilterBadge').innerText = selectedClasses.size > 0 ? classNames : 'All Classes';
                document.getElementById('barChartFilterBadge').innerText = selectedClasses.size > 0 ? classNames : 'All Classes';
                
                // Calculate grade distribution
                let gradeCounts = { A: 0, B: 0, C: 0, D: 0 };
                let markRanges = { '0-59': 0, '60-74': 0, '75-84': 0, '85-100': 0 };
                
                filteredMarks.forEach(record => {
                    record.marks.forEach(m => {
                        if (m.grade.grade === 'A') gradeCounts.A++;
                        else if (m.grade.grade === 'B') gradeCounts.B++;
                        else if (m.grade.grade === 'C') gradeCounts.C++;
                        else gradeCounts.D++;
                        
                        if (m.mark < 60) markRanges['0-59']++;
                        else if (m.mark < 75) markRanges['60-74']++;
                        else if (m.mark < 85) markRanges['75-84']++;
                        else markRanges['85-100']++;
                    });
                });
                
                // Update pie chart
                const ctx1 = document.getElementById('performanceChart').getContext('2d');
                if (performanceChart) performanceChart.destroy();
                
                performanceChart = new Chart(ctx1, {
                    type: 'pie',
                    data: {
                        labels: ['A (85-100)', 'B (75-84)', 'C (60-74)', 'D (0-59)'],
                        datasets: [{
                            data: [gradeCounts.A, gradeCounts.B, gradeCounts.C, gradeCounts.D],
                            backgroundColor: ['#4F46E5', '#059669', '#D97706', '#DC2626'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
                
                // Update bar chart
                const ctx2 = document.getElementById('distributionChart').getContext('2d');
                if (distributionChart) distributionChart.destroy();
                
                distributionChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['0-59 (D)', '60-74 (C)', '75-84 (B)', '85-100 (A)'],
                        datasets: [{
                            label: 'Number of Marks',
                            data: [markRanges['0-59'], markRanges['60-74'], markRanges['75-84'], markRanges['85-100']],
                            backgroundColor: ['#DC2626', '#D97706', '#059669', '#4F46E5'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, grid: { display: false } }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        function updateFilteredCharts() {
            updateStatsAndCharts();
        }

// ========== SEARCH STUDENT MARKS ==========
function searchStudentMarks() {
    const searchTerm = document.getElementById('studentSearchInput').value.trim().toLowerCase();
    if (!searchTerm) {
        showToast('Please enter a search term', 'error');
        return;
    }
    
    showLoading('Searching...', false, 30000);
    
    try {
        console.log('üîç Searching for:', searchTerm);
        console.log('Total records in allStudentMarks:', allStudentMarks.length);
        
        // Search for the student across ALL records
        let results = [];
        
        allStudentMarks.forEach(record => {
            let found = false;
            
            // Check student name
            if (record.studentName) {
                const nameLower = record.studentName.toLowerCase();
                if (nameLower.includes(searchTerm)) {
                    found = true;
                }
            }
            
            // Check student ID/Admission
            if (record.studentId) {
                const idLower = record.studentId.toLowerCase();
                if (idLower.includes(searchTerm)) {
                    found = true;
                }
            }
            
            // Check raw data
            if (record.rawData && !found) {
                Object.values(record.rawData).forEach(value => {
                    const valStr = String(value || '').toLowerCase();
                    if (valStr.includes(searchTerm)) {
                        found = true;
                    }
                });
            }
            
            if (found) {
                results.push(record);
            }
        });
        
        console.log(`Found ${results.length} records for student`);
        
        if (results.length === 0) {
            hideLoading();
            showToast('No results found', 'info');
            document.getElementById('studentResultsContainer').classList.add('hidden');
            return;
        }
        
        // Get student info
        let studentName = '';
        let studentId = '';
        let studentIndex = '';
        
        results.forEach(record => {
            if (record.studentName && !studentName) {
                studentName = record.studentName;
            }
            if (record.studentId && !studentId) {
                studentId = record.studentId;
            }
            // Try to extract index from raw data
            if (record.rawData) {
                Object.entries(record.rawData).forEach(([key, value]) => {
                    const keyLower = String(key).toLowerCase();
                    if (keyLower.includes('index') && value) {
                        studentIndex = String(value);
                    }
                });
            }
        });
        
        if (!studentName) studentName = searchTerm;
        if (!studentId) studentId = studentIndex || 'N/A';
        
        // Define the 10 theory subjects from BLOCK file
        const theorySubjectNames = [
            'MIDWIFERY',
            'PHARMACOLOGY II',
            'SPECIALISED N P',
            'HEMATOLOGICAL CONDITIONS',
            'RESPIRATORY CONDITIONS',
            'IMMUNIZATION',
            'TRAUMA',
            'SRH',
            'COMMUNITY HEALTH RESULTS NURSIN',
            'CARDIOVASCULAR RESULTS'
        ];
        
        // Store theory subjects by sheet name
        const theorySubjects = new Map();
        
        // Store clinical marks separately
        const clinicalMarks = [];
        
        // Process each record
        results.forEach(record => {
            const sheetName = record.sheetName;
            const filename = record.filename;
            
            // Check if this is a theory subject sheet
            const isTheorySubject = theorySubjectNames.includes(sheetName) || 
                                    sheetName.includes('MIDWIFERY') ||
                                    sheetName.includes('PHARMACOLOGY') ||
                                    sheetName.includes('SPECIALISED') ||
                                    sheetName.includes('HEMATOLOGICAL') ||
                                    sheetName.includes('RESPIRATORY') ||
                                    sheetName.includes('IMMUNIZATION') ||
                                    sheetName.includes('TRAUMA') ||
                                    sheetName.includes('SRH') ||
                                    sheetName.includes('COMMUNITY') ||
                                    sheetName.includes('CARDIOVASCULAR');
            
            if (isTheorySubject) {
                // Initialize subject if not exists
                if (!theorySubjects.has(sheetName)) {
                    theorySubjects.set(sheetName, {
                        name: sheetName,
                        catMarks: [],
                        ebeMarks: [],
                        finalMarks: [],
                        allMarks: [],
                        files: new Set()
                    });
                }
                
                const subject = theorySubjects.get(sheetName);
                subject.files.add(filename);
                
                // Extract marks from this record
                if (record.marks && record.marks.length > 0) {
                    record.marks.forEach(mark => {
                        // Skip non-mark columns like S/N, REMARKS, etc.
                        const subjectLower = mark.subject.toLowerCase();
                        if (subjectLower.includes('s/n') || subjectLower.includes('s.no') || 
                            subjectLower.includes('remarks') || subjectLower.includes('admission')) {
                            return;
                        }
                        
                        subject.allMarks.push(mark);
                        
                        // Categorize by assessment type
                        if (mark.assessmentType === 'CAT' || subjectLower.includes('cat')) {
                            subject.catMarks.push(mark.mark);
                        } else if (mark.assessmentType === 'EBE' || subjectLower.includes('ebe')) {
                            subject.ebeMarks.push(mark.mark);
                        } else if (mark.assessmentType === 'FINAL' || subjectLower.includes('final')) {
                            subject.finalMarks.push(mark.mark);
                        }
                    });
                }
            } else {
                // This is a clinical/NCK record - store individual marks
                if (record.marks && record.marks.length > 0) {
                    record.marks.forEach(mark => {
                        // Skip non-mark columns
                        const subjectLower = mark.subject.toLowerCase();
                        if (subjectLower.includes('s/n') || subjectLower.includes('s.no') || 
                            subjectLower.includes('remarks') || subjectLower.includes('admission')) {
                            return;
                        }
                        
                        clinicalMarks.push({
                            name: mark.subject,
                            mark: mark.mark,
                            grade: getGrade(mark.mark),
                            assessmentType: mark.assessmentType,
                            sheetName: sheetName,
                            filename: filename,
                            passed: mark.mark >= 60
                        });
                    });
                }
            }
        });
        
        // Build theory subjects list
        const theorySubjectsList = [];
        theorySubjects.forEach((subject, name) => {
            // Get unique marks (in case of duplicates)
            const uniqueCat = [...new Set(subject.catMarks)];
            const uniqueEbe = [...new Set(subject.ebeMarks)];
            const uniqueFinal = [...new Set(subject.finalMarks)];
            
            // Use the FINAL mark as the subject score
            let finalScore = null;
            if (uniqueFinal.length > 0) {
                finalScore = uniqueFinal[0];
            } else if (uniqueEbe.length > 0) {
                finalScore = uniqueEbe[0];
            } else if (uniqueCat.length > 0) {
                finalScore = uniqueCat[0];
            }
            
            if (finalScore !== null) {
                const grade = getGrade(finalScore);
                const passed = finalScore >= 60;
                
                // Create assessment display
                const parts = [];
                if (uniqueCat.length > 0) parts.push(`CAT: ${uniqueCat.join(', ')}`);
                if (uniqueEbe.length > 0) parts.push(`EBE: ${uniqueEbe.join(', ')}`);
                if (uniqueFinal.length > 0) parts.push(`FINAL: ${uniqueFinal.join(', ')}`);
                
                theorySubjectsList.push({
                    name: name,
                    assessmentDisplay: parts.join(' | '),
                    finalScore: finalScore,
                    grade: grade,
                    passed: passed,
                    catMarks: uniqueCat,
                    ebeMarks: uniqueEbe,
                    finalMarks: uniqueFinal,
                    files: Array.from(subject.files)
                });
            }
        });
        
        // Sort theory subjects by name
        theorySubjectsList.sort((a, b) => a.name.localeCompare(b.name));
        
        // Sort clinical marks by name
        clinicalMarks.sort((a, b) => a.name.localeCompare(b.name));
        
        // Calculate overall stats (using theory subjects only)
        const totalTheoryScore = theorySubjectsList.reduce((sum, s) => sum + s.finalScore, 0);
        const avgOverall = theorySubjectsList.length > 0 ? totalTheoryScore / theorySubjectsList.length : 0;
        const totalPoints = theorySubjectsList.reduce((sum, s) => sum + s.grade.points, 0);
        const gpa = theorySubjectsList.length > 0 ? (totalPoints / theorySubjectsList.length).toFixed(2) : '0.00';
        const overallGrade = getGrade(avgOverall);
        
        // Store for transcript
        currentTranscriptData = {
            studentName: studentName,
            studentId: studentId,
            studentIndex: studentIndex,
            theorySubjects: theorySubjectsList,
            clinicalMarks: clinicalMarks,
            avgOverall: avgOverall,
            overallGrade: overallGrade,
            gpa: gpa,
            totalPoints: totalPoints
        };
        
        // Update summary card
        document.getElementById('studentNameDisplay').innerText = studentName;
        
        let idDisplay = `Admission: ${studentId}`;
        if (studentIndex && studentIndex !== studentId) {
            idDisplay += ` | Index: ${studentIndex}`;
        }
        document.getElementById('studentIdDisplay').innerHTML = `<i class="fas fa-id-card mr-1"></i>${idDisplay}`;
        document.getElementById('studentProgramDisplay').innerHTML = `<i class="fas fa-graduation-cap mr-1"></i>Program: KRCHN`;
        
        document.getElementById('overallGradeDisplay').innerText = `Grade: ${overallGrade.grade}`;
        document.getElementById('overallGradeDisplay').className = `grade-badge ${overallGrade.class} text-sm px-4 py-2`;
        
        document.getElementById('gpaDisplay').innerHTML = `<i class="fas fa-star mr-1"></i>GPA: ${gpa}`;
        
        document.getElementById('totalExamsCount').innerText = theorySubjectsList.length;
        document.getElementById('averageMarkDisplay').innerText = avgOverall.toFixed(1);
        document.getElementById('totalPointsDisplay').innerText = totalPoints;
        document.getElementById('gpaValueDisplay').innerText = gpa;
        
        // Build results table
        let tableHtml = '';
        
        // Theory Subjects Table
        if (theorySubjectsList.length > 0) {
            tableHtml += `
                <div class="mb-6">
                    <h4 class="font-bold text-blue-800 mb-2 text-lg">üìö THEORY SUBJECTS (${theorySubjectsList.length})</h4>
                    <table class="data-table w-full">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>CAT</th>
                                <th>EBE</th>
                                <th>FINAL</th>
                                <th>Final Score</th>
                                <th>Grade</th>
                                <th>Points</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            theorySubjectsList.forEach(s => {
                const catDisplay = s.catMarks.length > 0 ? s.catMarks.join(', ') : '-';
                const ebeDisplay = s.ebeMarks.length > 0 ? s.ebeMarks.join(', ') : '-';
                const finalDisplay = s.finalMarks.length > 0 ? s.finalMarks.join(', ') : '-';
                
                tableHtml += `
                    <tr class="${s.passed ? '' : 'bg-red-50'}">
                        <td class="font-medium">${s.name}</td>
                        <td class="text-center">${catDisplay}</td>
                        <td class="text-center">${ebeDisplay}</td>
                        <td class="text-center font-bold">${finalDisplay}</td>
                        <td class="font-bold ${s.grade.color} text-center">${s.finalScore.toFixed(1)}</td>
                        <td class="text-center"><span class="grade-badge ${s.grade.class}">${s.grade.grade}</span></td>
                        <td class="text-center">${s.grade.points}</td>
                        <td class="text-center"><span class="status-badge ${s.passed ? 'status-pass' : 'status-fail'}">${s.passed ? 'PASS' : 'FAIL'}</span></td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Clinical Assessments Table
        if (clinicalMarks.length > 0) {
            tableHtml += `
                <div class="mb-6">
                    <h4 class="font-bold text-green-800 mb-2 text-lg">üè• CLINICAL ROTATIONS & ASSESSMENTS (${clinicalMarks.length})</h4>
                    <table class="data-table w-full">
                        <thead>
                            <tr>
                                <th>Assessment/Rotation</th>
                                <th>Mark</th>
                                <th>Grade</th>
                                <th>Points</th>
                                <th>Status</th>
                                <th>Source Sheet</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            clinicalMarks.forEach(m => {
                tableHtml += `
                    <tr class="${m.passed ? '' : 'bg-red-50'}">
                        <td class="font-medium">${m.name}</td>
                        <td class="font-bold ${m.grade.color} text-center">${m.mark.toFixed(1)}</td>
                        <td class="text-center"><span class="grade-badge ${m.grade.class}">${m.grade.grade}</span></td>
                        <td class="text-center">${m.grade.points}</td>
                        <td class="text-center"><span class="status-badge ${m.passed ? 'status-pass' : 'status-fail'}">${m.passed ? 'PASS' : 'FAIL'}</span></td>
                        <td class="text-xs">${m.sheetName}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Summary Statistics
        const theoryPassCount = theorySubjectsList.filter(s => s.passed).length;
        const theoryFailCount = theorySubjectsList.length - theoryPassCount;
        const clinicalPassCount = clinicalMarks.filter(m => m.passed).length;
        const clinicalFailCount = clinicalMarks.length - clinicalPassCount;
        
        tableHtml += `
            <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-600">Theory Subjects</div>
                    <div class="text-xl font-bold">${theorySubjectsList.length}</div>
                    <div class="text-xs"><span class="text-green-600">${theoryPassCount} pass</span> | <span class="text-red-600">${theoryFailCount} fail</span></div>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-600">Clinical Assessments</div>
                    <div class="text-xl font-bold">${clinicalMarks.length}</div>
                    <div class="text-xs"><span class="text-green-600">${clinicalPassCount} pass</span> | <span class="text-red-600">${clinicalFailCount} fail</span></div>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-600">Total Marks</div>
                    <div class="text-xl font-bold">${theorySubjectsList.reduce((sum, s) => sum + s.catMarks.length + s.ebeMarks.length + s.finalMarks.length, 0) + clinicalMarks.length}</div>
                </div>
                <div class="bg-orange-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-600">GPA (Theory)</div>
                    <div class="text-xl font-bold">${gpa}</div>
                </div>
            </div>
        `;
        
        // Data Sources
        const fileMap = new Map();
        results.forEach(r => {
            const key = r.filename || 'Unknown';
            if (!fileMap.has(key)) {
                fileMap.set(key, new Set());
            }
            fileMap.get(key).add(r.sheetName || 'Sheet');
        });
        
        tableHtml += `
            <div class="mt-4 p-3 bg-gray-100 rounded-lg text-xs">
                <details open>
                    <summary class="font-semibold cursor-pointer mb-2">
                        üìä Data Sources (${fileMap.size} files, ${results.length} records)
                    </summary>
                    <div class="max-h-40 overflow-y-auto">
                        <ul class="list-disc list-inside space-y-1">
                            ${Array.from(fileMap.entries()).map(([file, sheets]) => 
                                `<li class="text-gray-700">${file} <span class="bg-blue-100 text-blue-800 px-1 rounded">${sheets.size} sheet(s)</span></li>`
                            ).join('')}
                        </ul>
                    </div>
                </details>
            </div>
        `;
        
        document.getElementById('studentResultsTable').innerHTML = tableHtml;
        document.getElementById('studentResultsContainer').classList.remove('hidden');
        
        hideLoading();
        showToast(`Found ${theorySubjectsList.length} theory subjects and ${clinicalMarks.length} clinical assessments`, 'success');
        
    } catch (error) {
        console.error('Search error:', error);
        hideLoading();
        showToast('Error searching: ' + error.message, 'error');
    }
}
  // ========== TRANSCRIPT FUNCTIONS ==========
function downloadOfficialTranscriptPDF() {
    if (!currentTranscriptData) {
        showToast('No student data available', 'error');
        return;
    }
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        // College Header
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 51, 102);
        doc.text(COLLEGE_NAME, 105, 20, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'italic');
        doc.setTextColor(100, 100, 100);
        doc.text(COLLEGE_MOTTO, 105, 27, { align: 'center' });
        
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(80, 80, 80);
        const addressLines = doc.splitTextToSize(COLLEGE_ADDRESS, 180);
        doc.text(addressLines, 105, 34, { align: 'center' });
        
        // Line
        doc.setDrawColor(0, 51, 102);
        doc.setLineWidth(0.5);
        doc.line(20, 40, 190, 40);
        
        // Title
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 51, 102);
        doc.text('OFFICIAL ACADEMIC TRANSCRIPT', 105, 48, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(255, 0, 0);
        doc.text('PROVISIONAL RESULTS - NOT FOR OFFICIAL USE', 105, 55, { align: 'center' });
        
        // Student Info
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        
        let yPos = 65;
        doc.text(`Student Name: ${currentTranscriptData.studentName || 'N/A'}`, 20, yPos);
        yPos += 6;
        
        // Handle multiple IDs
        let idLine = '';
        if (currentTranscriptData.studentId) idLine += `Admission: ${currentTranscriptData.studentId}`;
        if (currentTranscriptData.studentIndex) {
            if (idLine) idLine += ' | ';
            idLine += `Index: ${currentTranscriptData.studentIndex}`;
        }
        doc.text(idLine || 'N/A', 20, yPos);
        yPos += 6;
        
        doc.text(`Program: ${PROGRAM_NAME} - Kenya Registered Community Health Nurse`, 20, yPos);
        yPos += 6;
        doc.text(`Date Printed: ${new Date().toLocaleDateString()}`, 20, yPos);
        yPos += 10;
        
        // Prepare table data - ONLY FINAL SCORES
        const tableHeaders = [['#', 'Subject/Assessment', 'Final Score', 'Grade', 'Points', 'Status']];
        const tableBody = currentTranscriptData.subjects.map((s, index) => {
            // Get the final score (either finalMark for block subjects or score for others)
            const finalScore = s.finalMark || s.score || 0;
            const grade = getGrade(finalScore);
            const status = finalScore >= 60 ? 'PASS' : 'FAIL';
            
            return [
                (index + 1).toString(),
                s.displayName || s.name || s.subject,
                finalScore.toFixed(1),
                grade.grade,
                grade.points.toString(),
                status
            ];
        });
        
        doc.autoTable({
            startY: yPos,
            head: tableHeaders,
            body: tableBody,
            theme: 'striped',
            styles: {
                fontSize: 9,
                cellPadding: 4,
                lineColor: [200, 200, 200],
                lineWidth: 0.1
            },
            headStyles: {
                fillColor: [0, 51, 102],
                textColor: [255, 255, 255],
                fontSize: 9,
                fontStyle: 'bold',
                halign: 'center'
            },
            columnStyles: {
                0: { cellWidth: 15, halign: 'center' },
                1: { cellWidth: 80, halign: 'left' },
                2: { cellWidth: 25, halign: 'center' },
                3: { cellWidth: 20, halign: 'center' },
                4: { cellWidth: 20, halign: 'center' },
                5: { cellWidth: 25, halign: 'center' }
            },
            margin: { left: 15, right: 15 }
        });
        
        // Get the final Y position after the table
        const finalY = doc.lastAutoTable.finalY + 10;
        
        // Summary section
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 51, 102);
        doc.text('SUMMARY', 20, finalY);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        
        let summaryY = finalY + 7;
        
        // Calculate pass/fail counts
        const passCount = currentTranscriptData.subjects.filter(s => {
            const score = s.finalMark || s.score || 0;
            return score >= 60;
        }).length;
        const failCount = currentTranscriptData.subjects.length - passCount;
        
        // Create summary grid
        const summaryData = [
            ['Total Subjects:', currentTranscriptData.subjects.length.toString()],
            ['Passed:', passCount.toString()],
            ['Failed:', failCount.toString()],
            ['Overall Average:', currentTranscriptData.avgOverall.toFixed(1) + '%'],
            ['Total Points:', currentTranscriptData.totalPoints.toString()],
            ['GPA:', currentTranscriptData.gpa.toString()]
        ];
        
        summaryData.forEach((item, index) => {
            doc.text(item[0], 25, summaryY + (index * 6));
            doc.setFont('helvetica', 'bold');
            doc.text(item[1], 70, summaryY + (index * 6));
            doc.setFont('helvetica', 'normal');
        });
        
        // Overall Grade with color
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        
        // Set color based on grade
        if (currentTranscriptData.overallGrade.grade === 'A') {
            doc.setTextColor(0, 102, 0); // Green
        } else if (currentTranscriptData.overallGrade.grade === 'B') {
            doc.setTextColor(0, 102, 204); // Blue
        } else if (currentTranscriptData.overallGrade.grade === 'C') {
            doc.setTextColor(204, 102, 0); // Orange
        } else {
            doc.setTextColor(204, 0, 0); // Red
        }
        
        doc.text(`Overall Grade: ${currentTranscriptData.overallGrade.grade} - ${currentTranscriptData.overallGrade.status}`, 120, summaryY + 20);
        
        // SIGNATURES SECTION
        const signatureY = finalY + 70;
        
        // Line for signatures
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.5);
        doc.line(20, signatureY, 90, signatureY);
        doc.line(120, signatureY, 190, signatureY);
        
        // Signature labels
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 51, 102);
        doc.text('HOD NURSING', 40, signatureY + 5, { align: 'center' });
        doc.text('PRINCIPAL', 155, signatureY + 5, { align: 'center' });
        
        doc.setFontSize(8);
        doc.setFont('helvetica', 'italic');
        doc.setTextColor(100, 100, 100);
        doc.text('(Signed & Stamped)', 40, signatureY + 10, { align: 'center' });
        doc.text('(Signed & Stamped)', 155, signatureY + 10, { align: 'center' });
        
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(80, 80, 80);
        doc.text('Name: Dr. Jane Akinyi', 40, signatureY + 15, { align: 'center' });
        doc.text('Name: Prof. James Mwangi', 155, signatureY + 15, { align: 'center' });
        
        // Grading Key
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100);
        const gradingKey = 'Grading: A=85-100 (Distinction, 4pts), B=75-84 (Credit, 3pts), C=60-74 (Pass, 2pts), D=0-59 (Fail, 0pts)';
        doc.text(gradingKey, 105, 260, { align: 'center' });
        
        // Footer
        doc.setFontSize(7);
        doc.setTextColor(150, 150, 150);
        doc.text(COLLEGE_FOOTER, 105, 270, { align: 'center' });
        
        // Save the PDF
        const fileName = `${(currentTranscriptData.studentName || 'Student').replace(/[^a-zA-Z0-9]/g, '_')}_Transcript.pdf`;
        doc.save(fileName);
        
        showToast('PDF downloaded successfully', 'success');
        
    } catch (error) {
        console.error('PDF generation error:', error);
        showToast('Error generating PDF: ' + error.message, 'error');
    }
}

function downloadTranscriptExcel() {
    if (!currentTranscriptData) {
        showToast('No student data available', 'error');
        return;
    }
    
    try {
        const wb = XLSX.utils.book_new();
        
        // Summary Sheet - ONLY FINAL SCORES
        const summaryData = [
            ['NAKURU COLLEGE OF HEALTH SCIENCES - ACADEMIC TRANSCRIPT'],
            ['PROVISIONAL RESULTS'],
            [],
            ['Student Name:', currentTranscriptData.studentName],
            ['Admission No:', currentTranscriptData.studentId || 'N/A'],
            ['Index Number:', currentTranscriptData.studentIndex || 'N/A'],
            ['Program:', PROGRAM_NAME + ' - Kenya Registered Community Health Nurse'],
            ['Date:', new Date().toLocaleDateString()],
            [],
            ['#', 'Subject/Assessment', 'Final Score', 'Grade', 'Points', 'Status']
        ];
        
        currentTranscriptData.subjects.forEach((s, index) => {
            const finalScore = s.finalMark || s.score || 0;
            const grade = getGrade(finalScore);
            const status = finalScore >= 60 ? 'PASS' : 'FAIL';
            
            summaryData.push([
                (index + 1).toString(),
                s.displayName || s.name || s.subject,
                finalScore.toFixed(1),
                grade.grade,
                grade.points,
                status
            ]);
        });
        
        // Add empty row
        summaryData.push([]);
        
        // Calculate statistics
        const passCount = currentTranscriptData.subjects.filter(s => {
            const score = s.finalMark || s.score || 0;
            return score >= 60;
        }).length;
        const failCount = currentTranscriptData.subjects.length - passCount;
        
        summaryData.push(
            ['SUMMARY'],
            ['Total Subjects:', currentTranscriptData.subjects.length],
            ['Passed:', passCount],
            ['Failed:', failCount],
            ['Overall Average:', currentTranscriptData.avgOverall.toFixed(1) + '%'],
            ['Total Points:', currentTranscriptData.totalPoints],
            ['GPA:', currentTranscriptData.gpa],
            ['Overall Grade:', `${currentTranscriptData.overallGrade.grade} - ${currentTranscriptData.overallGrade.status}`],
            [],
            ['SIGNED BY:'],
            ['HOD NURSING: Dr. Jane Akinyi', '', 'PRINCIPAL: Prof. James Mwangi'],
            ['Date: ' + new Date().toLocaleDateString(), '', 'Date: ' + new Date().toLocaleDateString()]
        );
        
        const ws = XLSX.utils.aoa_to_sheet(summaryData);
        
        // Set column widths
        ws['!cols'] = [
            { wch: 5 },   // #
            { wch: 40 },  // Subject
            { wch: 12 },  // Final Score
            { wch: 8 },   // Grade
            { wch: 8 },   // Points
            { wch: 10 }   // Status
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, 'Transcript');
        
        // Save file
        const fileName = `${(currentTranscriptData.studentName || 'Student').replace(/[^a-zA-Z0-9]/g, '_')}_Transcript.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showToast('Excel downloaded successfully', 'success');
        
    } catch (error) {
        console.error('Excel error:', error);
        showToast('Error generating Excel: ' + error.message, 'error');
    }
}

function printOfficialTranscript() {
    if (!currentTranscriptData) {
        showToast('No student data available', 'error');
        return;
    }
    
    try {
        // Calculate statistics
        const passCount = currentTranscriptData.subjects.filter(s => {
            const score = s.finalMark || s.score || 0;
            return score >= 60;
        }).length;
        const failCount = currentTranscriptData.subjects.length - passCount;
        
        // Generate table rows - ONLY FINAL SCORES
        const tableRows = currentTranscriptData.subjects.map((s, index) => {
            const finalScore = s.finalMark || s.score || 0;
            const grade = getGrade(finalScore);
            const status = finalScore >= 60 ? 'PASS' : 'FAIL';
            const statusClass = status === 'PASS' ? 'status-pass' : 'status-fail';
            
            return `
                <tr>
                    <td class="text-center">${index + 1}</td>
                    <td>${s.displayName || s.name || s.subject}</td>
                    <td class="text-center font-bold ${grade.color}">${finalScore.toFixed(1)}</td>
                    <td class="text-center"><span class="grade-badge grade-${grade.grade.toLowerCase()}">${grade.grade}</span></td>
                    <td class="text-center">${grade.points}</td>
                    <td class="text-center ${statusClass}">${status}</td>
                </tr>
            `;
        }).join('');
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Academic Transcript - ${currentTranscriptData.studentName}</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 30px;
                        font-size: 12px;
                        line-height: 1.4;
                    }
                    .header { 
                        text-align: center; 
                        margin-bottom: 25px; 
                        border-bottom: 2px solid #003366;
                        padding-bottom: 15px;
                    }
                    .college-name { 
                        font-size: 20px; 
                        font-weight: bold; 
                        color: #003366; 
                        margin: 5px 0;
                    }
                    .motto { 
                        font-size: 12px; 
                        color: #666; 
                        margin: 5px 0; 
                        font-style: italic;
                    }
                    .address { 
                        font-size: 10px; 
                        color: #999; 
                        margin: 5px 0;
                    }
                    .title { 
                        font-size: 16px; 
                        font-weight: bold; 
                        color: #003366; 
                        margin: 20px 0; 
                        text-align: center; 
                    }
                    .provisional { 
                        color: red; 
                        font-weight: bold; 
                        text-align: center; 
                        margin: 10px 0;
                        font-size: 12px;
                        border: 1px solid red;
                        padding: 5px;
                        background: #ffeeee;
                    }
                    .student-info { 
                        margin: 20px 0; 
                        padding: 15px;
                        background: #f5f5f5;
                        border-radius: 5px;
                        border-left: 4px solid #003366;
                    }
                    .student-info p {
                        margin: 5px 0;
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin: 20px 0;
                        font-size: 11px;
                    }
                    th { 
                        background: #003366; 
                        color: white; 
                        padding: 10px; 
                        text-align: left;
                        font-weight: bold;
                    }
                    td { 
                        padding: 8px; 
                        border: 1px solid #ddd; 
                    }
                    tr:nth-child(even) {
                        background: #f9f9f9;
                    }
                    .grade-badge {
                        padding: 4px 10px;
                        border-radius: 20px;
                        display: inline-block;
                        font-weight: bold;
                        font-size: 11px;
                    }
                    .grade-a { 
                        background: #ede9fe; 
                        color: #5b21b6; 
                    }
                    .grade-b { 
                        background: #d1fae5; 
                        color: #065f46; 
                    }
                    .grade-c { 
                        background: #fed7aa; 
                        color: #92400e; 
                    }
                    .grade-d { 
                        background: #fee2e2; 
                        color: #991b1b; 
                    }
                    .status-pass {
                        color: #065f46;
                        font-weight: bold;
                        background: #dcfce7;
                        padding: 4px 8px;
                        border-radius: 20px;
                    }
                    .status-fail {
                        color: #991b1b;
                        font-weight: bold;
                        background: #fee2e2;
                        padding: 4px 8px;
                        border-radius: 20px;
                    }
                    .summary-container { 
                        margin: 30px 0;
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 15px;
                    }
                    .summary-item {
                        background: #f0f7ff;
                        padding: 12px;
                        border-radius: 8px;
                        text-align: center;
                        border: 1px solid #cbd5e1;
                    }
                    .summary-label {
                        font-size: 10px;
                        color: #666;
                        text-transform: uppercase;
                    }
                    .summary-value {
                        font-size: 20px;
                        font-weight: bold;
                        color: #003366;
                    }
                    .signatures {
                        margin-top: 50px;
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 50px;
                    }
                    .signature-box {
                        text-align: center;
                        border-top: 1px solid #000;
                        padding-top: 10px;
                    }
                    .signature-title {
                        font-weight: bold;
                        color: #003366;
                        margin: 5px 0;
                    }
                    .signature-name {
                        font-size: 11px;
                        color: #666;
                        font-style: italic;
                    }
                    .footer { 
                        margin-top: 40px; 
                        font-size: 9px; 
                        color: #999; 
                        text-align: center; 
                        border-top: 1px solid #ccc;
                        padding-top: 15px;
                    }
                    .grading-key {
                        margin: 20px 0;
                        padding: 10px;
                        background: #f5f5f5;
                        font-size: 9px;
                        color: #666;
                        text-align: center;
                        border-radius: 5px;
                    }
                    .text-center { text-align: center; }
                    .font-bold { font-weight: bold; }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="college-name">${COLLEGE_NAME}</div>
                    <div class="motto">${COLLEGE_MOTTO}</div>
                    <div class="address">${COLLEGE_ADDRESS}</div>
                </div>
                
                <div class="title">OFFICIAL ACADEMIC TRANSCRIPT</div>
                <div class="provisional">PROVISIONAL RESULTS - NOT FOR OFFICIAL USE</div>
                
                <div class="student-info">
                    <p><strong>Student Name:</strong> ${currentTranscriptData.studentName}</p>
                    <p><strong>Admission No:</strong> ${currentTranscriptData.studentId || 'N/A'}</p>
                    <p><strong>Index Number:</strong> ${currentTranscriptData.studentIndex || 'N/A'}</p>
                    <p><strong>Program:</strong> ${PROGRAM_NAME} - Kenya Registered Community Health Nurse</p>
                    <p><strong>Date Printed:</strong> ${new Date().toLocaleDateString()}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Subject/Assessment</th>
                            <th>Final Score</th>
                            <th>Grade</th>
                            <th>Points</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
                
                <div class="summary-container">
                    <div class="summary-item">
                        <div class="summary-label">Total Subjects</div>
                        <div class="summary-value">${currentTranscriptData.subjects.length}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Passed</div>
                        <div class="summary-value" style="color: #065f46;">${passCount}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Failed</div>
                        <div class="summary-value" style="color: #991b1b;">${failCount}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Average</div>
                        <div class="summary-value">${currentTranscriptData.avgOverall.toFixed(1)}%</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">GPA</div>
                        <div class="summary-value">${currentTranscriptData.gpa}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Overall Grade</div>
                        <div class="summary-value">${currentTranscriptData.overallGrade.grade}</div>
                    </div>
                </div>
                
                <div class="grading-key">
                    <strong>Grading Key:</strong> A=85-100 (Distinction, 4pts) | B=75-84 (Credit, 3pts) | C=60-74 (Pass, 2pts) | D=0-59 (Fail, 0pts)
                </div>
                
                <div class="signatures">
                    <div class="signature-box">
                        <div class="signature-title">HOD NURSING</div>
                        <div class="signature-name">Dr. Jane Akinyi</div>
                        <div style="margin-top: 5px; font-size: 10px;">Signed: ___________________</div>
                        <div style="margin-top: 5px; font-size: 10px;">Date: ${new Date().toLocaleDateString()}</div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-title">PRINCIPAL</div>
                        <div class="signature-name">Prof. James Mwangi</div>
                        <div style="margin-top: 5px; font-size: 10px;">Signed: ___________________</div>
                        <div style="margin-top: 5px; font-size: 10px;">Date: ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
                
                <div class="footer">
                    ${COLLEGE_FOOTER}
                </div>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Wait for content to load then print
        printWindow.onload = function() {
            setTimeout(() => {
                printWindow.print();
            }, 250);
        };
        
        showToast('Print window opened', 'success');
        
    } catch (error) {
        console.error('Print error:', error);
        showToast('Error preparing print: ' + error.message, 'error');
    }
}
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing session
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    // Auto-login if session exists
                    handleLogin();
                }
            });
        });
    </script>
</body>
</html>
