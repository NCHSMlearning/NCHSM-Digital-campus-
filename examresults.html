<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nakuru College of Health Sciences - Exam Portal</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <!-- Google Sheets API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- jsPDF for PDF Transcript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
    
    <style>
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            margin-top: 15px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .debug-info {
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            background: rgba(0,0,0,0.5);
            padding: 8px;
            border-radius: 4px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .progress-bar {
            width: 300px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.2s ease;
            border-radius: 4px;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 12px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10000;
            animation: slideIn 0.2s ease;
            font-size: 14px;
        }
        
        .toast.success { border-left: 4px solid #4CAF50; }
        .toast.error { border-left: 4px solid #f44336; }
        .toast.info { border-left: 4px solid #2196F3; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0%); opacity: 1; }
        }
        
        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table tr:hover {
            background-color: #f8fafc;
        }
        
        /* Cards */
        .portal-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px;
            transition: all 0.2s ease;
        }
        
        /* Grade Badges */
        .grade-badge {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .grade-a { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; }
        .grade-b { background: linear-gradient(135deg, #059669 0%, #10B981 100%); color: white; }
        .grade-c { background: linear-gradient(135deg, #D97706 0%, #F59E0B 100%); color: white; }
        .grade-d { background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%); color: white; }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pass { background: #dcfce7; color: #166534; }
        .status-fail { background: #fee2e2; color: #991b1b; }
        .status-credit { background: #dbeafe; color: #1e40af; }
        .status-distinction { background: #ede9fe; color: #5b21b6; }
        
        /* Student Summary Card */
        .student-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-value { font-size: 28px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Gradient Cards */
        .gradient-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .gradient-card-green { background: linear-gradient(135deg, #34b1aa 0%, #1c8f7c 100%); color: white; }
        .gradient-card-orange { background: linear-gradient(135deg, #f09351 0%, #e9692c 100%); color: white; }
        .gradient-card-purple { background: linear-gradient(135deg, #a166ab 0%, #6d4c7d 100%); color: white; }
        
        .row-even { background-color: #f9fafb; }
        .row-odd { background-color: white; }
        
        /* Filter Badges */
        .filter-badge {
            background: #e2e8f0;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .filter-badge.active {
            background: #4f46e5;
            color: white;
        }
        
        .selected-classes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .selected-class-tag {
            background: #4f46e5;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-class-tag i {
            cursor: pointer;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        
        /* Class Selection */
        .class-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .class-option:hover {
            border-color: #4f46e5;
            background: #f5f3ff;
        }
        
        .class-option.selected {
            border-color: #4f46e5;
            background: #eef2ff;
        }
        
        .class-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #4f46e5;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: white;
        }
        
        .class-option.selected .class-checkbox {
            background: #4f46e5;
        }
        
        /* Sheet Tabs */
        .sheet-tab {
            transition: all 0.2s ease;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 2px;
            white-space: nowrap;
        }
        
        .sheet-tab:hover {
            transform: translateY(-1px);
        }
        
        .sheet-tab.active {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }
        
        /* Excel Viewer Table */
        .excel-viewer-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
        }
        
        .excel-viewer-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 8px;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .excel-viewer-table td {
            padding: 8px;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        .excel-viewer-table tr:hover td {
            background-color: #eff6ff !important;
        }
        
        /* Mark Colors */
        .mark-excellent { color: #4F46E5; font-weight: bold; }
        .mark-good { color: #059669; font-weight: bold; }
        .mark-average { color: #D97706; font-weight: bold; }
        .mark-fail { color: #DC2626; font-weight: bold; }
        
        /* Google Sheets Editor */
        .google-sheets-editor {
            height: 70vh;
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .google-sheets-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Scrollbar Styling */
        .modal-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Grading Table */
        .grading-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .grading-table th {
            background: #1e3c72;
            color: white;
            padding: 8px;
            text-align: center;
        }
        
        .grading-table td {
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .grading-table .grade-a { background: #ede9fe; color: #5b21b6; font-weight: bold; }
        .grading-table .grade-b { background: #d1fae5; color: #065f46; font-weight: bold; }
        .grading-table .grade-c { background: #fed7aa; color: #92400e; font-weight: bold; }
        .grading-table .grade-d { background: #fee2e2; color: #991b1b; font-weight: bold; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div id="loadingMessage" class="loading-text">Loading...</div>
            <div id="debugInfo" class="debug-info"></div>
            <div id="progressContainer" style="width: 300px; margin-top: 15px; display: none;">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div id="progressText" class="text-white text-xs mt-1">0%</div>
            </div>
        </div>
    </div>

    <!-- Class Selection Modal -->
    <div id="classModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Select Classes</h3>
            <p class="text-sm text-gray-600 mb-4">Choose which classes this file belongs to (you can select multiple):</p>
            
            <div id="classOptions" class="space-y-2">
                <div class="class-option" onclick="toggleClass('2024')">
                    <div class="class-checkbox" id="class-check-2024">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2024</div>
                        <div class="text-xs text-gray-500">Class of 2024</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2025')">
                    <div class="class-checkbox" id="class-check-2025">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2025</div>
                        <div class="text-xs text-gray-500">Class of 2025</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2026')">
                    <div class="class-checkbox" id="class-check-2026">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2026</div>
                        <div class="text-xs text-gray-500">Class of 2026</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2027')">
                    <div class="class-checkbox" id="class-check-2027">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2027</div>
                        <div class="text-xs text-gray-500">Class of 2027</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('2028')">
                    <div class="class-checkbox" id="class-check-2028">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">March 2028</div>
                        <div class="text-xs text-gray-500">Class of 2028</div>
                    </div>
                </div>
                <div class="class-option" onclick="toggleClass('other')">
                    <div class="class-checkbox" id="class-check-other">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div>
                        <div class="font-semibold">Other</div>
                        <div class="text-xs text-gray-500">Different intake</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="cancelClassSelection()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">Cancel</button>
                <button onclick="confirmClassSelection()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Google Sheets Editor Modal -->
    <div id="googleSheetsEditor" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 1400px; height: 90vh; padding: 16px;">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fab fa-google text-green-600 mr-2"></i>
                    GOOGLE SHEETS: <span id="googleSheetsFileName" class="text-blue-600 ml-1 text-sm font-medium"></span>
                </h2>
                <div class="flex gap-2">
                    <button onclick="syncFromGoogleSheets()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2">
                        <i class="fas fa-sync"></i> Sync to Database
                    </button>
                    <button onclick="closeGoogleSheetsEditor()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm flex items-center gap-2">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            <div class="google-sheets-editor">
                <iframe id="googleSheetIframe" class="google-sheets-frame" 
                        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-downloads allow-popups-to-escape-sandbox allow-modals">
                </iframe>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- ========== SUPABASE CONFIG ========== -->
        <script>
            // üî¥ YOUR SUPABASE CREDENTIALS
            const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
            
            // Google Sheets Configuration
            const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY'; // Replace with your Google API Key
            const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID'; // Replace with your Google Client ID
            
            // Initialize Supabase
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            console.log('‚úÖ Supabase initialized!');
            
            // Global state
            let currentUser = null;
            let currentRole = null;
            let sharedFiles = [];
            let allStudentMarks = [];
            let studentIndex = new Map();
            let performanceChart = null;
            let distributionChart = null;
            let isProcessing = false;
            let processingQueue = [];
            let currentTranscriptData = null;
            let selectedClasses = new Set();
            let pendingFile = null;
            let pendingFileClasses = new Set();
            
            // Google Sheets state
            let googleAccessToken = null;
            let currentGoogleSheetId = null;
            let currentGoogleSheetFileId = null;
            
            // College Info
            const COLLEGE_NAME = 'NAKURU COLLEGE OF HEALTH SCIENCES & MANAGEMENT';
            const COLLEGE_MOTTO = 'Excellence in Health Training, Research & Professional Development';
            const COLLEGE_ADDRESS = 'Kiamunyi Campus | P.O. Box 12906 ‚Äì 20100, Nakuru | Tel: 0745 215594 | 0703 345771 | 0103614355';
            const COLLEGE_EMAIL = 'info@nakurucollegeofhealth.ac.ke';
            const COLLEGE_WEBSITE = 'www.nakurucollegeofhealth.ac.ke';
            const COLLEGE_FOOTER = 'Accredited & Registered Institution | Committed to Academic Excellence | ¬© 2026 Nakuru College of Health Sciences & Management';
            const PROGRAM_NAME = 'KRCHN'; // Kenya Registered Community Health Nurse
        </script>

        <!-- ========== LOGIN SCREEN ========== -->
        <div id="loginScreen" class="flex items-center justify-center min-h-screen">
            <div class="portal-card w-full max-w-md">
                <div class="text-center mb-6">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-graduation-cap text-white text-3xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">NAKURU COLLEGE OF HEALTH SCIENCES</h1>
                    <p class="text-gray-600 mt-1 text-sm">EXAM RESULTS PROVISIONAL PORTAL</p>
                    <div class="mt-2">
                        <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-xs">
                            <i class="fas fa-clock mr-1"></i>
                            PROVISIONAL RESULTS
                        </span>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">
                            <i class="fas fa-envelope mr-2 text-gray-500"></i>
                            Email Address
                        </label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" 
                               class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-0 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">
                            <i class="fas fa-lock mr-2 text-gray-500"></i>
                            Password
                        </label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" 
                               class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-0 text-sm">
                    </div>
                    
                    <button onclick="handleLogin()" 
                            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2.5 rounded-lg hover:opacity-90 transition font-medium text-sm shadow-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        LOGIN
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== MAIN PORTAL ========== -->
        <div id="mainPortal" class="hidden space-y-6">
            <!-- Header -->
            <div class="portal-card">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-3 rounded-xl shadow-lg mr-3">
                            <i class="fas fa-graduation-cap text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl md:text-2xl font-bold text-gray-800">NAKURU COLLEGE EXAM PORTAL</h1>
                            <div class="flex items-center mt-1 text-sm">
                                <span id="userRoleBadge" class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-bold mr-2"></span>
                                <span id="userDisplayName" class="text-gray-600"></span>
                                <span class="mx-2 text-gray-400">‚Ä¢</span>
                                <span id="userEmailDisplay" class="text-gray-500 text-xs"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="bg-orange-100 px-3 py-1.5 rounded-full flex items-center">
                            <i class="fas fa-clock text-orange-600 mr-1 text-xs"></i>
                            <span class="text-orange-800 text-xs font-semibold">PROVISIONAL</span>
                        </div>
                        <button onclick="logout()" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-300 transition text-sm">
                            <i class="fas fa-sign-out-alt mr-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Class Filter Section -->
            <div class="portal-card">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-filter text-purple-600 mr-2"></i> Filter by Class
                </h2>
                
                <div class="flex flex-wrap gap-2 mb-3">
                    <button onclick="toggleAllClasses()" class="filter-badge">
                        <i class="fas fa-check-double"></i> All Classes
                    </button>
                    <button onclick="clearClassFilter()" class="filter-badge">
                        <i class="fas fa-times"></i> Clear All
                    </button>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <span onclick="toggleClassFilter('2024')" id="filter-class-2024" class="filter-badge">March 2024</span>
                    <span onclick="toggleClassFilter('2025')" id="filter-class-2025" class="filter-badge">March 2025</span>
                    <span onclick="toggleClassFilter('2026')" id="filter-class-2026" class="filter-badge">March 2026</span>
                    <span onclick="toggleClassFilter('2027')" id="filter-class-2027" class="filter-badge">March 2027</span>
                    <span onclick="toggleClassFilter('2028')" id="filter-class-2028" class="filter-badge">March 2028</span>
                    <span onclick="toggleClassFilter('other')" id="filter-class-other" class="filter-badge">Other</span>
                </div>
                
                <!-- Selected Classes Display -->
                <div id="selectedClassesDisplay" class="selected-classes-container mt-3">
                    <!-- Selected classes will appear here -->
                </div>
                
                <div class="mt-3 text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Showing files that match any of the selected classes
                </div>
            </div>

            <!-- Grading System Reference -->
            <div class="portal-card">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-table text-blue-600 mr-2"></i> Grading System - KRCHN Program
                </h2>
                <table class="grading-table">
                    <thead>
                        <tr>
                            <th>Marks From</th>
                            <th>Marks To</th>
                            <th>Grade</th>
                            <th>Points</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>0</td>
                            <td>59</td>
                            <td class="grade-d">D</td>
                            <td>0</td>
                            <td>FAIL</td>
                        </tr>
                        <tr>
                            <td>60</td>
                            <td>74</td>
                            <td class="grade-c">C</td>
                            <td>2</td>
                            <td>PASS</td>
                        </tr>
                        <tr>
                            <td>75</td>
                            <td>84</td>
                            <td class="grade-b">B</td>
                            <td>3</td>
                            <td>CREDIT</td>
                        </tr>
                        <tr>
                            <td>85</td>
                            <td>100</td>
                            <td class="grade-a">A</td>
                            <td>4</td>
                            <td>DISTINCTION</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="gradient-card p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Files</p>
                            <p id="totalFilesStats" class="text-3xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-file-excel text-white text-xl"></i></div>
                    </div>
                </div>
                <div class="gradient-card-green p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Records</p>
                            <p id="totalRecordsStats" class="text-3xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-users text-white text-xl"></i></div>
                    </div>
                </div>
                <div class="gradient-card-orange p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Staff</p>
                            <p id="totalStaffStats" class="text-3xl font-bold mt-1">0</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-chalkboard-teacher text-white text-xl"></i></div>
                    </div>
                </div>
                <div class="gradient-card-purple p-5 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs uppercase tracking-wider">Role</p>
                            <p id="userRoleDisplay" class="text-2xl font-bold mt-1">-</p>
                        </div>
                        <div class="bg-white/20 p-3 rounded-full"><i class="fas fa-shield-alt text-white text-xl"></i></div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="portal-card">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-pie text-purple-600 mr-2"></i> Grade Distribution
                        <span id="chartFilterBadge" class="ml-2 text-xs bg-gray-200 px-2 py-1 rounded-full"></span>
                    </h2>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                <div class="portal-card">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-green-600 mr-2"></i> Mark Ranges
                        <span id="barChartFilterBadge" class="ml-2 text-xs bg-gray-200 px-2 py-1 rounded-full"></span>
                    </h2>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Student Search -->
            <div id="adminSearchSection" class="portal-card">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-search text-blue-600 mr-2"></i> Search Student (Admission No. or Name)
                </h2>
                
                <div class="flex gap-3 mb-6">
                    <input type="text" id="studentSearchInput" placeholder="Enter Admission Number or Student Name..." 
                           class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 text-sm">
                    <button onclick="searchStudentMarks()" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center text-sm">
                        <i class="fas fa-search mr-2"></i> Search
                    </button>
                    <button onclick="clearSearch()" class="bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600 text-sm">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Results -->
                <div id="studentResultsContainer" class="hidden">
                    <div id="studentSummaryCard" class="student-summary-card">
                        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4">
                            <div>
                                <h3 id="studentNameDisplay" class="text-xl font-bold">-</h3>
                                <p id="studentIdDisplay" class="text-white/80 text-sm">Admission No: -</p>
                                <p id="studentProgramDisplay" class="text-white/80 text-sm">Program: KRCHN</p>
                            </div>
                            <div class="mt-2 md:mt-0 flex gap-2">
                                <span id="overallGradeDisplay" class="grade-badge grade-a text-sm px-4 py-2">-</span>
                                <span id="gpaDisplay" class="grade-badge bg-white text-blue-800 text-sm px-4 py-2">GPA: 0.0</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div class="stat-box"><div class="stat-value" id="totalExamsCount">0</div><div class="stat-label">Exams</div></div>
                            <div class="stat-box"><div class="stat-value" id="averageMarkDisplay">0.0</div><div class="stat-label">Average</div></div>
                            <div class="stat-box"><div class="stat-value" id="totalPointsDisplay">0</div><div class="stat-label">Points</div></div>
                            <div class="stat-box"><div class="stat-value" id="gpaValueDisplay">0.0</div><div class="stat-label">GPA</div></div>
                        </div>
                        
                        <!-- Transcript Actions -->
                        <div class="flex gap-2 mt-4 flex-wrap">
                            <button onclick="downloadOfficialTranscriptPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm flex items-center gap-2">
                                <i class="fas fa-file-pdf"></i> Official Transcript
                            </button>
                            <button onclick="downloadTranscriptExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm flex items-center gap-2">
                                <i class="fas fa-file-excel"></i> Excel Transcript
                            </button>
                            <button onclick="printOfficialTranscript()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-file-alt text-blue-600 mr-2"></i> Detailed Results
                    </h3>
                    <div id="studentResultsTable" class="overflow-x-auto bg-white rounded-lg border max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="space-y-6">
                <div class="portal-card">
                    <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-upload text-green-600 mr-2"></i> Upload Excel
                    </h2>
                    <div onclick="document.getElementById('excelUpload').click()"
                         class="border-3 border-dashed border-blue-300 rounded-xl p-6 text-center cursor-pointer hover:border-blue-500 bg-blue-50 transition">
                        <i class="fas fa-cloud-upload-alt text-4xl text-blue-500 mb-2"></i>
                        <p class="text-gray-700 text-sm font-medium">Click to Upload</p>
                        <p class="text-gray-500 text-xs mt-1">.xlsx, .xls, .csv</p>
                        <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelUpload(this)">
                    </div>
                </div>

                <div id="filePreviewSection" class="hidden portal-card">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800 text-sm">Preview</h3>
                        <button onclick="closeFilePreview()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="filePreview" class="overflow-x-auto text-sm"></div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button onclick="publishFile()" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 text-sm">
                            <i class="fas fa-cloud-upload-alt mr-1"></i> Publish
                        </button>
                    </div>
                </div>
            </div>

            <!-- Shared Files -->
            <div class="portal-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fas fa-folder-open text-purple-600 mr-2"></i> Shared Files
                    </h2>
                    <div class="flex gap-2">
                        <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs">
                            <span id="filteredFileCount">0</span> files
                        </span>
                    </div>
                </div>
                <div id="sharedFilesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== UTILITIES ==========
        let toastTimeout;
        function showToast(message, type = 'success', duration = 3000) {
            if (toastTimeout) clearTimeout(toastTimeout);
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle text-green-600' : type === 'error' ? 'fa-exclamation-circle text-red-600' : 'fa-info-circle text-blue-600'} text-sm"></i><span class="text-sm">${message}</span>`;
            document.body.appendChild(toast);
            
            toastTimeout = setTimeout(() => toast.remove(), duration);
        }

        let loadingTimeout;
        function showLoading(message = 'Loading...', showProgress = false, timeoutMs = 60000) {
            if (loadingTimeout) clearTimeout(loadingTimeout);
            document.getElementById('loadingMessage').innerText = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('debugInfo').innerHTML = '';
            if (showProgress) {
                document.getElementById('progressContainer').style.display = 'block';
                updateProgress(0);
            } else {
                document.getElementById('progressContainer').style.display = 'none';
            }
            
            loadingTimeout = setTimeout(() => {
                if (document.getElementById('loadingOverlay').style.display === 'flex') {
                    hideLoading();
                    showToast('Operation timed out', 'error');
                    debugLog('‚ùå OPERATION TIMED OUT');
                }
            }, timeoutMs);
        }
        
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').innerText = Math.round(percent) + '%';
        }
        
        function hideLoading() { 
            document.getElementById('loadingOverlay').style.display = 'none'; 
            if (loadingTimeout) clearTimeout(loadingTimeout);
        }

        function debugLog(message) {
            const time = new Date().toLocaleTimeString();
            const log = `[${time}] ${message}`;
            console.log(log);
            
            const debugEl = document.getElementById('debugInfo');
            if (debugEl && document.getElementById('loadingOverlay').style.display === 'flex') {
                debugEl.innerHTML += `<div>${log}</div>`;
                debugEl.scrollTop = debugEl.scrollHeight;
            }
        }

        // ========== GRADE FUNCTION ==========
        function getGrade(mark) {
            if (mark >= 85) return { 
                grade: 'A', 
                points: 4, 
                status: 'DISTINCTION', 
                class: 'grade-a', 
                pass: true,
                color: 'mark-excellent'
            };
            if (mark >= 75) return { 
                grade: 'B', 
                points: 3, 
                status: 'CREDIT', 
                class: 'grade-b', 
                pass: true,
                color: 'mark-good'
            };
            if (mark >= 60) return { 
                grade: 'C', 
                points: 2, 
                status: 'PASS', 
                class: 'grade-c', 
                pass: true,
                color: 'mark-average'
            };
            return { 
                grade: 'D', 
                points: 0, 
                status: 'FAIL', 
                class: 'grade-d', 
                pass: false,
                color: 'mark-fail'
            };
        }

        // ========== GOOGLE SHEETS FUNCTIONS ==========
        function initGoogleAPI() {
            gapi.load('client:auth2', function() {
                gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    clientId: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive',
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                }).then(function() {
                    console.log('Google API initialized');
                }).catch(function(error) {
                    console.error('Google API init error:', error);
                });
            });
        }

        async function ensureGoogleAuth() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                if (!authInstance.isSignedIn.get()) {
                    await authInstance.signIn();
                }
                googleAccessToken = authInstance.currentUser.get().getAuthResponse().access_token;
                return true;
            } catch (error) {
                console.error('Google auth error:', error);
                showToast('Please sign in to Google to use this feature', 'error');
                return false;
            }
        }

        async function openInGoogleSheets(fileId) {
            if (currentRole !== 'admin' && currentRole !== 'super_admin') { 
                showToast('Admins only', 'error'); 
                return; 
            }
            
            const file = sharedFiles.find(f => f.id === fileId);
            if (!file) { 
                showToast('File not found', 'error'); 
                return; 
            }
            
            showLoading('Opening in Google Sheets...', true, 60000);
            
            try {
                await initGoogleAPI();
                if (!await ensureGoogleAuth()) {
                    hideLoading();
                    return;
                }
                
                // Check if we already have a Google Sheet ID
                if (file.google_sheet_id) {
                    currentGoogleSheetId = file.google_sheet_id;
                    currentGoogleSheetFileId = fileId;
                    document.getElementById('googleSheetsFileName').innerText = file.filename;
                    document.getElementById('googleSheetIframe').src = `https://docs.google.com/spreadsheets/d/${file.google_sheet_id}/edit`;
                    document.getElementById('googleSheetsEditor').style.display = 'flex';
                    hideLoading();
                    showToast('Opened in Google Sheets', 'success');
                    return;
                }
                
                // Create new Google Sheet from Excel data
                const binaryData = atob(file.file_data);
                const array = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    array[i] = binaryData.charCodeAt(i);
                }
                
                const workbook = XLSX.read(array, { type: 'array' });
                
                // Create new spreadsheet
                const createResponse = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        properties: {
                            title: file.filename
                        }
                    })
                });
                
                const spreadsheet = await createResponse.json();
                const spreadsheetId = spreadsheet.spreadsheetId;
                
                // Populate each sheet
                for (let i = 0; i < workbook.SheetNames.length; i++) {
                    const sheetName = workbook.SheetNames[i];
                    const worksheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (data.length > 0) {
                        // Add sheet if not exists (skip first sheet as it's created by default)
                        if (i > 0) {
                            await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    requests: [{
                                        addSheet: {
                                            properties: {
                                                title: sheetName
                                            }
                                        }
                                    }]
                                })
                            });
                        }
                        
                        // Add data
                        const range = `${sheetName}!A1:${String.fromCharCode(64 + (data[0]?.length || 1))}${data.length}`;
                        await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?valueInputOption=RAW`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                values: data
                            })
                        });
                    }
                }
                
                // Set permissions to anyone with link can edit
                await fetch(`https://www.googleapis.com/drive/v3/files/${spreadsheetId}/permissions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role: 'writer',
                        type: 'anyone'
                    })
                });
                
                // Save Google Sheet ID to database
                const { error } = await supabase
                    .from('shared_excel_files')
                    .update({ google_sheet_id: spreadsheetId })
                    .eq('id', fileId);
                
                if (error) console.error('Error saving Google Sheet ID:', error);
                
                currentGoogleSheetId = spreadsheetId;
                currentGoogleSheetFileId = fileId;
                document.getElementById('googleSheetsFileName').innerText = file.filename;
                document.getElementById('googleSheetIframe').src = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
                document.getElementById('googleSheetsEditor').style.display = 'flex';
                
                hideLoading();
                showToast('Google Sheet created with all sheets', 'success');
                
            } catch (error) {
                console.error('Error opening in Google Sheets:', error);
                hideLoading();
                showToast('Error opening in Google Sheets: ' + error.message, 'error');
            }
        }

        async function syncFromGoogleSheets() {
            if (!currentGoogleSheetId || !currentGoogleSheetFileId) {
                showToast('No Google Sheet open', 'error');
                return;
            }
            
            showLoading('Syncing from Google Sheets...', true, 60000);
            
            try {
                if (!await ensureGoogleAuth()) {
                    hideLoading();
                    return;
                }
                
                // Get spreadsheet metadata
                const metadataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}`, {
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    }
                });
                
                const metadata = await metadataResponse.json();
                
                // Create new workbook
                const workbook = XLSX.utils.book_new();
                
                // Get data from each sheet
                for (const sheet of metadata.sheets) {
                    const sheetName = sheet.properties.title;
                    
                    const dataResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${currentGoogleSheetId}/values/${sheetName}`, {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    });
                    
                    const data = await dataResponse.json();
                    
                    if (data.values) {
                        const worksheet = XLSX.utils.aoa_to_sheet(data.values);
                        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                    }
                }
                
                // Convert to base64
                const wbData = XLSX.write(workbook, { type: 'base64' });
                
                // Update in database
                const { error } = await supabase
                    .from('shared_excel_files')
                    .update({
                        file_data: wbData,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentGoogleSheetFileId);
                
                if (error) throw error;
                
                hideLoading();
                showToast('Synced from Google Sheets successfully', 'success');
                
                // Refresh data
                loadAllStudentMarks();
                
            } catch (error) {
                console.error('Error syncing from Google Sheets:', error);
                hideLoading();
                showToast('Error syncing: ' + error.message, 'error');
            }
        }

        function closeGoogleSheetsEditor() {
            document.getElementById('googleSheetsEditor').style.display = 'none';
            document.getElementById('googleSheetIframe').src = '';
            currentGoogleSheetId = null;
            currentGoogleSheetFileId = null;
        }

        // ========== VIEW FILE WITH MULTIPLE SHEETS ==========
        async function viewFile(fileId) {
            const file = sharedFiles.find(f => f.id === fileId);
            if (!file || !file.file_data) { 
                showToast('File not found', 'error'); 
                return; 
            }
            
            showLoading('Opening file...', false, 30000);
            
            try {
                // Decode base64 data
                const binaryData = atob(file.file_data);
                const array = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    array[i] = binaryData.charCodeAt(i);
                }
                
                // Parse Excel workbook
                const workbook = XLSX.read(array, { type: 'array' });
                const sheetNames = workbook.SheetNames;
                
                // Create viewer modal with tabs
                const viewerHtml = `
                    <div class="modal-overlay" id="viewerModal" style="display: flex;">
                        <div class="modal-content" style="max-width: 1400px;">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>
                                    ${file.filename}
                                </h2>
                                <button onclick="closeViewerModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Sheet Tabs -->
                            <div class="flex gap-1 overflow-x-auto pb-2 mb-3 border-b" style="scrollbar-width: thin;">
                                ${sheetNames.map((sheet, index) => `
                                    <button onclick="switchViewerSheet('${sheet.replace(/'/g, "\\'")}', ${index})" 
                                        id="sheet-tab-${index}"
                                        class="sheet-tab px-4 py-2 rounded-t-lg text-sm font-medium transition 
                                        ${index === 0 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                        <i class="fas fa-table mr-1"></i>
                                        ${sheet.length > 25 ? sheet.substr(0,22)+'...' : sheet}
                                    </button>
                                `).join('')}
                            </div>
                            
                            <!-- Sheet Data Container -->
                            <div id="sheetDataContainer" class="overflow-x-auto" style="max-height: 60vh;">
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading sheet data...</p>
                                </div>
                            </div>
                            
                            <!-- Sheet Info -->
                            <div class="mt-3 text-sm text-gray-600 flex justify-between items-center">
                                <span>
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="sheetInfo">${sheetNames.length} sheet(s) total</span>
                                </span>
                                <span id="rowCount" class="text-xs bg-gray-100 px-2 py-1 rounded"></span>
                            </div>
                            
                            <!-- Actions -->
                            <div class="mt-4 flex justify-end gap-2">
                                ${currentRole === 'admin' || currentRole === 'super_admin' ? 
                                    `<button onclick="openInGoogleSheets('${file.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2">
                                        <i class="fab fa-google"></i> Edit in Sheets
                                    </button>` : ''}
                                <button onclick="closeViewerModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove any existing viewer modal
                const existingModal = document.getElementById('viewerModal');
                if (existingModal) existingModal.remove();
                
                // Add to body
                document.body.insertAdjacentHTML('beforeend', viewerHtml);
                
                // Store workbook data for sheet switching
                window.currentViewerWorkbook = workbook;
                window.currentViewerSheetNames = sheetNames;
                
                // Load first sheet
                loadViewerSheet(0);
                
                hideLoading();
                
            } catch (error) {
                console.error('Error viewing file:', error);
                hideLoading();
                showToast('Error viewing file: ' + error.message, 'error');
            }
        }

        function closeViewerModal() {
            const modal = document.getElementById('viewerModal');
            if (modal) modal.remove();
            window.currentViewerWorkbook = null;
            window.currentViewerSheetNames = null;
        }

        function switchViewerSheet(sheetName, index) {
            // Update tab styles
            const sheetCount = window.currentViewerSheetNames.length;
            for (let i = 0; i < sheetCount; i++) {
                const tab = document.getElementById(`sheet-tab-${i}`);
                if (tab) {
                    if (i === index) {
                        tab.className = 'sheet-tab px-4 py-2 rounded-t-lg text-sm font-medium transition bg-blue-600 text-white';
                    } else {
                        tab.className = 'sheet-tab px-4 py-2 rounded-t-lg text-sm font-medium transition bg-gray-200 text-gray-700 hover:bg-gray-300';
                    }
                }
            }
            
            // Load the selected sheet
            loadViewerSheet(index);
        }

        function loadViewerSheet(index) {
            const container = document.getElementById('sheetDataContainer');
            if (!container) return;
            
            const workbook = window.currentViewerWorkbook;
            const sheetNames = window.currentViewerSheetNames;
            
            if (!workbook || !sheetNames || index >= sheetNames.length) {
                container.innerHTML = '<p class="text-center py-8 text-gray-500">Sheet not found</p>';
                return;
            }
            
            const sheetName = sheetNames[index];
            const worksheet = workbook.Sheets[sheetName];
            
            // Convert to HTML with formatting
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            if (!jsonData || jsonData.length === 0) {
                container.innerHTML = '<p class="text-center py-8 text-gray-500">No data in this sheet</p>';
                document.getElementById('rowCount').innerText = '0 rows';
                return;
            }
            
            // Update row count
            document.getElementById('rowCount').innerText = `${jsonData.length - 1} data rows`;
            document.getElementById('sheetInfo').innerHTML = `Sheet: <span class="font-semibold">${sheetName}</span> ‚Ä¢ ${sheetNames.length} sheet(s) total`;
            
            // Build table with better styling
            let html = '<div class="overflow-x-auto"><table class="excel-viewer-table w-full">';
            
            // Headers
            const headers = jsonData[0] || [];
            html += '<thead><tr>';
            headers.forEach(header => {
                html += `<th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">${header || ''}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Data rows with alternating colors
            for (let i = 1; i < Math.min(jsonData.length, 1000); i++) {
                const row = jsonData[i] || [];
                const rowClass = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                html += `<tr class="${rowClass} hover:bg-blue-50 transition">`;
                
                for (let j = 0; j < headers.length; j++) {
                    const value = row[j] !== undefined && row[j] !== null ? row[j] : '';
                    
                    // Check if it's a mark column
                    const headerLower = String(headers[j] || '').toLowerCase();
                    const isMark = headerLower.includes('mark') || 
                                  headerLower.includes('total') || 
                                  headerLower.includes('final') || 
                                  headerLower.includes('score') ||
                                  headerLower.includes('grade') ||
                                  headerLower.includes('exam');
                    
                    if (isMark && !isNaN(parseFloat(value))) {
                        const num = parseFloat(value);
                        const grade = getGrade(num);
                        html += `<td class="px-4 py-2 text-sm ${grade.color} font-bold">${value}</td>`;
                    } else {
                        html += `<td class="px-4 py-2 text-sm text-gray-700">${value}</td>`;
                    }
                }
                html += '</tr>';
            }
            
            if (jsonData.length > 1000) {
                html += `<tr><td colspan="${headers.length}" class="text-center text-gray-500 py-4 text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    ... and ${jsonData.length - 1000} more rows
                </td></tr>`;
            }
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ========== CLASS FILTER FUNCTIONS ==========
        function toggleClassFilter(classYear) {
            if (selectedClasses.has(classYear)) {
                selectedClasses.delete(classYear);
                document.getElementById(`filter-class-${classYear}`).classList.remove('active');
            } else {
                selectedClasses.add(classYear);
                document.getElementById(`filter-class-${classYear}`).classList.add('active');
            }
            
            updateSelectedClassesDisplay();
            loadSharedFiles();
            updateFilteredCharts();
        }

        function toggleAllClasses() {
            const allClasses = ['2024', '2025', '2026', '2027', '2028', 'other'];
            const allSelected = allClasses.every(c => selectedClasses.has(c));
            
            if (allSelected) {
                selectedClasses.clear();
                allClasses.forEach(c => {
                    document.getElementById(`filter-class-${c}`).classList.remove('active');
                });
            } else {
                allClasses.forEach(c => {
                    selectedClasses.add(c);
                    document.getElementById(`filter-class-${c}`).classList.add('active');
                });
            }
            
            updateSelectedClassesDisplay();
            loadSharedFiles();
            updateFilteredCharts();
        }

        function clearClassFilter() {
            selectedClasses.clear();
            document.querySelectorAll('[id^="filter-class-"]').forEach(el => {
                el.classList.remove('active');
            });
            updateSelectedClassesDisplay();
            loadSharedFiles();
            updateFilteredCharts();
        }

        function updateSelectedClassesDisplay() {
            const container = document.getElementById('selectedClassesDisplay');
            const classNames = {
                '2024': 'March 2024',
                '2025': 'March 2025',
                '2026': 'March 2026',
                '2027': 'March 2027',
                '2028': 'March 2028',
                'other': 'Other'
            };
            
            if (selectedClasses.size === 0) {
                container.innerHTML = '<span class="text-sm text-gray-500">No filters applied - showing all classes</span>';
                return;
            }
            
            let html = '';
            selectedClasses.forEach(c => {
                html += `
                    <span class="selected-class-tag">
                        ${classNames[c] || c}
                        <i class="fas fa-times" onclick="toggleClassFilter('${c}')"></i>
                    </span>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== CLASS SELECTION FOR UPLOAD ==========
        function showClassSelectionModal() {
            pendingFileClasses.clear();
            document.querySelectorAll('.class-option').forEach(opt => {
                opt.classList.remove('selected');
                const checkbox = opt.querySelector('.class-checkbox');
                if (checkbox) {
                    checkbox.style.background = 'white';
                    checkbox.style.color = 'white';
                }
            });
            
            document.getElementById('classModal').style.display = 'flex';
        }

        function toggleClass(classYear) {
            const option = event.currentTarget;
            const checkbox = document.getElementById(`class-check-${classYear}`);
            
            if (pendingFileClasses.has(classYear)) {
                pendingFileClasses.delete(classYear);
                option.classList.remove('selected');
                if (checkbox) {
                    checkbox.style.background = 'white';
                    checkbox.style.color = 'white';
                }
            } else {
                pendingFileClasses.add(classYear);
                option.classList.add('selected');
                if (checkbox) {
                    checkbox.style.background = '#4f46e5';
                    checkbox.style.color = 'white';
                }
            }
        }

        function cancelClassSelection() {
            document.getElementById('classModal').style.display = 'none';
            pendingFileClasses.clear();
            pendingFile = null;
        }

        function confirmClassSelection() {
            if (pendingFileClasses.size === 0) {
                showToast('Please select at least one class', 'error');
                return;
            }
            
            document.getElementById('classModal').style.display = 'none';
            
            const filename = pendingFile.name;
            const classList = Array.from(pendingFileClasses).join('_');
            const fileExt = filename.split('.').pop();
            const baseName = filename.substring(0, filename.lastIndexOf('.'));
            
            pendingFile.finalName = `${baseName}_[${classList}].${fileExt}`;
            pendingFile.classList = Array.from(pendingFileClasses);
            
            showFilePreview(pendingFile);
        }

        // ========== HANDLE EXCEL UPLOAD ==========
        async function handleExcelUpload(input) {
            if (!input.files || input.files.length === 0) return;
            
            const file = input.files[0];
            showLoading('Processing Excel file...', true, 60000);
            
            try {
                debugLog(`üìÅ Processing file: ${file.name}`);
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        debugLog(`üìä Workbook has ${workbook.SheetNames.length} sheets`);
                        
                        pendingFile = {
                            name: file.name,
                            data: XLSX.write(workbook, { type: 'base64' }),
                            workbook: workbook,
                            rowCount: 0
                        };
                        
                        const firstSheet = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheet];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        pendingFile.rowCount = jsonData.length;
                        
                        hideLoading();
                        showClassSelectionModal();
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        hideLoading();
                        showToast('Error processing file: ' + error.message, 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Upload error:', error);
                hideLoading();
                showToast('Error uploading file: ' + error.message, 'error');
            }
        }

        function showFilePreview(fileData) {
            const workbook = fileData.workbook;
            const firstSheet = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheet];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            const classNames = {
                '2024': 'March 2024',
                '2025': 'March 2025',
                '2026': 'March 2026',
                '2027': 'March 2027',
                '2028': 'March 2028',
                'other': 'Other'
            };
            
            const classDisplay = fileData.classList.map(c => classNames[c] || c).join(', ');
            
            let previewHtml = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
            
            if (jsonData.length > 0) {
                previewHtml += '<thead class="bg-gray-50"><tr>';
                (jsonData[0] || []).forEach(header => {
                    previewHtml += `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header || ''}</th>`;
                });
                previewHtml += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                for (let i = 1; i < Math.min(jsonData.length, 11); i++) {
                    const row = jsonData[i] || [];
                    previewHtml += '<tr>';
                    row.forEach(cell => {
                        previewHtml += `<td class="px-3 py-2 text-xs text-gray-500">${cell || ''}</td>`;
                    });
                    previewHtml += '</tr>';
                }
                
                if (jsonData.length > 11) {
                    previewHtml += `<tr><td colspan="${jsonData[0].length}" class="px-3 py-2 text-xs text-gray-400 italic">... and ${jsonData.length - 11} more rows</td></tr>`;
                }
                
                previewHtml += '</tbody></table></div>';
                
                previewHtml = `
                    <div class="mb-3 p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm"><span class="font-semibold">File:</span> ${fileData.finalName || fileData.name}</p>
                        <p class="text-sm"><span class="font-semibold">Classes:</span> ${classDisplay}</p>
                        <p class="text-sm"><span class="font-semibold">Sheets:</span> ${workbook.SheetNames.length}</p>
                        <p class="text-sm"><span class="font-semibold">Rows:</span> ${fileData.rowCount}</p>
                    </div>
                ` + previewHtml;
            }
            
            document.getElementById('filePreview').innerHTML = previewHtml;
            document.getElementById('filePreviewSection').classList.remove('hidden');
        }

        // ========== PUBLISH FILE ==========
        async function publishFile() {
            if (!pendingFile) {
                showToast('No file to publish', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('You must be logged in', 'error');
                return;
            }
            
            showLoading('Publishing file...', true, 60000);
            
            try {
                debugLog(`üì§ Publishing: ${pendingFile.finalName || pendingFile.name}`);
                
                const { data, error } = await supabase
                    .from('shared_excel_files')
                    .insert([{
                        filename: pendingFile.finalName || pendingFile.name,
                        file_data: pendingFile.data,
                        uploaded_by: currentUser.id,
                        uploaded_by_email: currentUser.email,
                        row_count: pendingFile.rowCount || 0,
                        classes: pendingFile.classList ? pendingFile.classList.join(',') : '',
                        uploaded_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                debugLog('‚úÖ File published successfully');
                
                document.getElementById('filePreviewSection').classList.add('hidden');
                document.getElementById('filePreview').innerHTML = '';
                document.getElementById('excelUpload').value = '';
                pendingFile = null;
                pendingFileClasses.clear();
                
                hideLoading();
                showToast('File published successfully', 'success');
                
                loadSharedFiles();
                loadAllStudentMarks();
                
            } catch (error) {
                console.error('Publish error:', error);
                hideLoading();
                showToast('Error publishing file: ' + error.message, 'error');
            }
        }

        function closeFilePreview() {
            document.getElementById('filePreviewSection').classList.add('hidden');
            document.getElementById('filePreview').innerHTML = '';
            pendingFile = null;
            pendingFileClasses.clear();
        }

        // ========== LOGOUT ==========
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            currentRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainPortal').classList.add('hidden');
            showToast('Logged out successfully', 'success');
        }

        // ========== CLEAR SEARCH ==========
        function clearSearch() {
            document.getElementById('studentSearchInput').value = '';
            document.getElementById('studentResultsContainer').classList.add('hidden');
            document.getElementById('studentResultsTable').innerHTML = '';
        }

        // ========== LOAD SHARED FILES ==========
        async function loadSharedFiles() {
            try {
                const { data: files, error } = await supabase
                    .from('shared_excel_files')
                    .select('*')
                    .order('uploaded_at', { ascending: false });
                
                if (error) throw error;
                
                sharedFiles = files || [];
                
                let filteredFiles = sharedFiles;
                if (selectedClasses.size > 0) {
                    filteredFiles = filteredFiles.filter(file => {
                        if (!file.classes) return false;
                        const fileClasses = file.classes.split(',');
                        return Array.from(selectedClasses).some(c => fileClasses.includes(c));
                    });
                }
                
                const container = document.getElementById('sharedFilesContainer');
                document.getElementById('filteredFileCount').innerText = filteredFiles.length;
                
                if (filteredFiles.length === 0) {
                    container.innerHTML = `<div class="col-span-3 text-center py-8 text-gray-500 text-sm">No files match the selected filters</div>`;
                    return;
                }
                
                container.innerHTML = filteredFiles.map(file => {
                    const date = new Date(file.uploaded_at).toLocaleString();
                    const canEdit = currentRole === 'admin' || currentRole === 'super_admin';
                    
                    const fileClasses = file.classes ? file.classes.split(',') : [];
                    const classNames = {
                        '2024': 'March 2024',
                        '2025': 'March 2025',
                        '2026': 'March 2026',
                        '2027': 'March 2027',
                        '2028': 'March 2028',
                        'other': 'Other'
                    };
                    
                    const classDisplay = fileClasses.map(c => classNames[c] || c).join(', ');
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition bg-white">
                            <div class="flex items-start">
                                <i class="fas fa-file-excel text-green-600 text-2xl mr-3"></i>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <p class="font-semibold text-gray-800 text-sm truncate" title="${file.filename}">${file.filename}</p>
                                    </div>
                                    <div class="flex items-center mt-1 text-xs gap-1 flex-wrap">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${file.row_count || 0} records</span>
                                        <span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">${classDisplay}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1"><i class="fas fa-user mr-1"></i>${file.uploaded_by_email || 'Unknown'} ‚Ä¢ ${date}</p>
                                    <div class="mt-2 flex gap-1 flex-wrap">
                                        ${canEdit ? `<button onclick="openInGoogleSheets('${file.id}')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700"><i class="fab fa-google mr-1"></i>Edit</button>` : ''}
                                        <button onclick="viewFile('${file.id}')" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700"><i class="fas fa-eye mr-1"></i>View</button>
                                        ${canEdit ? `<button onclick="deleteFile('${file.id}', '${file.filename}')" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700"><i class="fas fa-trash mr-1"></i>Delete</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) { 
                debugLog('‚ùå Error loading files: ' + error.message);
                console.error(error); 
            }
        }

        // ========== DELETE FILE ==========
        async function deleteFile(fileId, filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"? This cannot be undone.`)) {
                return;
            }
            
            showLoading('Deleting file...', false, 30000);
            
            try {
                const { error } = await supabase
                    .from('shared_excel_files')
                    .delete()
                    .eq('id', fileId);
                
                if (error) throw error;
                
                hideLoading();
                showToast('File deleted successfully', 'success');
                
                loadSharedFiles();
                loadAllStudentMarks();
                
            } catch (error) {
                console.error('Delete error:', error);
                hideLoading();
                showToast('Error deleting file: ' + error.message, 'error');
            }
        }

        // ========== LOGIN FUNCTION ==========
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { showToast('Enter email and password', 'error'); return; }
            
            showLoading('Logging in...', false, 10000);
            
            try {
                debugLog('üîê Attempting login for: ' + email);
                
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({ 
                    email, 
                    password 
                });
                
                if (authError) throw authError;
                
                debugLog('‚úÖ Auth successful for: ' + authData.user.email);
                
                const { data: profile, error: profileError } = await supabase
                    .from('consolidated_user_profiles_table')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (profileError) {
                    debugLog('üìù Creating new profile...');
                    const { data: newProfile, error: createError } = await supabase
                        .from('consolidated_user_profiles_table')
                        .insert([{
                            email: email,
                            full_name: email.split('@')[0],
                            role: email.includes('admin') ? 'admin' : 'lecturer',
                            department: 'Nursing',
                            is_active: true,
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (createError) throw createError;
                    
                    currentUser = newProfile;
                    currentRole = newProfile.role;
                } else {
                    currentUser = profile;
                    currentRole = profile.role;
                }
                
                debugLog('‚úÖ User role: ' + currentRole);
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainPortal').classList.remove('hidden');
                
                document.getElementById('userDisplayName').innerHTML = `<i class="fas fa-user mr-1"></i>${currentUser.full_name || currentUser.email}`;
                document.getElementById('userEmailDisplay').innerText = currentUser.email;
                document.getElementById('userRoleDisplay').innerText = currentRole.replace('_', ' ').toUpperCase();
                
                const badge = document.getElementById('userRoleBadge');
                badge.innerText = currentRole.replace('_', ' ').toUpperCase();
                
                if (currentRole === 'admin' || currentRole === 'super_admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminSearchSection').classList.remove('hidden');
                } else {
                    document.getElementById('adminDashboard').classList.add('hidden');
                    document.getElementById('adminSearchSection').classList.add('hidden');
                }
                
                hideLoading();
                showToast('Login successful!', 'success');
                
                setTimeout(() => { 
                    loadSharedFiles(); 
                    loadAllStudentMarks(); 
                }, 100);
                
            } catch (error) {
                debugLog('‚ùå Login error: ' + error.message);
                hideLoading();
                showToast(error.message, 'error');
            }
        }

       // ========== LOAD ALL STUDENT MARKS ==========
async function loadAllStudentMarks() {
    if (isProcessing) {
        processingQueue.push(loadAllStudentMarks);
        return;
    }
    
    isProcessing = true;
    showLoading('Loading data...', true, 60000);
    
    try {
        debugLog('üì° Fetching files from Supabase...');
        
        const { data: files, error } = await supabase
            .from('shared_excel_files')
            .select('id, filename, file_data, uploaded_by_email, uploaded_at, classes')
            .order('uploaded_at', { ascending: false });
        
        if (error) throw error;
        
        if (!files || files.length === 0) {
            debugLog('‚ö†Ô∏è No files found');
            document.getElementById('totalFilesStats').innerText = '0';
            document.getElementById('totalRecordsStats').innerText = '0';
            hideLoading();
            isProcessing = false;
            return;
        }
        
        debugLog(`üìÅ Found ${files.length} files`);
        sharedFiles = files;
        
        allStudentMarks = [];
        studentIndex.clear();
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const progress = (i / files.length) * 100;
            updateProgress(progress);
            
            debugLog(`üìä Processing file ${i+1}/${files.length}: ${file.filename?.substring(0, 30)}...`);
            document.getElementById('loadingMessage').innerText = `File ${i+1}/${files.length}: ${file.filename?.substring(0, 30)}...`;
            
            if (!file.file_data) {
                debugLog(`‚ö†Ô∏è File ${i+1} has no data, skipping`);
                continue;
            }
            
            try {
                const binaryData = atob(file.file_data);
                const array = new Uint8Array(binaryData.length);
                for (let j = 0; j < binaryData.length; j++) {
                    array[j] = binaryData.charCodeAt(j);
                }
                
                const workbook = XLSX.read(array, { type: 'array' });
                
                for (const sheetName of workbook.SheetNames) {
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Get the sheet as array of arrays to check top rows
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    debugLog(`üìä Sheet "${sheetName}" has ${sheetData.length} rows total`);
                    
                    if (!sheetData || sheetData.length === 0) continue;
                    
                    // Extract sheet-level metadata from top rows
                    let sheetTitle = sheetName;
                    let sheetSubject = '';
                    let sheetExamType = '';
                    let sheetYear = '';
                    let sheetClass = '';
                    
                    // Check first few rows for metadata (headers might be in row 0,1,2,3)
                    for (let rowIdx = 0; rowIdx < Math.min(5, sheetData.length); rowIdx++) {
                        const row = sheetData[rowIdx] || [];
                        const rowText = row.join(' ').toLowerCase();
                        
                        // Look for subject information in top rows
                        if (rowText.includes('medical surgical') || rowText.includes('med surg')) {
                            sheetSubject = 'Medical Surgical Nursing';
                        } else if (rowText.includes('community health') || rowText.includes('comm health')) {
                            sheetSubject = 'Community Health Nursing';
                        } else if (rowText.includes('anatomy') || rowText.includes('physiology')) {
                            sheetSubject = 'Anatomy & Physiology';
                        } else if (rowText.includes('maternal') || rowText.includes('obstetrics')) {
                            sheetSubject = 'Maternal Health Nursing';
                        } else if (rowText.includes('pediatric') || rowText.includes('paediatric') || rowText.includes('child')) {
                            sheetSubject = 'Paediatric Nursing';
                        } else if (rowText.includes('mental') || rowText.includes('psychiatric')) {
                            sheetSubject = 'Mental Health Nursing';
                        } else if (rowText.includes('pharmacology')) {
                            sheetSubject = 'Pharmacology';
                        } else if (rowText.includes('nutrition')) {
                            sheetSubject = 'Nutrition & Dietetics';
                        } else if (rowText.includes('first aid')) {
                            sheetSubject = 'First Aid & Emergency';
                        }
                        
                        // Look for exam type
                        if (rowText.includes('final')) sheetExamType = 'FINAL';
                        else if (rowText.includes('cat')) sheetExamType = 'CAT';
                        else if (rowText.includes('assignment')) sheetExamType = 'ASSIGNMENT';
                        else if (rowText.includes('practical')) sheetExamType = 'PRACTICAL';
                        
                        // Look for year/class
                        if (rowText.includes('2024')) sheetYear = '2024';
                        else if (rowText.includes('2025')) sheetYear = '2025';
                        else if (rowText.includes('2026')) sheetYear = '2026';
                        else if (rowText.includes('2027')) sheetYear = '2027';
                        else if (rowText.includes('2028')) sheetYear = '2028';
                        
                        // Look for class information
                        if (rowText.includes('march')) sheetClass = 'March';
                        else if (rowText.includes('september')) sheetClass = 'September';
                        else if (rowText.includes('may')) sheetClass = 'May';
                        else if (rowText.includes('december')) sheetClass = 'December';
                    }
                    
                    // Find the header row (usually the first row with multiple non-empty cells)
                    let headerRowIndex = 0;
                    for (let rowIdx = 0; rowIdx < sheetData.length; rowIdx++) {
                        const row = sheetData[rowIdx] || [];
                        const nonEmptyCount = row.filter(cell => cell && String(cell).trim() !== '').length;
                        if (nonEmptyCount > 2) {
                            headerRowIndex = rowIdx;
                            break;
                        }
                    }
                    
                    // Get headers from the identified header row
                    const headers = sheetData[headerRowIndex] || [];
                    debugLog(`üìã Sheet "${sheetName}" headers: ${headers.filter(h => h).join(', ')}`);
                    
                    // Process data rows (skip header row and any metadata rows before it)
                    for (let rowIdx = headerRowIndex + 1; rowIdx < sheetData.length; rowIdx++) {
                        const row = sheetData[rowIdx];
                        if (!row || row.length === 0) continue;
                        
                        // Check if row is empty (all cells empty)
                        if (row.every(cell => !cell || String(cell).trim() === '')) continue;
                        
                        // Create object with headers as keys
                        const rowObj = {};
                        headers.forEach((header, colIdx) => {
                            if (header && String(header).trim() !== '') {
                                rowObj[header] = row[colIdx];
                            }
                        });
                        
                        // Also add numeric indices for fallback
                        row.forEach((cell, colIdx) => {
                            rowObj[`col_${colIdx}`] = cell;
                        });
                        
                        // Try to find student identifier
                        let studentId = '';
                        let studentName = '';
                        
                        // Check each cell for student identification patterns
                        Object.entries(rowObj).forEach(([key, value]) => {
                            const keyLower = String(key).toLowerCase();
                            const valueStr = String(value || '').toLowerCase();
                            
                            // Look for admission numbers (pattern like KRCHN/0100/MAR/2025)
                            if (!studentId && valueStr.match(/krchn\/\d+\/[a-z]+\/\d+/i)) {
                                studentId = String(value);
                            }
                            // Look for ID fields
                            else if (!studentId && (
                                keyLower.includes('adm') || 
                                keyLower.includes('reg') || 
                                keyLower.includes('id') || 
                                keyLower.includes('no')
                            )) {
                                if (value) studentId = String(value).trim();
                            }
                            
                            // Look for name fields
                            if (!studentName && (
                                keyLower.includes('name') || 
                                keyLower.includes('student') ||
                                keyLower.includes('candidate')
                            )) {
                                if (value) studentName = String(value).trim();
                            }
                        });
                        
                        // If no student identifier found, skip this row
                        if (!studentId && !studentName) continue;
                        
                        // If no name but we have ID, use ID as name
                        if (!studentName && studentId) {
                            studentName = studentId;
                        }
                        
                        // Extract marks - LOOK AT EVERY CELL
                        let marks = [];
                        
                        // First, check if this sheet represents a specific subject
                        if (sheetSubject) {
                            // This sheet is for one subject, look for mark columns
                            headers.forEach((header, colIdx) => {
                                if (!header) return;
                                
                                const headerStr = String(header);
                                const headerLower = headerStr.toLowerCase();
                                const cellValue = row[colIdx];
                                
                                // Check if this column contains marks
                                const isMarkColumn = 
                                    headerLower.includes('mark') || 
                                    headerLower.includes('score') ||
                                    headerLower.includes('grade') ||
                                    headerLower.includes('total') ||
                                    headerLower.includes('exam') ||
                                    headerLower.includes('final') ||
                                    headerLower.includes('cat') ||
                                    headerLower.includes('ass') ||
                                    headerLower.includes('prac');
                                
                                if (cellValue !== undefined && cellValue !== null) {
                                    const numValue = parseFloat(cellValue);
                                    if (!isNaN(numValue) && numValue >= 0 && numValue <= 100) {
                                        // Determine assessment type
                                        let assessmentType = sheetExamType || 'EXAM';
                                        if (headerLower.includes('cat')) assessmentType = 'CAT';
                                        else if (headerLower.includes('final')) assessmentType = 'FINAL';
                                        else if (headerLower.includes('ass')) assessmentType = 'ASSIGNMENT';
                                        else if (headerLower.includes('prac')) assessmentType = 'PRACTICAL';
                                        
                                        marks.push({
                                            subject: sheetSubject,
                                            assessmentType: assessmentType,
                                            mark: numValue,
                                            grade: getGrade(numValue),
                                            originalColumn: headerStr
                                        });
                                    }
                                }
                            });
                        } else {
                            // Multiple subjects might be in this sheet, check each column
                            headers.forEach((header, colIdx) => {
                                if (!header) return;
                                
                                const headerStr = String(header);
                                const headerUpper = headerStr.toUpperCase();
                                const cellValue = row[colIdx];
                                
                                if (cellValue !== undefined && cellValue !== null) {
                                    const numValue = parseFloat(cellValue);
                                    if (!isNaN(numValue) && numValue >= 0 && numValue <= 100) {
                                        // Try to determine subject from header
                                        let subjectName = headerStr;
                                        
                                        // Map common subject keywords
                                        if (headerUpper.includes('MED SURG') || headerUpper.includes('MEDICAL SURGICAL')) {
                                            subjectName = 'Medical Surgical Nursing';
                                        } else if (headerUpper.includes('COMM HEALTH') || headerUpper.includes('COMMUNITY')) {
                                            subjectName = 'Community Health Nursing';
                                        } else if (headerUpper.includes('ANATOMY') || headerUpper.includes('PHYSIO')) {
                                            subjectName = 'Anatomy & Physiology';
                                        } else if (headerUpper.includes('MATERNAL') || headerUpper.includes('OBSTETRICS')) {
                                            subjectName = 'Maternal Health Nursing';
                                        } else if (headerUpper.includes('PAEDIATRIC') || headerUpper.includes('PEDIATRIC') || headerUpper.includes('CHILD')) {
                                            subjectName = 'Paediatric Nursing';
                                        } else if (headerUpper.includes('MENTAL') || headerUpper.includes('PSYCH')) {
                                            subjectName = 'Mental Health Nursing';
                                        } else if (headerUpper.includes('PHARMA')) {
                                            subjectName = 'Pharmacology';
                                        } else if (headerUpper.includes('NUTRITION')) {
                                            subjectName = 'Nutrition & Dietetics';
                                        } else if (headerUpper.includes('FIRST AID')) {
                                            subjectName = 'First Aid & Emergency';
                                        } else if (headerUpper.includes('FINAL MARK') || headerUpper.includes('FINAL')) {
                                            subjectName = sheetSubject || 'Comprehensive Exam';
                                        } else if (headerUpper.includes('CAT')) {
                                            subjectName = sheetSubject || 'Continuous Assessment';
                                        }
                                        
                                        marks.push({
                                            subject: subjectName,
                                            assessmentType: headerUpper.includes('FINAL') ? 'FINAL' : 
                                                            headerUpper.includes('CAT') ? 'CAT' : 
                                                            headerUpper.includes('ASS') ? 'ASSIGNMENT' : 'EXAM',
                                            mark: numValue,
                                            grade: getGrade(numValue),
                                            originalColumn: headerStr
                                        });
                                    }
                                }
                            });
                        }
                        
                        // Also check the sheet name for subject context
                        if (marks.length === 0 && sheetSubject) {
                            // Look for any numeric values that might be marks
                            row.forEach((cell, colIdx) => {
                                const numValue = parseFloat(cell);
                                if (!isNaN(numValue) && numValue >= 0 && numValue <= 100) {
                                    marks.push({
                                        subject: sheetSubject,
                                        assessmentType: sheetExamType || 'EXAM',
                                        mark: numValue,
                                        grade: getGrade(numValue),
                                        originalColumn: `Column ${colIdx + 1}`
                                    });
                                }
                            });
                        }
                        
                        // Create record
                        const studentKey = (studentId || studentName).toLowerCase();
                        const record = {
                            fileId: file.id,
                            filename: file.filename,
                            sheetName: sheetName,
                            sheetSubject: sheetSubject,
                            sheetExamType: sheetExamType,
                            sheetYear: sheetYear,
                            sheetClass: sheetClass,
                            studentId: studentId,
                            studentName: studentName,
                            marks: marks,
                            rawData: rowObj,
                            rawRow: row
                        };
                        
                        if (!studentIndex.has(studentKey)) {
                            studentIndex.set(studentKey, []);
                        }
                        
                        studentIndex.get(studentKey).push(record);
                        allStudentMarks.push(record);
                        
                        // Debug log for first few records
                        if (allStudentMarks.length <= 10) {
                            debugLog(`üìù ${studentName} (${studentId}): ${marks.length} marks from sheet "${sheetName}"`);
                            if (marks.length > 0) {
                                marks.forEach(m => {
                                    debugLog(`   - ${m.subject} (${m.assessmentType}): ${m.mark}`);
                                });
                            }
                        }
                    }
                }
            } catch (fileError) {
                debugLog(`‚ùå Error processing file ${file.filename}: ${fileError.message}`);
                console.error(fileError);
            }
        }
        
        debugLog(`‚úÖ Processed ${allStudentMarks.length} student records total`);
        
        const totalMarks = allStudentMarks.reduce((sum, record) => sum + record.marks.length, 0);
        debugLog(`üìä Total marks extracted: ${totalMarks}`);
        
        document.getElementById('totalFilesStats').innerText = files.length;
        document.getElementById('totalRecordsStats').innerText = allStudentMarks.length;
        
        updateStatsAndCharts();
        hideLoading();
        isProcessing = false;
        
        if (processingQueue.length > 0) {
            const next = processingQueue.shift();
            setTimeout(next, 100);
        }
        
    } catch (error) {
        console.error('Error loading student marks:', error);
        hideLoading();
        isProcessing = false;
        showToast('Error loading data: ' + error.message, 'error');
    }
}

        // ========== UPDATE STATS AND CHARTS ==========
        function updateStatsAndCharts() {
            try {
                // Filter marks based on selected classes
                let filteredMarks = allStudentMarks;
                
                if (selectedClasses.size > 0) {
                    filteredMarks = filteredMarks.filter(mark => {
                        const file = sharedFiles.find(f => f.id === mark.fileId);
                        if (!file || !file.classes) return false;
                        const fileClasses = file.classes.split(',');
                        return Array.from(selectedClasses).some(c => fileClasses.includes(c));
                    });
                }
                
                // Update chart filter badges
                const classNames = Array.from(selectedClasses).map(c => {
                    const map = {'2024':'Mar24','2025':'Mar25','2026':'Mar26','2027':'Mar27','2028':'Mar28','other':'Other'};
                    return map[c] || c;
                }).join(', ');
                
                document.getElementById('chartFilterBadge').innerText = selectedClasses.size > 0 ? classNames : 'All Classes';
                document.getElementById('barChartFilterBadge').innerText = selectedClasses.size > 0 ? classNames : 'All Classes';
                
                // Calculate grade distribution
                let gradeCounts = { A: 0, B: 0, C: 0, D: 0 };
                let markRanges = { '0-59': 0, '60-74': 0, '75-84': 0, '85-100': 0 };
                
                filteredMarks.forEach(record => {
                    record.marks.forEach(m => {
                        if (m.grade.grade === 'A') gradeCounts.A++;
                        else if (m.grade.grade === 'B') gradeCounts.B++;
                        else if (m.grade.grade === 'C') gradeCounts.C++;
                        else gradeCounts.D++;
                        
                        if (m.mark < 60) markRanges['0-59']++;
                        else if (m.mark < 75) markRanges['60-74']++;
                        else if (m.mark < 85) markRanges['75-84']++;
                        else markRanges['85-100']++;
                    });
                });
                
                // Update pie chart
                const ctx1 = document.getElementById('performanceChart').getContext('2d');
                if (performanceChart) performanceChart.destroy();
                
                performanceChart = new Chart(ctx1, {
                    type: 'pie',
                    data: {
                        labels: ['A (85-100)', 'B (75-84)', 'C (60-74)', 'D (0-59)'],
                        datasets: [{
                            data: [gradeCounts.A, gradeCounts.B, gradeCounts.C, gradeCounts.D],
                            backgroundColor: ['#4F46E5', '#059669', '#D97706', '#DC2626'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
                
                // Update bar chart
                const ctx2 = document.getElementById('distributionChart').getContext('2d');
                if (distributionChart) distributionChart.destroy();
                
                distributionChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['0-59 (D)', '60-74 (C)', '75-84 (B)', '85-100 (A)'],
                        datasets: [{
                            label: 'Number of Marks',
                            data: [markRanges['0-59'], markRanges['60-74'], markRanges['75-84'], markRanges['85-100']],
                            backgroundColor: ['#DC2626', '#D97706', '#059669', '#4F46E5'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, grid: { display: false } }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        function updateFilteredCharts() {
            updateStatsAndCharts();
        }

// ========== SEARCH STUDENT MARKS ==========
function searchStudentMarks() {
    const searchTerm = document.getElementById('studentSearchInput').value.trim().toLowerCase();
    if (!searchTerm) {
        showToast('Please enter a search term', 'error');
        return;
    }
    
    showLoading('Searching...', false, 30000);
    
    try {
        console.log('üîç Searching for:', searchTerm);
        
        // Search for the student
        let results = [];
        
        // Try to find by admission number pattern
        const isAdmissionPattern = searchTerm.includes('krchn') || searchTerm.includes('/');
        
        allStudentMarks.forEach(record => {
            const studentNameMatch = record.studentName && record.studentName.toLowerCase().includes(searchTerm);
            const studentIdMatch = record.studentId && record.studentId.toLowerCase().includes(searchTerm);
            
            // Also check raw data for admission number
            let rawMatch = false;
            if (record.rawData) {
                Object.values(record.rawData).forEach(val => {
                    const valStr = String(val || '').toLowerCase();
                    if (valStr.includes(searchTerm) || (isAdmissionPattern && valStr.includes('krchn'))) {
                        rawMatch = true;
                    }
                });
            }
            
            if (studentNameMatch || studentIdMatch || rawMatch) {
                results.push(record);
            }
        });
        
        console.log(`Found ${results.length} records for student`);
        
        if (results.length === 0) {
            hideLoading();
            showToast('No results found', 'info');
            document.getElementById('studentResultsContainer').classList.add('hidden');
            return;
        }
        
        // Group marks by ACTUAL SUBJECT (using sheet name as the primary subject)
        const subjectGroups = new Map();
        const sheetSubjects = new Map(); // Track which sheets we've seen
        
        results.forEach(record => {
            const sheetName = record.sheetName || 'Unknown';
            const filename = record.filename || 'Unknown';
            
            // Extract the actual subject from sheet name
            let actualSubject = sheetName;
            
            // Clean up sheet name to get proper subject
            if (sheetName.includes('MIDWIFERY')) {
                actualSubject = 'Midwifery';
            } else if (sheetName.includes('PHARMACOLOGY')) {
                actualSubject = 'Pharmacology II';
            } else if (sheetName.includes('SPECIALISED')) {
                actualSubject = 'Specialised Nursing Practice';
            } else if (sheetName.includes('HEMATOLOGICAL')) {
                actualSubject = 'Hematological Conditions';
            } else if (sheetName.includes('RESPIRATORY')) {
                actualSubject = 'Respiratory Conditions';
            } else if (sheetName.includes('IMMUNIZATION')) {
                actualSubject = 'Immunization';
            } else if (sheetName.includes('TRAUMA')) {
                actualSubject = 'Trauma Nursing';
            } else if (sheetName.includes('SRH')) {
                actualSubject = 'Sexual & Reproductive Health';
            } else if (sheetName.includes('COMMUNITY HEALTH')) {
                actualSubject = 'Community Health Nursing';
            } else if (sheetName.includes('CARDIOVASCULAR')) {
                actualSubject = 'Cardiovascular Conditions';
            } else {
                actualSubject = sheetName; // Keep original if no match
            }
            
            // Track sheet subjects
            if (!sheetSubjects.has(actualSubject)) {
                sheetSubjects.set(actualSubject, new Set());
            }
            sheetSubjects.get(actualSubject).add(filename);
            
            // Now extract marks from this record
            if (record.marks && record.marks.length > 0) {
                record.marks.forEach(mark => {
                    const markValue = mark.mark;
                    const columnName = mark.subject || 'Unknown';
                    
                    // Determine assessment type based on column name
                    let assessmentType = 'EXAM';
                    const colLower = columnName.toLowerCase();
                    
                    if (colLower.includes('cat')) {
                        assessmentType = 'CAT';
                    } else if (colLower.includes('final')) {
                        assessmentType = 'FINAL';
                    } else if (colLower.includes('continuous') || colLower.includes('ca')) {
                        assessmentType = 'CONTINUOUS ASSESSMENT';
                    } else if (colLower.includes('ebe')) {
                        assessmentType = 'EBE';
                    }
                    
                    // Create a unique key for this subject-assessment combination
                    const subjectKey = `${actualSubject}`;
                    
                    if (!subjectGroups.has(subjectKey)) {
                        subjectGroups.set(subjectKey, {
                            subject: actualSubject,
                            marks: [],
                            assessments: new Set(),
                            files: new Set()
                        });
                    }
                    
                    const subjectData = subjectGroups.get(subjectKey);
                    subjectData.marks.push(markValue);
                    subjectData.assessments.add(assessmentType);
                    subjectData.files.add(filename);
                });
            } else if (record.rawData) {
                // Try to extract from rawData
                Object.entries(record.rawData).forEach(([key, value]) => {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue) && numValue > 0 && numValue <= 100) {
                        const subjectKey = `${actualSubject}`;
                        
                        if (!subjectGroups.has(subjectKey)) {
                            subjectGroups.set(subjectKey, {
                                subject: actualSubject,
                                marks: [],
                                assessments: new Set(),
                                files: new Set()
                            });
                        }
                        
                        const subjectData = subjectGroups.get(subjectKey);
                        subjectData.marks.push(numValue);
                        
                        // Determine assessment type from column name
                        const colLower = key.toLowerCase();
                        if (colLower.includes('cat')) {
                            subjectData.assessments.add('CAT');
                        } else if (colLower.includes('final')) {
                            subjectData.assessments.add('FINAL');
                        } else if (colLower.includes('ebe')) {
                            subjectData.assessments.add('EBE');
                        } else {
                            subjectData.assessments.add('EXAM');
                        }
                        
                        subjectData.files.add(filename);
                    }
                });
            }
        });
        
        // Calculate averages and grades for each subject
        const subjects = Array.from(subjectGroups.values()).map(data => {
            const avgMark = data.marks.reduce((a, b) => a + b, 0) / data.marks.length;
            const grade = getGrade(avgMark);
            
            return {
                subject: data.subject,
                marks: data.marks,
                avgMark: avgMark,
                grade: grade,
                assessments: Array.from(data.assessments).join(', '),
                files: Array.from(data.files)
            };
        }).sort((a, b) => b.avgMark - a.avgMark);
        
        // Calculate overall stats
        const totalMarks = subjects.reduce((sum, s) => sum + s.avgMark, 0);
        const avgOverall = subjects.length > 0 ? totalMarks / subjects.length : 0;
        const totalPoints = subjects.reduce((sum, s) => sum + s.grade.points, 0);
        const gpa = subjects.length > 0 ? (totalPoints / subjects.length).toFixed(2) : '0.00';
        const overallGrade = getGrade(avgOverall);
        
        // Get student info
        const studentInfo = results[0];
        const studentName = studentInfo.studentName || searchTerm;
        let studentId = studentInfo.studentId || '';
        
        // Try to find admission number in raw data if not found
        if (!studentId && studentInfo.rawData) {
            Object.entries(studentInfo.rawData).forEach(([key, value]) => {
                const valStr = String(value || '');
                if (valStr.includes('KRCHN/')) {
                    studentId = valStr;
                }
            });
        }
        
        // Store for transcript
        currentTranscriptData = {
            studentName: studentName,
            studentId: studentId || 'N/A',
            subjects: subjects,
            avgOverall: avgOverall,
            overallGrade: overallGrade,
            gpa: gpa,
            totalPoints: totalPoints
        };
        
        // Update summary card
        document.getElementById('studentNameDisplay').innerText = studentName;
        document.getElementById('studentIdDisplay').innerHTML = `<i class="fas fa-id-card mr-1"></i>Admission No: ${studentId || 'N/A'}`;
        document.getElementById('studentProgramDisplay').innerHTML = `<i class="fas fa-graduation-cap mr-1"></i>Program: KRCHN (Kenya Registered Community Health Nurse)`;
        
        document.getElementById('overallGradeDisplay').innerText = `Grade: ${overallGrade.grade}`;
        document.getElementById('overallGradeDisplay').className = `grade-badge ${overallGrade.class} text-sm px-4 py-2`;
        
        document.getElementById('gpaDisplay').innerHTML = `<i class="fas fa-star mr-1"></i>GPA: ${gpa}`;
        
        document.getElementById('totalExamsCount').innerText = subjects.length;
        document.getElementById('averageMarkDisplay').innerText = avgOverall.toFixed(1);
        document.getElementById('totalPointsDisplay').innerText = totalPoints;
        document.getElementById('gpaValueDisplay').innerText = gpa;
        
        // Build results table
        let tableHtml = '<table class="data-table"><thead><tr><th>Subject</th><th>Assessment</th><th>Marks</th><th>Average</th><th>Grade</th><th>Points</th><th>Status</th></tr></thead><tbody>';
        
        subjects.forEach(s => {
            const marksList = s.marks.map(m => 
                `<span class="font-mono ${getGrade(m).color}" title="Mark: ${m}">${m}</span>`
            ).join(', ');
            
            // Determine row color based on grade
            const rowClass = s.grade.pass ? '' : 'bg-red-50';
            
            tableHtml += `
                <tr class="${rowClass}">
                    <td class="font-medium">${s.subject}</td>
                    <td><span class="text-xs bg-gray-100 px-2 py-1 rounded">${s.assessments}</span></td>
                    <td><div class="max-w-xs overflow-x-auto text-xs">${marksList}</div></td>
                    <td class="font-bold ${s.grade.color}">${s.avgMark.toFixed(1)}</td>
                    <td><span class="grade-badge ${s.grade.class}">${s.grade.grade}</span></td>
                    <td class="text-center font-bold">${s.grade.points}</td>
                    <td><span class="status-badge ${s.grade.pass ? 'status-pass' : 'status-fail'}">${s.grade.status}</span></td>
                </tr>
            `;
        });
        
        tableHtml += '</tbody></table>';
        
        // Add summary statistics
        const passCount = subjects.filter(s => s.grade.pass).length;
        const failCount = subjects.filter(s => !s.grade.pass).length;
        
        tableHtml += `
            <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-600">Total Subjects</div>
                    <div class="text-xl font-bold">${subjects.length}</div>
                </div>
                <div class="bg-green-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-600">Passed</div>
                    <div class="text-xl font-bold text-green-600">${passCount}</div>
                </div>
                <div class="bg-red-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-600">Failed</div>
                    <div class="text-xl font-bold text-red-600">${failCount}</div>
                </div>
                <div class="bg-purple-50 p-3 rounded-lg">
                    <div class="text-xs text-gray-600">Total Marks</div>
                    <div class="text-xl font-bold">${subjects.reduce((sum, s) => sum + s.marks.length, 0)}</div>
                </div>
            </div>
        `;
        
        // Add data sources
        const uniqueFiles = [...new Set(results.map(r => r.filename))];
        const uniqueSheets = [...new Set(results.map(r => `${r.filename} (${r.sheetName})`))];
        
        tableHtml += `
            <div class="mt-4 p-3 bg-gray-100 rounded-lg text-xs">
                <details open>
                    <summary class="font-semibold cursor-pointer mb-2">üìä Data Sources (${uniqueSheets.length} sheets)</summary>
                    <div class="max-h-40 overflow-y-auto">
                        <ul class="list-disc list-inside space-y-1">
                            ${uniqueSheets.map(s => `<li class="text-gray-700">${s}</li>`).join('')}
                        </ul>
                    </div>
                </details>
            </div>
        `;
        
        document.getElementById('studentResultsTable').innerHTML = tableHtml;
        document.getElementById('studentResultsContainer').classList.remove('hidden');
        
        hideLoading();
        showToast(`Found ${subjects.length} subjects for ${studentName}`, 'success');
        
    } catch (error) {
        console.error('Search error:', error);
        hideLoading();
        showToast('Error searching: ' + error.message, 'error');
    }
}
        // ========== TRANSCRIPT FUNCTIONS ==========
        function downloadOfficialTranscriptPDF() {
            if (!currentTranscriptData) {
                showToast('No student data available', 'error');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // College Header
                doc.setFontSize(16);
                doc.setTextColor(0, 51, 102);
                doc.text(COLLEGE_NAME, 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(COLLEGE_MOTTO, 105, 27, { align: 'center' });
                
                doc.setFontSize(8);
                doc.text(COLLEGE_ADDRESS, 105, 33, { align: 'center' });
                
                // Line
                doc.setDrawColor(200);
                doc.line(20, 38, 190, 38);
                
                // Title
                doc.setFontSize(14);
                doc.setTextColor(0, 51, 102);
                doc.text('OFFICIAL ACADEMIC TRANSCRIPT', 105, 48, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(255, 0, 0);
                doc.text('PROVISIONAL RESULTS - NOT FOR OFFICIAL USE', 105, 55, { align: 'center' });
                
                // Student Info
                doc.setTextColor(0);
                doc.setFontSize(10);
                doc.text(`Student Name: ${currentTranscriptData.studentName}`, 20, 65);
                doc.text(`Admission No: ${currentTranscriptData.studentId}`, 20, 72);
                doc.text(`Program: ${PROGRAM_NAME} - Kenya Registered Community Health Nurse`, 20, 79);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 86);
                
                // Results Table
                const tableData = currentTranscriptData.subjects.map(s => [
                    s.subject,
                    s.marks.length.toString(),
                    s.avgMark.toFixed(1),
                    s.grade.grade,
                    s.grade.points.toString(),
                    s.grade.status
                ]);
                
                doc.autoTable({
                    startY: 95,
                    head: [['Subject', 'Exams', 'Average', 'Grade', 'Points', 'Status']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [0, 51, 102] },
                    columnStyles: {
                        0: { cellWidth: 60 },
                        1: { cellWidth: 20, halign: 'center' },
                        2: { cellWidth: 25, halign: 'center' },
                        3: { cellWidth: 20, halign: 'center' },
                        4: { cellWidth: 20, halign: 'center' },
                        5: { cellWidth: 30, halign: 'center' }
                    }
                });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Summary
                doc.setFontSize(10);
                doc.text(`Total Subjects: ${currentTranscriptData.subjects.length}`, 20, finalY);
                doc.text(`Overall Average: ${currentTranscriptData.avgOverall.toFixed(1)}%`, 20, finalY + 7);
                doc.text(`Total Points: ${currentTranscriptData.totalPoints}`, 20, finalY + 14);
                doc.text(`GPA: ${currentTranscriptData.gpa}`, 20, finalY + 21);
                
                doc.setFontSize(12);
                doc.setTextColor(currentTranscriptData.overallGrade.grade === 'A' ? [0,102,0] : 
                               currentTranscriptData.overallGrade.grade === 'B' ? [0,102,204] :
                               currentTranscriptData.overallGrade.grade === 'C' ? [204,102,0] : [204,0,0]);
                doc.text(`Overall Grade: ${currentTranscriptData.overallGrade.grade} - ${currentTranscriptData.overallGrade.status}`, 120, finalY + 14);
                
                // Grading Key
                doc.setTextColor(100);
                doc.setFontSize(8);
                doc.text('Grading Key: A=85-100 (Distinction, 4pts), B=75-84 (Credit, 3pts), C=60-74 (Pass, 2pts), D=0-59 (Fail, 0pts)', 20, finalY + 35);
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(COLLEGE_FOOTER, 105, 280, { align: 'center' });
                
                doc.save(`${currentTranscriptData.studentName.replace(/\s+/g, '_')}_Transcript.pdf`);
                showToast('PDF downloaded successfully', 'success');
                
            } catch (error) {
                console.error('PDF error:', error);
                showToast('Error generating PDF: ' + error.message, 'error');
            }
        }

        function downloadTranscriptExcel() {
            if (!currentTranscriptData) {
                showToast('No student data available', 'error');
                return;
            }
            
            try {
                const wb = XLSX.utils.book_new();
                
                // Summary Sheet
                const summaryData = [
                    ['NAKURU COLLEGE OF HEALTH SCIENCES - ACADEMIC TRANSCRIPT'],
                    ['PROVISIONAL RESULTS'],
                    [],
                    ['Student Name:', currentTranscriptData.studentName],
                    ['Admission No:', currentTranscriptData.studentId],
                    ['Program:', PROGRAM_NAME],
                    ['Date:', new Date().toLocaleDateString()],
                    [],
                    ['Subject', 'Number of Exams', 'Average Mark', 'Grade', 'Points', 'Status']
                ];
                
                currentTranscriptData.subjects.forEach(s => {
                    summaryData.push([
                        s.subject,
                        s.marks.length,
                        s.avgMark.toFixed(1),
                        s.grade.grade,
                        s.grade.points,
                        s.grade.status
                    ]);
                });
                
                summaryData.push(
                    [],
                    ['SUMMARY'],
                    [`Total Subjects:`, currentTranscriptData.subjects.length],
                    [`Overall Average:`, currentTranscriptData.avgOverall.toFixed(1) + '%'],
                    [`Total Points:`, currentTranscriptData.totalPoints],
                    [`GPA:`, currentTranscriptData.gpa],
                    [`Overall Grade:`, `${currentTranscriptData.overallGrade.grade} - ${currentTranscriptData.overallGrade.status}`]
                );
                
                const ws = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, ws, 'Transcript');
                
                // Detailed Marks Sheet
                const detailsData = [['Subject', 'Mark', 'Grade', 'Points', 'Status', 'File', 'Sheet']];
                
                currentTranscriptData.subjects.forEach(s => {
                    const records = allStudentMarks.filter(r => 
                        r.studentId === currentTranscriptData.studentId || 
                        r.studentName === currentTranscriptData.studentName
                    );
                    
                    records.forEach(r => {
                        r.marks.forEach(m => {
                            if (m.subject === s.subject) {
                                detailsData.push([
                                    m.subject,
                                    m.mark,
                                    m.grade.grade,
                                    m.grade.points,
                                    m.grade.status,
                                    r.filename,
                                    r.sheetName
                                ]);
                            }
                        });
                    });
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(detailsData);
                XLSX.utils.book_append_sheet(wb, ws2, 'Detailed Marks');
                
                XLSX.writeFile(wb, `${currentTranscriptData.studentName.replace(/\s+/g, '_')}_Transcript.xlsx`);
                showToast('Excel downloaded successfully', 'success');
                
            } catch (error) {
                console.error('Excel error:', error);
                showToast('Error generating Excel: ' + error.message, 'error');
            }
        }

        function printOfficialTranscript() {
            if (!currentTranscriptData) {
                showToast('No student data available', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Academic Transcript - ${currentTranscriptData.studentName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .college-name { font-size: 20px; font-weight: bold; color: #003366; }
                        .motto { font-size: 12px; color: #666; margin: 5px 0; }
                        .address { font-size: 10px; color: #999; }
                        .title { font-size: 16px; font-weight: bold; color: #003366; margin: 20px 0; text-align: center; }
                        .provisional { color: red; font-weight: bold; text-align: center; margin: 10px 0; }
                        .student-info { margin: 20px 0; font-size: 12px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th { background: #003366; color: white; padding: 8px; font-size: 11px; }
                        td { padding: 6px; border: 1px solid #ddd; font-size: 11px; }
                        .grade-a { background: #ede9fe; color: #5b21b6; font-weight: bold; }
                        .grade-b { background: #d1fae5; color: #065f46; font-weight: bold; }
                        .grade-c { background: #fed7aa; color: #92400e; font-weight: bold; }
                        .grade-d { background: #fee2e2; color: #991b1b; font-weight: bold; }
                        .summary { margin: 20px 0; font-size: 12px; }
                        .footer { margin-top: 40px; font-size: 9px; color: #999; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="college-name">${COLLEGE_NAME}</div>
                        <div class="motto">${COLLEGE_MOTTO}</div>
                        <div class="address">${COLLEGE_ADDRESS}</div>
                    </div>
                    
                    <div class="title">OFFICIAL ACADEMIC TRANSCRIPT</div>
                    <div class="provisional">PROVISIONAL RESULTS - NOT FOR OFFICIAL USE</div>
                    
                    <div class="student-info">
                        <p><strong>Student Name:</strong> ${currentTranscriptData.studentName}</p>
                        <p><strong>Admission No:</strong> ${currentTranscriptData.studentId}</p>
                        <p><strong>Program:</strong> ${PROGRAM_NAME} - Kenya Registered Community Health Nurse</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Exams</th>
                                <th>Average</th>
                                <th>Grade</th>
                                <th>Points</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentTranscriptData.subjects.map(s => `
                                <tr>
                                    <td>${s.subject}</td>
                                    <td>${s.marks.length}</td>
                                    <td>${s.avgMark.toFixed(1)}</td>
                                    <td class="grade-${s.grade.grade.toLowerCase()}">${s.grade.grade}</td>
                                    <td>${s.grade.points}</td>
                                    <td>${s.grade.status}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <p><strong>Total Subjects:</strong> ${currentTranscriptData.subjects.length}</p>
                        <p><strong>Overall Average:</strong> ${currentTranscriptData.avgOverall.toFixed(1)}%</p>
                        <p><strong>Total Points:</strong> ${currentTranscriptData.totalPoints}</p>
                        <p><strong>GPA:</strong> ${currentTranscriptData.gpa}</p>
                        <p><strong>Overall Grade:</strong> ${currentTranscriptData.overallGrade.grade} - ${currentTranscriptData.overallGrade.status}</p>
                    </div>
                    
                    <div style="font-size: 9px; color: #666; margin-top: 20px;">
                        Grading Key: A=85-100 (Distinction, 4pts), B=75-84 (Credit, 3pts), C=60-74 (Pass, 2pts), D=0-59 (Fail, 0pts)
                    </div>
                    
                    <div class="footer">
                        ${COLLEGE_FOOTER}
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing session
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    // Auto-login if session exists
                    handleLogin();
                }
            });
        });
    </script>
</body>
</html>
