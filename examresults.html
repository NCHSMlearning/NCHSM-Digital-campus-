<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCHSN - EXAM RESULTS PROVISIONAL PORTAL</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="examstyle.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <!-- Handsontable for Excel Editing -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.2.0/dist/handsontable.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.2.0/dist/handsontable.full.min.css">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        
        <!-- ========== SUPABASE CONFIG ========== -->
        <script>
            // üî¥ YOUR SUPABASE CREDENTIALS
            const SUPABASE_URL = 'https://lwhtjozfsmbyihenfunw.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3aHRqb3pmc21ieWloZW5mdW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTgxMjcsImV4cCI6MjA3NTIzNDEyN30.7Z8AYvPQwTAEEEhODlW6Xk-IR1FK3Uj5ivZS7P17Wpk';
            
            // Initialize Supabase
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            console.log('‚úÖ Supabase initialized!');
            
            // Global state
            let currentUser = null;
            let currentRole = null;
            let sharedFiles = [];
            let allStudentMarks = [];
            let currentEditingFile = null;
            let currentViewingFile = null;
            let hot = null;
        </script>

        <!-- ========== LOGIN SCREEN ========== -->
        <div id="loginScreen" class="flex items-center justify-center min-h-screen">
            <div class="portal-card w-full max-w-md p-8">
                <div class="text-center mb-8">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 w-24 h-24 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-graduation-cap text-white text-4xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800">NCHSN</h1>
                    <p class="text-gray-600 mt-2">EXAM RESULTS PROVISIONAL PORTAL</p>
                    <div class="mt-3">
                        <span class="provisional-badge text-sm">
                            <i class="fas fa-clock mr-2"></i>
                            PROVISIONAL RESULTS
                        </span>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <i class="fas fa-envelope mr-2 text-gray-500"></i>
                            Email Address
                        </label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            <i class="fas fa-lock mr-2 text-gray-500"></i>
                            Password
                        </label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-0">
                    </div>
                    
                    <button onclick="handleLogin()" 
                            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-xl hover:opacity-90 transition font-bold text-lg shadow-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        LOGIN TO PORTAL
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== MAIN PORTAL ========== -->
        <div id="mainPortal" class="hidden space-y-6">
            <!-- Header -->
            <div class="portal-card p-6">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 rounded-2xl shadow-lg mr-4">
                            <i class="fas fa-graduation-cap text-white text-3xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                                NCHSN EXAM RESULTS PORTAL
                            </h1>
                            <div class="flex items-center mt-2">
                                <span id="userRoleBadge" class="role-super-admin mr-3"></span>
                                <span id="userDisplayName" class="text-gray-600 font-medium"></span>
                                <span class="mx-2 text-gray-400">‚Ä¢</span>
                                <span id="userEmailDisplay" class="text-gray-500 text-sm"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="bg-orange-100 px-4 py-2 rounded-full flex items-center">
                            <i class="fas fa-clock text-orange-600 mr-2"></i>
                            <span class="text-orange-800 text-sm font-semibold">PROVISIONAL</span>
                        </div>
                        <button onclick="logout()" 
                                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="portal-card p-6">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-file-excel text-blue-800 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Total Excel Files</p>
                            <p id="totalFilesStats" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="portal-card p-6">
                    <div class="flex items-center">
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-users text-green-800 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Student Records</p>
                            <p id="totalRecordsStats" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="portal-card p-6">
                    <div class="flex items-center">
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-chalkboard-teacher text-purple-800 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Active Staff</p>
                            <p id="totalStaffStats" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="portal-card p-6">
                    <div class="flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <i class="fas fa-shield-alt text-yellow-800 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-gray-500 text-sm">Your Role</p>
                            <p id="userRoleDisplay" class="text-2xl font-bold text-gray-800">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== ADMIN STUDENT SEARCH SECTION ========== -->
            <div id="adminSearchSection" class="portal-card p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-search text-blue-600 mr-2"></i>
                    ADMIN - Search Student Marks Across All Excel Files
                </h2>
                
                <div class="flex gap-4 mb-6">
                    <input type="text" id="studentSearchInput" placeholder="Enter Student ID or Name..." 
                           class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500">
                    <button onclick="searchStudentMarks()" 
                            class="bg-blue-600 text-white px-8 py-3 rounded-xl hover:bg-blue-700 flex items-center">
                        <i class="fas fa-search mr-2"></i>
                        Search
                    </button>
                    <button onclick="clearSearch()" 
                            class="bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600">
                        <i class="fas fa-times"></i>
                        Clear
                    </button>
                </div>
                
                <!-- Student Results Container -->
                <div id="studentResultsContainer" class="hidden">
                    <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-user-graduate text-green-600 mr-2"></i>
                        <span id="searchResultCount">0</span> Results Found
                    </h3>
                    <div id="studentResultsTable" class="overflow-x-auto bg-white rounded-xl border">
                        <!-- Results table will be populated here -->
                    </div>
                </div>
            </div>

            <!-- ========== ADMIN DASHBOARD ========== -->
            <div id="adminDashboard" class="space-y-6">
                <!-- Excel Upload Section -->
                <div class="portal-card p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-upload text-green-600 mr-2"></i>
                        ADMIN - Upload New Excel File
                    </h2>
                    
                    <div onclick="document.getElementById('excelUpload').click()"
                         class="border-4 border-dashed border-blue-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-500 bg-blue-50">
                        <i class="fas fa-cloud-upload-alt text-5xl text-blue-500 mb-3"></i>
                        <h3 class="text-xl font-bold text-gray-700">Click to Upload Excel File</h3>
                        <p class="text-gray-500 mt-2">.xlsx, .xls, .csv files</p>
                        <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelUpload(this)">
                    </div>
                </div>

                <!-- File Preview Section -->
                <div id="filePreviewSection" class="hidden portal-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">File Preview</h3>
                        <button onclick="closeFilePreview()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="filePreview" class="overflow-x-auto"></div>
                    <div class="flex justify-end gap-3 mt-4">
                        <button onclick="publishFile()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>
                            Publish to Database
                        </button>
                    </div>
                </div>

                <!-- Live Excel Editor -->
                <div id="excelEditorSection" class="hidden portal-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-edit text-purple-600 mr-2"></i>
                            LIVE EXCEL EDITOR - <span id="editingFileName" class="text-blue-600"></span>
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="saveExcelChanges()" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                <i class="fas fa-save mr-2"></i>
                                Save Changes
                            </button>
                            <button onclick="closeEditor()" 
                                    class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                                <i class="fas fa-times"></i>
                                Close
                            </button>
                        </div>
                    </div>
                    <div id="excelEditor" class="excel-editor" style="height: 500px;"></div>
                </div>

                <!-- Excel Viewer -->
                <div id="excelViewerSection" class="hidden portal-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-eye text-green-600 mr-2"></i>
                            VIEWING: <span id="viewingFileName" class="text-blue-600 ml-2"></span>
                        </h2>
                        <button onclick="closeViewer()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                            <i class="fas fa-times mr-2"></i>
                            Close
                        </button>
                    </div>
                    <div id="excelViewer" class="overflow-x-auto bg-white rounded-lg border p-4"></div>
                </div>
            </div>

            <!-- Shared Excel Files -->
            <div class="portal-card p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-folder-open text-purple-600 mr-2"></i>
                        üìÅ SHARED PROVISIONAL RESULTS
                    </h2>
                    <span class="bg-purple-100 text-purple-800 px-4 py-2 rounded-full text-sm">
                        <i class="fas fa-globe mr-1"></i>
                        ALL FILES
                    </span>
                </div>
                
                <div id="sharedFilesContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Files load here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== LOGIN FUNCTION ==========
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                const { data: profile, error: profileError } = await supabase
                    .from('consolidated_user_profiles_table')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (profileError) throw profileError;
                
                currentUser = profile;
                currentRole = profile.role;
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainPortal').classList.remove('hidden');
                
                document.getElementById('userDisplayName').innerHTML = `<i class="fas fa-user mr-2"></i>${profile.full_name || profile.email}`;
                document.getElementById('userEmailDisplay').innerText = profile.email;
                document.getElementById('userRoleDisplay').innerText = profile.role.replace('_', ' ').toUpperCase();
                
                const badge = document.getElementById('userRoleBadge');
                badge.innerText = profile.role.replace('_', ' ').toUpperCase();
                badge.className = `role-${profile.role} px-4 py-1.5 rounded-full text-sm font-bold`;
                
                // Show/hide admin sections based on role
                if (profile.role === 'admin' || profile.role === 'super_admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminSearchSection').classList.remove('hidden');
                } else {
                    document.getElementById('adminDashboard').classList.add('hidden');
                    document.getElementById('adminSearchSection').classList.add('hidden');
                }
                
                await loadSharedFiles();
                await loadAllStudentMarks();
                
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        // ========== LOAD ALL STUDENT MARKS FROM ALL EXCEL FILES ==========
        async function loadAllStudentMarks() {
            try {
                const { data: files, error } = await supabase
                    .from('shared_excel_files')
                    .select('*')
                    .order('uploaded_at', { ascending: false });
                
                if (error) throw error;
                
                sharedFiles = files || [];
                allStudentMarks = [];
                
                for (const file of sharedFiles) {
                    if (file.file_data) {
                        try {
                            const binaryData = atob(file.file_data);
                            const array = new Uint8Array(binaryData.length);
                            for (let i = 0; i < binaryData.length; i++) {
                                array[i] = binaryData.charCodeAt(i);
                            }
                            
                            const workbook = XLSX.read(array, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            
                            jsonData.forEach((row, index) => {
                                // Try different possible column names
                                const studentId = row['Student ID'] || row['studentId'] || row['STUDENT_ID'] || row['StudentID'] || row['ID'] || '';
                                const studentName = row['Student Name'] || row['studentName'] || row['STUDENT_NAME'] || row['Name'] || row['name'] || '';
                                const marks = row['Marks'] || row['marks'] || row['MARKS'] || row['Score'] || row['score'] || '';
                                const subject = row['Subject'] || row['subject'] || row['SUBJECT'] || 'General';
                                
                                if (studentId) {
                                    allStudentMarks.push({
                                        id: `${file.id}_${index}`,
                                        fileId: file.id,
                                        filename: file.filename,
                                        studentId: studentId.toString().trim(),
                                        studentName: studentName.toString().trim(),
                                        marks: marks,
                                        subject: subject,
                                        uploadedBy: file.uploaded_by_email,
                                        uploadedAt: file.uploaded_at
                                    });
                                }
                            });
                        } catch (e) {
                            console.error('Error parsing file:', file.filename, e);
                        }
                    }
                }
                
                // Update stats
                document.getElementById('totalFilesStats').innerText = sharedFiles.length;
                document.getElementById('totalRecordsStats').innerText = allStudentMarks.length;
                
                console.log(`‚úÖ Loaded ${allStudentMarks.length} student records from ${sharedFiles.length} files`);
                
            } catch (error) {
                console.error('Error loading student marks:', error);
            }
        }

        // ========== SEARCH STUDENT MARKS ==========
        function searchStudentMarks() {
            const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                alert('Please enter a Student ID or Name to search');
                return;
            }
            
            const results = allStudentMarks.filter(mark => 
                mark.studentId.toLowerCase().includes(searchTerm) || 
                mark.studentName.toLowerCase().includes(searchTerm)
            );
            
            displayStudentResults(results);
        }

        // ========== DISPLAY STUDENT RESULTS ==========
        function displayStudentResults(results) {
            const container = document.getElementById('studentResultsContainer');
            const tableContainer = document.getElementById('studentResultsTable');
            const countSpan = document.getElementById('searchResultCount');
            
            if (results.length === 0) {
                container.classList.remove('hidden');
                countSpan.innerText = '0';
                tableContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No results found</div>';
                return;
            }
            
            container.classList.remove('hidden');
            countSpan.innerText = results.length;
            
            // Calculate summary statistics
            const totalMarks = results.reduce((sum, r) => sum + (parseFloat(r.marks) || 0), 0);
            const averageMarks = (totalMarks / results.length).toFixed(2);
            const passedCount = results.filter(r => parseFloat(r.marks) >= 50).length;
            const failedCount = results.length - passedCount;
            
            let html = `
                <div class="mb-4 grid grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-600">Total Exams</p>
                        <p class="text-2xl font-bold text-blue-800">${results.length}</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-600">Average Marks</p>
                        <p class="text-2xl font-bold text-green-800">${averageMarks}</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-600">Pass/Fail</p>
                        <p class="text-2xl font-bold text-purple-800">${passedCount}/${failedCount}</p>
                    </div>
                </div>
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                            <th class="p-3 text-left">Student ID</th>
                            <th class="p-3 text-left">Student Name</th>
                            <th class="p-3 text-left">Subject</th>
                            <th class="p-3 text-left">Marks</th>
                            <th class="p-3 text-left">Status</th>
                            <th class="p-3 text-left">File Name</th>
                            <th class="p-3 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(result => {
                const marks = parseFloat(result.marks) || 0;
                const status = marks >= 50 ? 'PASS' : 'FAIL';
                const statusClass = marks >= 50 ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';
                
                html += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium">${result.studentId}</td>
                        <td class="p-3">${result.studentName || '-'}</td>
                        <td class="p-3">${result.subject}</td>
                        <td class="p-3 font-bold">${marks}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${statusClass}">${status}</span></td>
                        <td class="p-3 text-sm">${result.filename}</td>
                        <td class="p-3">
                            <button onclick="openFileForEditing('${result.fileId}')" class="text-blue-600 hover:text-blue-800 mr-2">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="viewFile('${result.fileId}')" class="text-green-600 hover:text-green-800">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        // ========== OPEN FILE FOR EDITING ==========
        async function openFileForEditing(fileId) {
            if (currentRole !== 'admin' && currentRole !== 'super_admin') {
                alert('Only Admins can edit files');
                return;
            }
            
            // Close viewer if open
            closeViewer();
            
            const file = sharedFiles.find(f => f.id === fileId);
            if (!file || !file.file_data) {
                alert('File data not found');
                return;
            }
            
            try {
                const binaryData = atob(file.file_data);
                const array = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    array[i] = binaryData.charCodeAt(i);
                }
                
                const workbook = XLSX.read(array, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                currentEditingFile = {
                    id: file.id,
                    workbook: workbook,
                    data: jsonData,
                    filename: file.filename
                };
                
                document.getElementById('editingFileName').innerText = file.filename;
                document.getElementById('excelEditorSection').classList.remove('hidden');
                
                // Initialize Handsontable editor
                const container = document.getElementById('excelEditor');
                if (hot) hot.destroy();
                
                hot = new Handsontable(container, {
                    data: jsonData,
                    rowHeaders: true,
                    colHeaders: true,
                    height: '100%',
                    width: '100%',
                    licenseKey: 'non-commercial-and-evaluation',
                    contextMenu: true,
                    copyPaste: true,
                    fillHandle: true,
                    undo: true,
                    redo: true,
                    columnSorting: true,
                    filters: true,
                    dropdownMenu: true,
                    
                    // Mark validation for marks column
                    cells: function(row, col, prop) {
                        const cellProperties = {};
                        const header = jsonData[0] ? jsonData[0][col] : '';
                        
                        if (header && header.toString().toLowerCase().includes('marks')) {
                            cellProperties.type = 'numeric';
                            cellProperties.validator = function(value, callback) {
                                if (value === null || value === '') {
                                    callback(true);
                                    return;
                                }
                                const num = parseFloat(value);
                                if (isNaN(num) || num < 0 || num > 100) {
                                    callback(false);
                                } else {
                                    callback(true);
                                }
                            };
                            
                            // Color coding based on marks
                            cellProperties.renderer = function(instance, td, row, col, prop, value, cellProperties) {
                                Handsontable.renderers.NumericRenderer.apply(this, arguments);
                                if (row > 0 && value) {
                                    const marks = parseFloat(value);
                                    if (marks >= 75) td.style.background = '#dcfce7';
                                    else if (marks >= 50) td.style.background = '#fef9c3';
                                    else td.style.background = '#fee2e2';
                                }
                                return td;
                            };
                        }
                        
                        return cellProperties;
                    }
                });
                
            } catch (error) {
                console.error('Error opening file:', error);
                alert('Error opening file: ' + error.message);
            }
        }

        // ========== SAVE EXCEL CHANGES ==========
        async function saveExcelChanges() {
            if (!hot || !currentEditingFile) {
                alert('No file being edited');
                return;
            }
            
            try {
                const updatedData = hot.getData();
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(updatedData);
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
                
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'base64' });
                
                const { error } = await supabase
                    .from('shared_excel_files')
                    .update({
                        file_data: excelBuffer,
                        row_count: updatedData.length - 1,
                        last_edited_at: new Date().toISOString(),
                        last_edited_by: currentUser.email
                    })
                    .eq('id', currentEditingFile.id);
                
                if (error) throw error;
                
                alert('‚úÖ Changes saved successfully!');
                
                // Close editor
                closeEditor();
                
                // Reload data
                await loadSharedFiles();
                await loadAllStudentMarks();
                
                // Refresh search if active
                const searchTerm = document.getElementById('studentSearchInput').value;
                if (searchTerm) searchStudentMarks();
                
            } catch (error) {
                console.error('Error saving:', error);
                alert('Error saving changes: ' + error.message);
            }
        }

        // ========== VIEW FILE (IN SAME PAGE) ==========
        async function viewFile(fileId) {
            // Close editor if open
            closeEditor();
            
            const file = sharedFiles.find(f => f.id === fileId);
            if (!file || !file.file_data) {
                alert('File data not found');
                return;
            }
            
            try {
                const binaryData = atob(file.file_data);
                const array = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    array[i] = binaryData.charCodeAt(i);
                }
                
                const workbook = XLSX.read(array, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const htmlString = XLSX.utils.sheet_to_html(worksheet);
                
                document.getElementById('viewingFileName').innerText = file.filename;
                document.getElementById('excelViewer').innerHTML = htmlString;
                document.getElementById('excelViewerSection').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error viewing file:', error);
                alert('Error viewing file: ' + error.message);
            }
        }

        // ========== LOAD SHARED FILES ==========
        async function loadSharedFiles() {
            try {
                const { data: files, error } = await supabase
                    .from('shared_excel_files')
                    .select('*')
                    .order('uploaded_at', { ascending: false });
                
                if (error) throw error;
                
                sharedFiles = files || [];
                
                const container = document.getElementById('sharedFilesContainer');
                
                if (sharedFiles.length === 0) {
                    container.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-500">No files uploaded</div>';
                    return;
                }
                
                let html = '';
                sharedFiles.forEach(file => {
                    const date = new Date(file.uploaded_at).toLocaleString();
                    const canEdit = (currentRole === 'admin' || currentRole === 'super_admin');
                    
                    html += `
                        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-lg transition bg-white">
                            <div class="flex items-start">
                                <i class="fas fa-file-excel text-green-600 text-3xl mr-3"></i>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">${file.filename}</p>
                                    <div class="flex items-center mt-2 text-xs">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                            ${file.row_count || 0} records
                                        </span>
                                        <span class="text-gray-500 ml-2">
                                            <i class="fas fa-user mr-1"></i>${file.uploaded_by_email || 'Unknown'}
                                        </span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">${date}</p>
                                    <div class="mt-3 flex gap-2">
                                        ${canEdit ? 
                                            `<button onclick="openFileForEditing('${file.id}')" 
                                                class="text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </button>` : ''
                                        }
                                        <button onclick="viewFile('${file.id}')" 
                                            class="text-sm bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700">
                                            <i class="fas fa-eye mr-1"></i>View
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ========== EXCEL UPLOAD HANDLER ==========
        function handleExcelUpload(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Show preview
                    let previewHtml = '<table class="w-full border-collapse">';
                    previewHtml += '<thead><tr class="bg-blue-600 text-white">';
                    if (jsonData[0]) {
                        jsonData[0].forEach(header => {
                            previewHtml += `<th class="p-2 border">${header || 'Column'}</th>`;
                        });
                    }
                    previewHtml += '</tr></thead><tbody>';
                    
                    for (let i = 1; i < Math.min(6, jsonData.length); i++) {
                        previewHtml += '<tr>';
                        if (jsonData[i]) {
                            jsonData[i].forEach(cell => {
                                previewHtml += `<td class="p-2 border">${cell || '-'}</td>`;
                            });
                        }
                        previewHtml += '</tr>';
                    }
                    
                    previewHtml += '</tbody></table>';
                    document.getElementById('filePreview').innerHTML = previewHtml;
                    document.getElementById('filePreviewSection').classList.remove('hidden');
                    
                    window.currentUploadData = {
                        workbook: workbook,
                        fileName: file.name,
                        rowCount: jsonData.length - 1
                    };
                    
                } catch (error) {
                    alert('Error reading Excel: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ========== PUBLISH FILE TO SUPABASE ==========
        async function publishFile() {
            if (!window.currentUploadData) {
                alert('No file to publish');
                return;
            }
            
            try {
                const { workbook, fileName, rowCount } = window.currentUploadData;
                
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'base64' });
                
                const { error } = await supabase
                    .from('shared_excel_files')
                    .insert([
                        {
                            filename: `PROVISIONAL_${Date.now()}_${fileName}`,
                            file_data: excelBuffer,
                            row_count: rowCount,
                            uploaded_by: currentUser.id,
                            uploaded_by_email: currentUser.email,
                            uploaded_at: new Date().toISOString()
                        }
                    ]);
                
                if (error) throw error;
                
                alert('‚úÖ File published successfully!');
                
                closeFilePreview();
                
                await loadSharedFiles();
                await loadAllStudentMarks();
                
            } catch (error) {
                console.error('Error publishing:', error);
                alert('Error: ' + error.message);
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function clearSearch() {
            document.getElementById('studentSearchInput').value = '';
            document.getElementById('studentResultsContainer').classList.add('hidden');
        }
        
        function closeEditor() {
            document.getElementById('excelEditorSection').classList.add('hidden');
            if (hot) {
                hot.destroy();
                hot = null;
            }
            currentEditingFile = null;
        }
        
        function closeViewer() {
            document.getElementById('excelViewerSection').classList.add('hidden');
            document.getElementById('excelViewer').innerHTML = '';
        }
        
        function closeFilePreview() {
            document.getElementById('filePreviewSection').classList.add('hidden');
            document.getElementById('excelUpload').value = '';
            window.currentUploadData = null;
        }
        
        function logout() {
            currentUser = null;
            currentRole = null;
            document.getElementById('mainPortal').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            closeEditor();
            closeViewer();
            closeFilePreview();
        }
        
        window.onload = function() {
            console.log('‚úÖ NCHSN PORTAL LOADED - ALL BUTTONS WORKING!');
        };
    </script>
</body>
</html>
